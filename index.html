<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GOBLINS FAZ • Brand Studio</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- CONTEXT MENU -->
<div id="ctxMenu" class="ctx-menu">
  <div class="ctx-item" data-action="rename"><i data-lucide="pencil-line"></i> Renomear</div>
  <div class="ctx-item" data-action="duplicate"><i data-lucide="copy"></i> Duplicar</div>
  <div class="ctx-divider"></div>
  <div class="ctx-item danger" data-action="delete"><i data-lucide="trash-2"></i> Excluir</div>
</div>

<!-- TOAST ROOT -->
<div id="toastRoot" class="toast-root"></div>

<!-- COLOR MODAL -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal" id="modal">
    <div class="modal-head">
      <div class="modal-head-title">Editar Cor</div>
      <button class="btn-icon" id="btnCloseModal">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-grid">
      <div class="modal-left">
        <div id="pickerCanvas" class="picker-canvas">
          <div id="pickerKnob" class="picker-knob"></div>
        </div>
        <div id="hueStrip" class="hue-strip">
          <div id="hueKnob" class="hue-knob"></div>
        </div>
        <div id="alphaStrip" class="alpha-strip">
          <div id="alphaFill" class="alpha-strip-fill"></div>
          <div id="alphaKnob" class="alpha-knob"></div>
        </div>
        <div id="colorPreviewSwatch" class="color-preview-swatch">
          <span id="colorPreviewLabel" style="font-family:'JetBrains Mono', ui-monospace, monospace;font-size:11px;color:rgba(255,255,255,.7)"></span>
        </div>
        <div class="history-dots" id="historyDots"></div>
      </div>
      <div class="modal-right">
        <div class="modal-field">
          <label>HEX</label>
          <input id="mHex" class="modal-inp" placeholder="#RRGGBB">
        </div>
        <div class="modal-field">
          <label>RGB</label>
          <input id="mRgb" class="modal-inp" placeholder="255, 0, 128">
        </div>
        <div class="modal-field">
          <label>Opac.</label>
          <input id="mAlpha" class="modal-inp" type="number" min="0" max="100">
        </div>
        <div class="modal-field">
          <label>Transparência</label>
          <input id="mAlphaRange" class="modal-inp" type="range" min="0" max="100" value="100">
        </div>
        <div class="modal-field">
          <label>% Uso</label>
          <input id="mPct" class="modal-inp" type="number" min="1" max="100">
        </div>
        <div class="modal-field">
          <label>Nome</label>
          <input id="mName" class="modal-inp" placeholder="Ex.: Azul Primário">
        </div>
        <div class="divider"></div>
        <div class="modal-field">
          <label>Copiar</label>
          <select id="mCopyMode" class="modal-sel">
            <option value="hex">HEX</option>
            <option value="rgb">RGB</option>
            <option value="rgba">RGBA</option>
            <option value="hsl">HSL</option>
            <option value="css">CSS var()</option>
          </select>
        </div>
        <div class="modal-foot">
          <button class="btn btn-ghost" id="btnCopyColor">Copiar</button>
          <button class="btn btn-danger" id="btnDeleteColor">Excluir</button>
          <button class="btn btn-primary" id="btnApplyColor">Aplicar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SHELL -->
<div class="shell">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="dot">G</div>
      <div class="brand">Goblins Faz</div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Principal</div>
      <div class="sidebar-item active" data-view="home" onclick="nav('home',this)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        Projetos
      </div>
    </div>

    <div class="sidebar-section" id="editorNav" style="display:none;">
      <div class="sidebar-label" id="editorNavLabel">Projeto</div>
      <div class="sidebar-item" data-view="editor" onclick="nav('editor',this)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        Editar
      </div>
      <div class="sidebar-item" data-view="board" onclick="nav('board',this)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="14" rx="2"/><line x1="7" y1="21" x2="17" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>
        </svg>
        Brand Board
      </div>
      <div class="sidebar-item" data-view="apps" onclick="nav('apps',this)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="16" rx="2"/><line x1="7" y1="8" x2="17" y2="8"/><line x1="7" y1="12" x2="17" y2="12"/><line x1="7" y1="16" x2="13" y2="16"/>
        </svg>
        Aplicações
      </div>
<div class="sidebar-item" data-view="export" onclick="nav('export',this)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/><path d="M9 18H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4"/></svg>
        Exportar
      </div>
    </div>

    <div class="sidebar-footer">
      <div class="version-tag">v2.0 • Brand Studio</div>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="topbar-left">
        <div class="topbar-breadcrumb" id="breadcrumb">
          <span>Projetos</span>
        </div>
      </div>
      <div class="topbar-right" id="topbarRight"></div>
    </div>

    <!-- HOME VIEW -->
    <div id="viewHome" class="view active">
      <div class="home-head">
        <div>
          <h1>Seus Projetos</h1>
          <p>Gerencie identidades visuais das suas marcas.</p>
        </div>
        <button class="btn btn-primary" onclick="createProject()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Novo Projeto
        </button>
      </div>
      <div id="projGrid" class="proj-grid"></div>
    </div>


    <!-- BRAND BOARD VIEW -->
    <div id="viewBoard" class="view">
      <div class="home-head" style="margin-bottom:18px">
        <div>
          <h1 id="bbTitle">Brand Board</h1>
          <p id="bbSubtitle">Visão geral da identidade — pronto para gerar materiais.</p>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-ghost" onclick="downloadBrandBoard()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Exportar Painel
          </button>
          <button class="btn btn-ghost" onclick="nav('editor')">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            Editar Identidade
          </button>
          <button class="btn btn-primary" onclick="createApplication()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Nova Aplicação Rápida
          </button>
        </div>
      </div>

      <div class="block bb-showcase-wrap">
        <div class="block-header">
          <div class="block-title">Visual Guide do Projeto</div>
          <span class="badge accent" id="bbUpdated">Atualizado —</span>
        </div>
        <div class="block-body">
          <div id="bbShowcase" class="bb-showcase"></div>
        </div>
      </div>
    </div>

    <!-- APLICAÇÕES VIEW -->
    <div id="viewApps" class="view">
      <div class="home-head" style="margin-bottom:18px">
        <div>
          <h1>Aplicações</h1>
          <p>Arquivos gerados a partir da identidade do projeto.</p>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-ghost" onclick="nav('board')">Voltar ao Brand Board</button>
          <button class="btn btn-primary" onclick="createApplication()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Nova Aplicação Rápida
          </button>
        </div>
      </div>

      <div class="block">
        <div class="block-header">
          <div class="block-title">Lista de aplicações geradas</div>
          <span style="font-size:11px;color:var(--ink3)" id="appsCount"></span>
        </div>
        <div class="block-body">
          <div id="appsList" class="export-grid" style="grid-template-columns:repeat(auto-fill,minmax(320px,1fr))"></div>
        </div>
      </div>
    </div>

    <!-- EDITOR VIEW -->
    <div id="viewEditor" class="view">
      <div class="editor-layout">

        <!-- LEFT -->
        <div class="col-left">

          <!-- Meta -->
          <div class="block">
            <div class="block-header">
              <div class="block-title">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                Identidade
              </div>
              <span class="badge" id="edProjectId">—</span>
            </div>
            <div class="block-body stack">
              <div class="field">
                <label class="field-label">Nome do Projeto</label>
                <input class="inp" id="inpName" placeholder="Ex.: Marca X, App Y...">
              </div>
              <div class="field">
                <label class="field-label">Descrição</label>
                <textarea class="tex inp" id="inpAbout" placeholder="Descrição curta da marca..."></textarea>
              </div>
            </div>
          </div>

          <!-- Logo -->
          <div class="block">
            <div class="block-header">
              <div class="block-title">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                Logo
              </div>
              <span style="font-size:11px;color:var(--ink3)">Fluxo centralizado</span>
            </div>
            <div class="block-body stack">
              <div class="brand-entry-card">
                <div class="field-label" style="margin-bottom:8px">Carregamento de logo e composição</div>
                <p class="brand-entry-copy">Toda importação de imagem da marca agora fica em um único fluxo para evitar retrabalho durante a edição da identidade.</p>
                <div class="brand-entry-inline" id="brandQuickStatus">Sem ativos importados.</div>
                <button class="btn btn-primary" type="button" onclick="openBrandImport()" style="margin-top:6px">
                  <i data-lucide="wand-sparkles" data-size="12"></i>
                  Carregar sua marca
                </button>
                <div class="brand-entry-thumb" id="brandQuickThumb"></div>
              </div>
              <div class="import-stats" style="font-size:11px;line-height:1.45">
                Dica: envie os arquivos no fluxo avançado para ajustar posicionamento, respiro e versões antes de voltar para edição.
              </div>
            </div>
          </div>

          <!-- Colors -->
          <div class="block">
            <div class="block-header">
              <div class="block-title">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="13.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="10.5" r="2.5"/><circle cx="8.5" cy="7.5" r="2.5"/><circle cx="6.5" cy="12.5" r="2.5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/></svg>
                Paleta
              </div>
              <button class="add-color-btn" onclick="addColor()">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Adicionar
              </button>
            </div>
            <div class="block-body">
              <div id="colorBar" class="color-bar-wrap"></div>
              <div id="colorChips" class="color-chips"></div>
            </div>
          </div>

        </div>

        <!-- MID -->
        <div class="col-mid">

          <!-- Fonts -->
          <div class="block">
            <div class="block-header">
              <div class="block-title">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
                Tipografia
              </div>
              <label style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--ink2);cursor:pointer">
                <input type="checkbox" id="chkRestrict" checked> Restrito
              </label>
            </div>
            <div class="block-body stack">
              <div class="row2">
                <div class="field">
                  <label class="field-label">Primária</label>
                  <select class="sel" id="selPrimary"></select>
                </div>
                <div class="field">
                  <label class="field-label">Secundária</label>
                  <select class="sel" id="selSecondary"></select>
                </div>
              </div>
            </div>
          </div>

          <!-- Type styles -->
          <div class="block">
            <div class="block-header">
              <div class="block-title">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="21" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="11" y2="18"/></svg>
                Hierarquia de Estilos
              </div>
              <span class="badge accent" id="activeStyleBadge" style="display:none"></span>
            </div>
            <div class="block-body">
              <div id="typoList"></div>
              <div id="typoEditor" class="typo-editor">
                <div class="stack" style="margin-top:0">
                  <div class="row3">
                    <div class="field">
                      <label class="field-label">Estilo base</label>
                      <select class="sel" id="edBaseStyle"></select>
                    </div>
                    <div class="field">
                      <label class="field-label">Família</label>
                      <select class="sel" id="edFamily"></select>
                    </div>
                    <div class="field">
                      <label class="field-label">Peso</label>
                      <select class="sel" id="edWeight"></select>
                    </div>
                  </div>
                  <div class="row3">
                    <div class="field">
                      <label class="field-label">Tamanho px</label>
                      <input class="inp" id="edSize" type="number" min="8" max="160">
                    </div>
                    <div class="field">
                      <label class="field-label">Line Height</label>
                      <input class="inp" id="edLine" type="number" step="0.05" min="0.8" max="2.5">
                    </div>
                    <div class="field">
                      <label class="field-label">Letter Sp.</label>
                      <input class="inp" id="edTrack" type="number" step="0.1" min="-5" max="20">
                    </div>
                  </div>
                  <div class="row2">
                    <div class="field">
                      <label class="field-label">Alinhamento</label>
                      <div class="seg-group">
                        <button class="seg-btn" id="bLeft" onclick="applyAlign('left')">≡</button>
                        <button class="seg-btn" id="bCenter" onclick="applyAlign('center')">≣</button>
                        <button class="seg-btn" id="bRight" onclick="applyAlign('right')">≡</button>
                      </div>
                    </div>
                    <div class="field">
                      <label class="field-label">Vertical</label>
                      <div class="seg-group">
                        <button class="seg-btn" id="bVTop" onclick="applyVAlign('top')">↑</button>
                        <button class="seg-btn" id="bVMid" onclick="applyVAlign('middle')">↕</button>
                        <button class="seg-btn" id="bVBot" onclick="applyVAlign('bottom')">↓</button>
                      </div>
                    </div>
                  </div>
                  <div class="chip-row">
                    <button class="chip-btn" id="btnUpper" onclick="toggleStyle('upper')">⇧ UPPERCASE</button>
                    <button class="chip-btn" id="btnItalic" onclick="toggleStyle('italic')">/ Itálico</button>
                  </div>
                  <div style="display:flex;gap:8px;padding-top:4px">
                    <button class="btn btn-ghost" onclick="closeStyleEditor()">Fechar</button>
                    <button class="btn btn-primary" onclick="saveStyle()">Salvar Estilo</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- PREVIEW -->
        <div class="col-preview">
          <div class="block" style="position:sticky;top:76px;">
            <div class="block-header">
              <div class="block-title">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                Preview ao Vivo
              </div>
            </div>
            <div id="livePreview" class="preview-scroll fade-edge"></div>
          </div>
        </div>

      </div>
    </div>

    <!-- BRAND IMPORT VIEW -->
    <div id="viewBrandImport" class="view">
      <div class="home-head" style="margin-bottom:14px">
        <div>
          <h1>Carregar sua marca</h1>
          <p>Faça upload dos elementos da identidade, ajuste composição e finalize antes de voltar para a edição.</p>
        </div>
        <button class="btn btn-ghost" onclick="nav('editor')">Voltar</button>
      </div>
      <div class="brand-import-shell">
        <div class="brand-import-main">
          <div class="brand-import-controls block">
          <div class="block-header"><div class="block-title">Identidade da Marca</div></div>
          <div class="block-body stack">
            <div class="field">
              <label class="field-label">Nome base (para arquivos)</label>
              <input class="inp" id="inpBrandBaseName" placeholder="minha-marca" disabled>
            </div>
            <div class="field-label">Uploads da marca</div>
            <div class="upload-row">
              <button class="btn btn-ghost" onclick="triggerLogo('sq')" style="justify-content:center">Símbolo / Ícone</button>
              <button class="btn btn-ghost mini" onclick="clearLogo('sq')" style="justify-content:center">Limpar</button>
            </div>
            <div class="upload-row">
              <button class="btn btn-ghost" onclick="triggerLogo('wd')" style="justify-content:center">Logotipo - Parte 1</button>
              <button class="btn btn-ghost mini" onclick="clearLogo('wd')" style="justify-content:center">Limpar</button>
            </div>
            <div id="extraUploadList" class="stack" style="gap:8px"></div>
            <button class="btn btn-ghost" onclick="addExtraLogoSlot()" style="justify-content:center">+ Adicionar logo / texto</button>
            <div class="field"><label class="field-label">Altura X (%)</label><input id="inpXHeight" class="inp" type="range" min="20" max="90" step="1" oninput="updateBrandImportSetting('xHeight',this.value)"></div>
            <div class="field"><label class="field-label">Área de respiro (%)</label><input id="inpSafeMargin" class="inp" type="range" min="0" max="40" step="1" oninput="updateBrandImportSetting('safeMargin',this.value)"></div>
            <button class="btn btn-primary" onclick="applyBrandImportToSlots()" style="justify-content:center">Aplicar ajustes da marca</button>
            <div id="brandImportStats" class="import-stats">Sem ativos importados.</div>
          </div>
        </div>
        <div class="brand-import-preview block">
          <div class="block-header"><div class="block-title">Composição Final</div></div>
          <div class="block-body stack">
            <div class="brand-preview-grid">
              <div class="brand-preview-panel">
                <div class="field-label" style="margin-bottom:6px">Logo quadrado</div>
                <div class="brand-preview-slot" id="advSlotSq"></div>
                <div class="row2" style="margin-top:8px">
                  <input class="inp" id="advSqX" type="number" placeholder="X" oninput="updateBrandPlacement('sq','x',this.value)">
                  <input class="inp" id="advSqY" type="number" placeholder="Y" oninput="updateBrandPlacement('sq','y',this.value)">
                </div>
                <input class="inp" id="advSqScale" type="range" min="20" max="220" value="100" oninput="updateBrandPlacement('sq','scale',this.value)">
              </div>
              <div class="brand-preview-panel">
                <div class="field-label" style="margin-bottom:6px">Logo horizontal</div>
                <div class="brand-preview-slot" id="advSlotWd"></div>
                <div class="row2" style="margin-top:8px">
                  <input class="inp" id="advWdX" type="number" placeholder="X" oninput="updateBrandPlacement('wd','x',this.value)">
                  <input class="inp" id="advWdY" type="number" placeholder="Y" oninput="updateBrandPlacement('wd','y',this.value)">
                </div>
                <input class="inp" id="advWdScale" type="range" min="20" max="220" value="100" oninput="updateBrandPlacement('wd','scale',this.value)">
              </div>
            </div>
            <div>
              <div class="field-label" style="margin-bottom:6px">Elementos adicionais da marca</div>
              <div id="advExtraPreview" class="brand-extra-grid"></div>
            </div>
            <div>
              <div class="field-label" style="margin-bottom:6px">Painel combinado</div>
              <div class="brand-composite" id="brandCompositePreview"></div>
            </div>
          </div>
        </div>
        </div>
        <div class="brand-import-side">
          <div class="block">
            <div class="block-header"><div class="block-title">Layout & Composição</div></div>
            <div class="block-body stack">
              <div class="field"><label class="field-label">Estrutura da marca</label><select class="sel" disabled><option>Horizontal (símbolo + logotipo)</option></select></div>
              <div class="field"><label class="field-label">Layout do logotipo</label><select class="sel" disabled><option>Stack (1 sobre 2)</option></select></div>
              <div class="field"><label class="field-label">Grid de construção</label><select class="sel" disabled><option>Oculto</option></select></div>
              <div class="field"><label class="field-label">Área de proteção</label><select class="sel" disabled><option>Visível</option></select></div>
              <div class="import-stats">Os ajustes finos de layout podem ser ligados nas próximas versões. Por enquanto, use altura X, respiro e posição manual.</div>
            </div>
          </div>
          <div class="block">
            <div class="block-header"><div class="block-title">Paleta & Exportar</div></div>
            <div class="block-body stack">
              <div id="brandImportPalette" class="stack" style="gap:8px"></div>
              <div class="row2">
                <button class="btn btn-ghost" onclick="nav('editor')" style="justify-content:center">Editar cores</button>
                <button class="btn btn-primary" onclick="nav('export')" style="justify-content:center">Ir para exportar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- EXPORT VIEW -->
    <div id="viewExport" class="view">
      <div class="home-head">
        <div>
          <h1>Exportar</h1>
          <p>Gerencie pastas, subpastas e arquivos gerados da marca e das aplicações.</p>
        </div>
      </div>
      <div id="exportManager"></div>
      <div id="exportGrid" class="export-grid"></div>
    </div>

  </div><!-- /main -->
</div><!-- /shell -->


<input id="fileLogoSq" type="file" accept=".svg,image/*" style="display:none">
<input id="fileLogoWd" type="file" accept=".svg,image/*" style="display:none">
<input id="fileLogoExtra" type="file" accept=".svg,image/*" style="display:none">


<!-- =========================================================
     APP EDITOR (FULLSCREEN) — Embedded Advanced Editor
========================================================= -->
<div id="viewAppEditor" class="view">
  <div class="appedit-shell">
    <div class="appedit-top">
      <div class="left">
        <button class="btn btn-ghost" onclick="closeAppEditor()" style="padding:10px 14px">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
          Voltar
        </button>
        <span id="appEditName" class="badge">Aplicação</span>
      </div>
      <div class="mid" style="display:flex;align-items:center;gap:10px;justify-content:center;flex-wrap:wrap">
        <input id="appEditNameInput" class="inp" style="max-width:320px;height:38px" placeholder="Nome da aplicação" />
        <button class="btn btn-ghost" onclick="renameCurrentApplication()" title="Renomear aplicação">Renomear</button>
        <span id="appEditMeta" style="font-size:12px;color:var(--ink3);font-family:var(--mono)">—</span>
      </div>
      <div class="right">
        <button class="btn btn-primary" onclick="saveCurrentApplication()" title="Salvar aplicação nas Aplicações">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Salvar Aplicação
        </button>
        <button class="btn btn-ghost" onclick="geFit()" title="Encaixar na tela">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 3H3v4M17 3h4v4M7 21H3v-4M21 17v4h-4"/></svg>
          Encaixar
        </button>
        <button class="btn btn-primary" onclick="geExportPNG()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Exportar PNG
        </button>
        <button class="btn btn-ghost" onclick="closeAppEditor()" style="width:38px;padding:0;justify-content:center">✕</button>
      </div>
    </div>

    <!-- EDITOR BODY: apenas o iframe ocupa tudo -->
    <div class="appedit-body">
      <div class="ge-iframeWrap">
        <iframe id="geEditorFrame" title="Goblin Editor"
          sandbox="allow-scripts allow-same-origin allow-downloads"
          referrerpolicy="no-referrer"
          style="width:100%;height:100%;border:0;border-radius:18px;overflow:hidden;background:transparent"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- IDs fantasmas para que o código JS não quebre ao buscar esses elementos -->
<div style="display:none" aria-hidden="true">
  <span id="selTag"></span><span id="selType"></span>
  <input id="fillHex"><input id="fillColor"><input id="posX"><input id="posY">
  <input id="sizeW"><input id="sizeH"><input id="radius"><input id="fontSize">
  <input id="textValue"><select id="fontWeight"></select><select id="stylePick"></select>
  <div id="paletteRow"></div><div id="layerList"></div><span id="layerCount"></span>
  <div id="sizeTitle"></div><div id="sizeWRow"></div><div id="sizeHRow"></div>
  <div id="radiusRow"></div><div id="textStyleRow"></div>
  <div id="appCanvasHost"></div>
</div>

<template id="geEditorTemplate">
&lt;!doctype html&gt;
&lt;html lang=&quot;pt-BR&quot;&gt;
&lt;head&gt;
&lt;meta charset=&quot;utf-8&quot;/&gt;
&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1&quot;/&gt;
&lt;title&gt;Studio&lt;/title&gt;
&lt;script src=&quot;https://unpkg.com/fabric@5.3.0/dist/fabric.min.js&quot;&gt;&lt;/script&gt;
&lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.googleapis.com&quot;&gt;
&lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.gstatic.com&quot; crossorigin&gt;
&lt;link href=&quot;https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&amp;family=Syne:wght@400;500;600;700;800&amp;family=Outfit:wght@300;400;500;600;700;800;900&amp;family=Sora:wght@300;400;600;700;800&amp;family=DM+Sans:wght@300;400;500;600;700&amp;family=Nunito:wght@300;400;600;700;800&amp;family=Poppins:wght@300;400;600;700;800&amp;family=Montserrat:wght@300;400;600;700;800&amp;family=IBM+Plex+Sans:wght@300;400;600;700&amp;family=Raleway:wght@300;400;600;700;800&amp;family=Manrope:wght@300;400;600;700;800&amp;family=Inter:wght@300;400;600;800&amp;family=Roboto:wght@300;400;700&amp;display=swap&quot; rel=&quot;stylesheet&quot;&gt;
&lt;style&gt;
:root {
  --bg:       #0e0e11;
  --surface:  #16161a;
  --panel:    #1e1e24;
  --border:   rgba(255,255,255,.07);
  --border2:  rgba(255,255,255,.12);
  --ink:      #f0eff4;
  --ink2:     rgba(240,239,244,.65);
  --ink3:     rgba(240,239,244,.32);
  --accent:   #7f5af0;
  --accent-d: #6848d2;
  --danger:   #e85d5d;
  --good:     #2cb67d;
  --mono:     'DM Mono', monospace;
  --sans:     'Syne', sans-serif;
  --r:        10px;
  --r-lg:     16px;
  --panel-w:  224px;
  --topbar-h: 48px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden;background:var(--bg)}
body{font-family:'Outfit', ui-sans-serif, system-ui, sans-serif;font-size:13px;color:var(--ink)}

button{font-family:inherit;cursor:pointer;border:none;outline:none;user-select:none}
input,select{font-family:'JetBrains Mono', ui-monospace, monospace;color:var(--ink);background:var(--bg);border:1px solid var(--border2);outline:none;font-size:12px}
input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(127,90,240,.15)}

/* ─── LAYOUT ──────────────────────────────────────────── */
.app{
  display:grid;
  grid-template-rows: 30px var(--topbar-h) 1fr;
  grid-template-columns: var(--panel-w) 1fr var(--panel-w);
  height:100%;
}

.menu-bar{
  grid-column:1 / -1;
  display:flex;
  align-items:center;
  gap:10px;
  padding:0 14px;
  border-bottom:1px solid var(--border);
}
.menu-bar{background:#202026;font-size:12px}
.menu-item{color:var(--ink2);padding:4px 8px;border-radius:6px}
.menu-item:hover{background:rgba(255,255,255,.08);color:var(--ink)}
.menu-item.active{background:rgba(127,90,240,.18);color:#fff}
.menu-spacer{margin-left:auto}
.menu-dd{position:relative}
.menu-item-btn{border:none;cursor:pointer;background:transparent;color:var(--ink2);font:inherit;line-height:1;display:inline-flex;align-items:center}
.menu-item-btn:hover{background:rgba(255,255,255,.08);color:var(--ink)}
.menu-item-btn.active{background:rgba(127,90,240,.18);color:#fff}
.menu-dd-panel{
  display:none;position:absolute;top:calc(100% + 8px);left:0;z-index:50;
  width:320px;padding:12px;border-radius:12px;background:var(--panel);
  border:1px solid var(--border2);box-shadow:0 24px 48px rgba(0,0,0,.45);
}
.menu-dd.open .menu-dd-panel{display:block}
.menu-dd-panel.compact{width:260px;padding:8px}
.menu-cmd{height:30px;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:0 8px;border-radius:7px;color:var(--ink2);font-family:var(--mono);font-size:11px;cursor:pointer}
.menu-cmd:hover{background:rgba(255,255,255,.08);color:#fff}
.menu-cmd .k{opacity:.75;font-size:10px}
.menu-cmd-sep{height:1px;background:var(--border);margin:6px 4px}

.ctx-pill{height:26px;padding:0 10px;border-radius:8px;border:1px solid var(--border2);display:inline-flex;align-items:center;color:var(--ink2)}
.ctx-pill strong{color:var(--ink);font-weight:600}

/* ─── TOPBAR ──────────────────────────────────────────── */
.topbar{
  grid-column: 1 / -1;
  display:flex;align-items:center;gap:0;
  background:var(--surface);
  border-bottom:1px solid var(--border);
  position:relative;
  z-index:10;
}
.topbar-brand{
  display:flex;align-items:center;gap:10px;
  padding:0 20px;
  width:var(--panel-w);
  border-right:1px solid var(--border);
  height:100%;
  flex-shrink:0;
}
.brand-dot{
  width:20px;height:20px;border-radius:6px;
  background:var(--accent);
  box-shadow:0 0 12px rgba(127,90,240,.45);
  flex-shrink:0;
}
.brand-name{
  font-size:13px;font-weight:700;letter-spacing:.04em;
  color:var(--ink);font-family:'Outfit', ui-sans-serif, system-ui, sans-serif;
}
.topbar-status{
  flex:1;display:flex;align-items:center;justify-content:center;
  gap:6px;
  font-family:'JetBrains Mono', ui-monospace, monospace;font-size:11px;color:var(--ink3);
  letter-spacing:.04em;
}
.status-dot{
  width:6px;height:6px;border-radius:50%;
  background:var(--accent);
  animation:pulse 2s ease-in-out infinite;
}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(127,90,240,.35)}50%{opacity:.7;box-shadow:0 0 0 4px rgba(127,90,240,0)}}
.topbar-actions{
  display:flex;align-items:center;gap:6px;
  padding:0 12px;
  width:var(--panel-w);
  border-left:1px solid var(--border);
  height:100%;
  flex-shrink:0;
}

/* ─── TOOLBAR BUTTONS ─────────────────────────────────── */
.tbtn{
  height:30px;padding:0 10px;border-radius:var(--r);
  background:transparent;color:var(--ink2);
  font-family:'JetBrains Mono', ui-monospace, monospace;font-size:11px;font-weight:500;
  letter-spacing:.03em;
  border:1px solid transparent;
  transition:all .12s ease;display:inline-flex;align-items:center;gap:5px;
}
.tbtn:hover{background:rgba(255,255,255,.06);color:var(--ink);border-color:var(--border2)}
.tbtn.accent{
  background:var(--accent);color:#fff;font-weight:700;
  border-color:transparent;
}
.tbtn.accent:hover{background:#9370f5;box-shadow:0 0 12px rgba(127,90,240,.35)}
.tbtn.danger{color:var(--danger)}
.tbtn.danger:hover{background:rgba(255,64,96,.1);border-color:rgba(255,64,96,.25)}
.tbtn.active{background:rgba(127,90,240,.12);color:var(--accent);border-color:rgba(127,90,240,.26)}
.tbtn svg{flex-shrink:0}

/* ─── PANELS ──────────────────────────────────────────── */
.panel{
  background:var(--panel);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  overflow:hidden;
  min-height:0;
}
.panel.right{border-right:none;border-left:1px solid var(--border)}
.panel-head{
  padding:14px 16px 10px;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.panel-label{
  font-size:9px;font-weight:700;letter-spacing:.12em;
  text-transform:uppercase;color:var(--ink3);
  font-family:'JetBrains Mono', ui-monospace, monospace;
  margin-bottom:10px;
}
.panel-body{flex:1;overflow-y:auto;overflow-x:hidden;padding:10px 12px 16px}
.panel-body::-webkit-scrollbar{width:3px}
.panel-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.panel-section{margin-bottom:16px}
.panel-section-label{
  font-size:9px;letter-spacing:.1em;text-transform:uppercase;
  color:var(--ink3);font-family:'JetBrains Mono', ui-monospace, monospace;
  margin-bottom:8px;font-weight:600;
}

/* ─── TOOLBAR (floating) ─────────────────────────────── */
.floating-toolbar-wrap{position:absolute;left:50%;bottom:58px;transform:translateX(-50%);z-index:12;display:inline-flex;flex-direction:column;align-items:center;gap:8px;pointer-events:auto;width:max-content;max-width:calc(100% - 28px)}
.floating-toolbar-row{display:flex;align-items:center;white-space:nowrap;width:max-content;max-width:calc(100vw - 48px);background:linear-gradient(180deg, rgba(34,34,42,.96), rgba(22,22,28,.96));border:1px solid rgba(255,255,255,.09);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.34), inset 0 1px 0 rgba(255,255,255,.06);overflow:hidden;backdrop-filter:blur(10px)}
.float-tool-btn{height:40px;padding:0 13px;border-right:1px solid rgba(255,255,255,.08);background:transparent;color:rgba(240,239,244,.78);font-family:var(--mono);font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px;flex:0 0 auto}
.float-tool-btn:last-child{border-right:none}
.float-tool-btn:hover{background:rgba(255,255,255,.06);color:#fff}
.float-tool-btn.active{background:rgba(127,90,240,.24);color:#fff;box-shadow:inset 0 0 0 1px rgba(127,90,240,.3)}
.float-tool-btn.icon{width:40px;justify-content:center;padding:0;font-size:14px}
.float-tool-sep{width:1px;height:20px;background:rgba(255,255,255,.12)}
.top-tools{display:none}
.floating-toolbar-wrap.show-bezier-submenu .top-tools{display:flex}
.top-tools{position:absolute;left:50%;bottom:calc(100% + 8px);transform:translateX(-50%)}
.fixed-tools{position:relative}
.tool-submenu{position:absolute;bottom:calc(100% + 8px);left:0;display:none;flex-direction:column;gap:4px;min-width:168px;padding:6px;background:rgba(24,24,29,.98);border:1px solid var(--border2);border-radius:10px;box-shadow:0 18px 36px rgba(0,0,0,.45)}
.tool-submenu.open{display:flex}
.tool-submenu-btn{height:30px;border-radius:7px;border:1px solid transparent;background:transparent;color:var(--ink2);font-family:var(--mono);font-size:11px;display:flex;align-items:center;justify-content:space-between;padding:0 8px}
.tool-submenu-btn:hover{background:rgba(255,255,255,.08);color:#fff}
.tool-submenu-btn.active{background:rgba(127,90,240,.18);border-color:rgba(127,90,240,.32);color:#fff}
.ctx-pop{position:fixed;display:none;min-width:220px;background:rgba(24,24,29,.98);border:1px solid var(--border2);border-radius:12px;box-shadow:0 18px 36px rgba(0,0,0,.45);padding:6px;z-index:80}
.ctx-pop.open{display:block}
.ctx-pop-item{height:34px;border-radius:8px;padding:0 10px;display:flex;align-items:center;justify-content:space-between;color:var(--ink2);font-size:12px;font-family:var(--mono)}
.ctx-pop-item:hover{background:rgba(255,255,255,.07);color:#fff}
.ctx-pop-sep{height:1px;background:var(--border);margin:6px 2px}

.text-float-panel{position:absolute;left:24px;bottom:24px;z-index:13;width:300px;background:rgba(24,24,29,.96);border:1px solid var(--border2);border-radius:14px;box-shadow:0 20px 44px rgba(0,0,0,.45);display:none;overflow:hidden}
.text-float-panel.open{display:block}
.text-float-head{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border)}
.text-float-tabs{display:flex;gap:4px}
.text-float-tab{height:28px;padding:0 10px;border-radius:8px;border:1px solid transparent;background:transparent;color:var(--ink2);font-size:11px;font-family:var(--mono)}
.text-float-tab.active{background:rgba(127,90,240,.18);color:#fff;border-color:rgba(127,90,240,.35)}
.text-float-close{margin-left:auto;width:28px;height:28px;border-radius:8px;border:1px solid var(--border2);background:transparent;color:var(--ink2)}
.text-float-body{padding:10px 12px;display:grid;gap:8px}
.text-float-grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.text-float-panel [data-pane]{display:none}
.text-float-panel [data-pane].active{display:grid;gap:8px}

/* ─── DOC INPUTS ──────────────────────────────────────── */
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
.field-row.one{grid-template-columns:1fr}
.field-item{display:flex;flex-direction:column;gap:4px}
.field-label{font-size:9px;letter-spacing:.08em;text-transform:uppercase;color:var(--ink3);font-family:var(--mono)}
.field-input{
  height:32px;padding:0 9px;border-radius:8px;width:100%;
  background:var(--surface);border:1px solid var(--border2);
  color:var(--ink);font-family:'JetBrains Mono', ui-monospace, monospace;font-size:12px;
}
.field-input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(127,90,240,.14)}
input[type=&quot;color&quot;].field-input{padding:2px 4px;cursor:pointer}

/* ─── SEPARATOR ───────────────────────────────────────── */
.sep{height:1px;background:var(--border);margin:12px -12px}

/* ─── LAYERS ──────────────────────────────────────────── */
.layer-tools{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
.layer-item{
  display:grid;grid-template-columns:22px 1fr auto;gap:8px;align-items:start;
  padding:7px 9px;border-radius:8px;border:1px solid transparent;
  cursor:pointer;transition:all .1s ease;margin-bottom:4px;
}
.layer-main{display:flex;align-items:center;gap:8px;min-width:0}
.layer-item:hover{background:rgba(255,255,255,.04)}
.layer-item.active{background:rgba(127,90,240,.1);border-color:rgba(127,90,240,.26)}
.layer-item.drag-over{border-color:rgba(127,90,240,.7);background:rgba(127,90,240,.18)}
.layer-icon{width:22px;height:22px;border-radius:5px;background:var(--surface);display:flex;align-items:center;justify-content:center;color:var(--ink3);font-size:10px}
.layer-item.active .layer-icon{background:rgba(127,90,240,.18);color:var(--accent)}
.layer-thumb{width:34px;height:24px;border-radius:6px;border:1px solid var(--border2);background:linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.02));margin-right:6px;overflow:hidden;background-size:cover;background-position:center}
.layer-name{font-size:11px;font-family:'JetBrains Mono', ui-monospace, monospace;color:var(--ink2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.layer-item.active .layer-name{color:var(--ink)}
.layer-meta{font-size:10px;color:var(--ink3);font-family:var(--mono)}
.layer-controls{display:grid;grid-template-columns:84px 70px;gap:6px;margin-top:6px}
.layer-ctl{height:24px;border-radius:7px;border:1px solid var(--border2);background:var(--surface);color:var(--ink2);font-size:10px;padding:0 6px;font-family:var(--mono)}
.layer-folder{margin-top:6px;width:100%}
.layer-empty{text-align:center;padding:24px 0;font-size:11px;color:var(--ink3);font-family:'JetBrains Mono', ui-monospace, monospace}
.folder-chip{display:inline-flex;align-items:center;height:22px;padding:0 8px;border:1px solid var(--border2);border-radius:999px;font-size:10px;color:var(--ink2);margin:0 6px 6px 0}
.lib-item{
  display:flex;align-items:center;gap:8px;
  padding:7px 9px;border-radius:8px;
  border:1px solid transparent;
  cursor:pointer;transition:all .1s ease;
  margin-bottom:3px;
}
.lib-item:hover{background:rgba(255,255,255,.04)}
.lib-item[draggable="true"]{cursor:grab}
.lib-item:active{cursor:grabbing}
.lib-preview{width:42px;height:30px;border-radius:7px;border:1px solid var(--border2);background:linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.02));background-size:cover;background-position:center;flex-shrink:0}
.lib-icon{
  width:22px;height:22px;border-radius:5px;background:var(--surface);
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
  color:var(--ink3);font-size:11px
}
.lib-name{flex:1;font-size:11px;font-family:'JetBrains Mono', ui-monospace, monospace;color:var(--ink2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lib-meta{font-size:10px;color:var(--ink3);font-family:'JetBrains Mono', ui-monospace, monospace}

/* ─── PROPS PANEL ─────────────────────────────────────── */
.prop-row{margin-bottom:8px}
.prop-grid2{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.prop-grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px}

/* Segmented control */
.seg{
  display:flex;background:var(--surface);
  border:1px solid var(--border2);border-radius:8px;overflow:hidden;
}
.seg-opt{
  flex:1;height:30px;
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-family:'JetBrains Mono', ui-monospace, monospace;color:var(--ink3);
  cursor:pointer;transition:all .1s ease;
  background:transparent;
}
.seg-opt:hover{color:var(--ink)}
.seg-opt.on{background:var(--accent);color:#fff;font-weight:700}

/* Palette swatches */
.swatch-grid{display:flex;flex-wrap:wrap;gap:5px;margin-top:6px}
.swatch{
  width:22px;height:22px;border-radius:6px;
  border:1px solid rgba(255,255,255,.12);cursor:pointer;
  transition:transform .1s ease,box-shadow .1s ease;
}
.swatch:hover{transform:scale(1.15);box-shadow:0 0 0 2px var(--accent)}

/* ─── CANVAS AREA ─────────────────────────────────────── */
.canvas-area{
  position:relative;overflow:hidden;
  background:var(--desk-bg,
    radial-gradient(ellipse 60% 50% at 25% 20%, rgba(127,90,240,.12), transparent),
    radial-gradient(ellipse 50% 60% at 75% 80%, rgba(44,182,125,.08), transparent),
    var(--bg)
  );
}
/* dot grid */
.canvas-area::before{
  content:'';position:absolute;inset:0;
  background-image:radial-gradient(circle, var(--desk-dot, rgba(255,255,255,.08)) 1px, transparent 1px);
  background-size:28px 28px;
  pointer-events:none;z-index:0;
}
#fabricCanvas{position:absolute;inset:0;z-index:1}
#fabricCanvas canvas{display:block}
.artboard-plus-ui{position:absolute;inset:0;pointer-events:none;z-index:6;display:none}
.ab-plus{
  position:absolute;width:28px;height:28px;border-radius:999px;
  border:1px solid var(--border2);background:rgba(14,14,17,.9);color:#fff;
  display:grid;place-items:center;font-size:18px;line-height:1;
  box-shadow:0 8px 22px rgba(0,0,0,.35);pointer-events:auto;
}
.ab-plus:hover{background:var(--accent);border-color:rgba(255,255,255,.35)}

/* ─── HINT ────────────────────────────────────────────── */
.hint-bar{
  position:absolute;bottom:16px;left:16px;
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  background:rgba(10,10,12,.75);backdrop-filter:blur(8px);
  border:1px solid var(--border);border-radius:10px;
  padding:6px 10px;z-index:10;
}
.hint-key{
  font-family:'JetBrains Mono', ui-monospace, monospace;font-size:10px;
  background:rgba(255,255,255,.08);border:1px solid var(--border2);
  padding:2px 6px;border-radius:5px;color:var(--ink2);
  display:inline-flex;align-items:center;
}
.hint-sep{color:var(--ink3);font-size:10px;font-family:var(--mono)}

/* ─── MODAL ───────────────────────────────────────────── */
.modal-bg{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.7);backdrop-filter:blur(6px);
  z-index:100;align-items:center;justify-content:center;
}
.modal-bg.open{display:flex}
.modal-box{
  background:var(--panel);border:1px solid var(--border2);
  border-radius:var(--r-lg);padding:24px;
  min-width:360px;max-width:520px;width:90%;
  max-height:80vh;display:flex;flex-direction:column;
  box-shadow:0 40px 80px rgba(0,0,0,.7);
}
.modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.modal-title{font-size:15px;font-weight:700}
.modal-body{flex:1;overflow:auto}
textarea.modal-textarea{
  width:100%;min-height:200px;resize:vertical;
  background:var(--surface);border:1px solid var(--border2);
  border-radius:var(--r);padding:12px;color:var(--ink);
  font-family:'JetBrains Mono', ui-monospace, monospace;font-size:11px;line-height:1.6;
}

/* ─── SHORTCUTS POPUP ─────────────────────────────────── */
.shortcuts-grid{display:grid;grid-template-columns:auto 1fr;gap:6px 14px;align-items:center}
.sc-key{font-family:'JetBrains Mono', ui-monospace, monospace;font-size:11px;
  background:rgba(255,255,255,.07);border:1px solid var(--border2);
  padding:3px 8px;border-radius:6px;color:var(--accent);white-space:nowrap;text-align:center}
.sc-desc{font-size:11px;color:var(--ink2);font-family:var(--mono)}
.panel-tabs{display:flex;gap:4px;padding:4px;background:#19191e;border:1px solid var(--border);border-radius:10px;margin-bottom:10px}
.panel-tab{flex:1;text-align:center;padding:6px 4px;font-size:11px;color:var(--ink2);border-radius:7px}
.panel-tab.active{background:#2d2d35;color:var(--ink);font-weight:600}
.rp-row{display:flex;gap:6px;align-items:center;margin-bottom:8px}
.rp-icon-btn{height:30px;min-width:30px;padding:0 8px;border-radius:8px;border:1px solid var(--border2);background:var(--surface);color:var(--ink2);font-family:var(--mono);font-size:11px;display:inline-flex;align-items:center;justify-content:center}
.rp-icon-btn:hover{color:var(--ink);border-color:rgba(255,255,255,.24)}
.rp-icon-btn.active{background:rgba(127,90,240,.16);border-color:rgba(127,90,240,.35);color:#fff}
.rp-grow{flex:1}
.rp-stroke-range{width:100%;accent-color:var(--accent)}
.rp-chip{height:24px;padding:0 8px;border-radius:999px;border:1px solid var(--border2);display:inline-flex;align-items:center;font-size:10px;color:var(--ink2);background:rgba(255,255,255,.02)}
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class=&quot;app&quot;&gt;

  &lt;div class=&quot;menu-bar&quot;&gt;
    &lt;div class=&quot;menu-dd&quot; id=&quot;menuFileRoot&quot;&gt;
      &lt;button class=&quot;menu-item menu-item-btn active&quot; id=&quot;btnMenuFile&quot;&gt;Arquivo&lt;/button&gt;
      &lt;div class=&quot;menu-dd-panel compact&quot; id=&quot;menuFilePanel&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;menu-dd&quot; id=&quot;menuEditRoot&quot;&gt;
      &lt;button class=&quot;menu-item menu-item-btn&quot; id=&quot;btnMenuEdit&quot;&gt;Editar&lt;/button&gt;
      &lt;div class=&quot;menu-dd-panel compact&quot; id=&quot;menuEditPanel&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;menu-dd&quot; id=&quot;menuSelectRoot&quot;&gt;
      &lt;button class=&quot;menu-item menu-item-btn&quot; id=&quot;btnMenuSelect&quot;&gt;Seleção&lt;/button&gt;
      &lt;div class=&quot;menu-dd-panel compact&quot; id=&quot;menuSelectPanel&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;menu-dd&quot; id=&quot;menuCreateRoot&quot;&gt;
      &lt;button class=&quot;menu-item menu-item-btn&quot; id=&quot;btnMenuCreate&quot;&gt;Criar&lt;/button&gt;
      &lt;div class=&quot;menu-dd-panel compact&quot; id=&quot;menuCreatePanel&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;menu-dd&quot; id=&quot;menuTransformRoot&quot;&gt;
      &lt;button class=&quot;menu-item menu-item-btn&quot; id=&quot;btnMenuTransform&quot;&gt;Transformar&lt;/button&gt;
      &lt;div class=&quot;menu-dd-panel compact&quot; id=&quot;menuTransformPanel&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;menu-dd&quot; id=&quot;menuAppearanceRoot&quot;&gt;
      &lt;button class=&quot;menu-item menu-item-btn&quot; id=&quot;btnMenuAppearance&quot;&gt;Aparência&lt;/button&gt;
      &lt;div class=&quot;menu-dd-panel compact&quot; id=&quot;menuAppearancePanel&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;menu-dd&quot; id=&quot;menuOrganizeRoot&quot;&gt;
      &lt;button class=&quot;menu-item menu-item-btn&quot; id=&quot;btnMenuOrganize&quot;&gt;Organizar&lt;/button&gt;
      &lt;div class=&quot;menu-dd-panel compact&quot; id=&quot;menuOrganizePanel&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;menu-dd&quot; id=&quot;menuBooleanRoot&quot;&gt;
      &lt;button class=&quot;menu-item menu-item-btn&quot; id=&quot;btnMenuBoolean&quot;&gt;Boolean&lt;/button&gt;
      &lt;div class=&quot;menu-dd-panel compact&quot; id=&quot;menuBooleanPanel&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;menu-dd&quot; id=&quot;menuTextRoot&quot;&gt;
      &lt;button class=&quot;menu-item menu-item-btn&quot; id=&quot;btnMenuText&quot;&gt;Texto&lt;/button&gt;
      &lt;div class=&quot;menu-dd-panel compact&quot; id=&quot;menuTextPanel&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;menu-dd&quot; id=&quot;menuViewRoot&quot;&gt;
      &lt;button class=&quot;menu-item menu-item-btn&quot; id=&quot;btnMenuView&quot;&gt;Exibir&lt;/button&gt;
      &lt;div class=&quot;menu-dd-panel compact&quot; id=&quot;menuViewPanel&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;menu-dd&quot; id=&quot;menuAdvancedRoot&quot;&gt;
      &lt;button class=&quot;menu-item menu-item-btn&quot; id=&quot;btnMenuAdvanced&quot;&gt;Avançado&lt;/button&gt;
      &lt;div class=&quot;menu-dd-panel compact&quot; id=&quot;menuAdvancedPanel&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;menu-dd&quot; id=&quot;menuDocRoot&quot;&gt;
      &lt;button class=&quot;menu-item menu-item-btn&quot; id=&quot;btnMenuDocumento&quot;&gt;Documento&lt;/button&gt;
      &lt;div class=&quot;menu-dd-panel&quot; id=&quot;menuDocumentoPanel&quot;&gt;
        &lt;div class=&quot;panel-section-label&quot;&gt;Documento&lt;/div&gt;
        &lt;div class=&quot;field-row&quot;&gt;
          &lt;div class=&quot;field-item&quot;&gt;
            &lt;div class=&quot;field-label&quot;&gt;W px&lt;/div&gt;
            &lt;input class=&quot;field-input&quot; id=&quot;docW&quot; type=&quot;number&quot; value=&quot;1200&quot; min=&quot;200&quot; max=&quot;5000&quot;&gt;
          &lt;/div&gt;
          &lt;div class=&quot;field-item&quot;&gt;
            &lt;div class=&quot;field-label&quot;&gt;H px&lt;/div&gt;
            &lt;input class=&quot;field-input&quot; id=&quot;docH&quot; type=&quot;number&quot; value=&quot;750&quot; min=&quot;200&quot; max=&quot;5000&quot;&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;field-row one&quot;&gt;
          &lt;div class=&quot;field-item&quot;&gt;
            &lt;div class=&quot;field-label&quot;&gt;Mesa&lt;/div&gt;
            &lt;input class=&quot;field-input&quot; id=&quot;docBg&quot; type=&quot;color&quot; value=&quot;#0f1626&quot;&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;field-row one&quot;&gt;
          &lt;div class=&quot;field-item&quot;&gt;
            &lt;div class=&quot;field-label&quot;&gt;Tema da mesa&lt;/div&gt;
            &lt;select class=&quot;field-input&quot; id=&quot;deskTheme&quot; style=&quot;height:32px&quot;&gt;
              &lt;option value=&quot;nebula&quot; selected&gt;Nebula&lt;/option&gt;
              &lt;option value=&quot;clean&quot;&gt;Clean&lt;/option&gt;
              &lt;option value=&quot;paper&quot;&gt;Paper&lt;/option&gt;
              &lt;option value=&quot;mint&quot;&gt;Mint&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;field-row one&quot; style=&quot;margin-top:6px&quot;&gt;
          &lt;div class=&quot;field-item&quot;&gt;
            &lt;div class=&quot;field-label&quot;&gt;Referência de alinhamento&lt;/div&gt;
            &lt;select class=&quot;field-input&quot; id=&quot;alignTarget&quot; style=&quot;height:32px&quot;&gt;
              &lt;option value=&quot;layout&quot;&gt;Layout (prancheta)&lt;/option&gt;
              &lt;option value=&quot;object&quot;&gt;Objeto âncora&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;button class=&quot;tbtn&quot; id=&quot;btnArtboardMode&quot; style=&quot;width:100%;justify-content:center;height:32px;margin-top:6px&quot;&gt;Modo pranchetas&lt;/button&gt;
        &lt;div style=&quot;display:flex;gap:6px;margin-top:6px&quot;&gt;
          &lt;button class=&quot;tbtn&quot; id=&quot;btnApplyDoc&quot; style=&quot;flex:1;justify-content:center;height:32px&quot;&gt;Aplicar&lt;/button&gt;
          &lt;button class=&quot;tbtn&quot; id=&quot;btnCenterAll&quot; style=&quot;flex:1;justify-content:center;height:32px&quot;&gt;Centralizar&lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;span class=&quot;menu-spacer&quot;&gt;&lt;/span&gt;
    &lt;button class=&quot;menu-item menu-item-btn&quot; id=&quot;btnQuickExportPng&quot;&gt;Exportar PNG&lt;/button&gt;
  &lt;/div&gt;

  &lt;header class=&quot;topbar&quot;&gt;
    &lt;div class=&quot;topbar-brand&quot;&gt;
      &lt;div class=&quot;brand-dot&quot;&gt;&lt;/div&gt;
      &lt;span class=&quot;brand-name&quot;&gt;Vetor&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class=&quot;topbar-status&quot;&gt;
      &lt;button class=&quot;tbtn active&quot;&gt;Vetor&lt;/button&gt;
      &lt;button class=&quot;tbtn&quot;&gt;Pixel&lt;/button&gt;
      &lt;button class=&quot;tbtn&quot;&gt;Layout&lt;/button&gt;
      &lt;div style=&quot;width:1px;height:18px;background:var(--border);margin:0 2px&quot;&gt;&lt;/div&gt;
      &lt;button class=&quot;tbtn&quot; id=&quot;btnAlignLeft&quot; title=&quot;Alinhar à esquerda&quot; style=&quot;width:30px;padding:0;justify-content:center&quot;&gt;⟸&lt;/button&gt;
      &lt;button class=&quot;tbtn&quot; id=&quot;btnAlignCenter&quot; title=&quot;Centralizar horizontal&quot; style=&quot;width:30px;padding:0;justify-content:center&quot;&gt;↔&lt;/button&gt;
      &lt;button class=&quot;tbtn&quot; id=&quot;btnAlignRight&quot; title=&quot;Alinhar à direita&quot; style=&quot;width:30px;padding:0;justify-content:center&quot;&gt;⟹&lt;/button&gt;
      &lt;button class=&quot;tbtn&quot; id=&quot;btnAlignTop&quot; title=&quot;Alinhar no topo&quot; style=&quot;width:30px;padding:0;justify-content:center&quot;&gt;⟰&lt;/button&gt;
      &lt;button class=&quot;tbtn&quot; id=&quot;btnAlignMiddle&quot; title=&quot;Centralizar vertical&quot; style=&quot;width:30px;padding:0;justify-content:center&quot;&gt;↕&lt;/button&gt;
      &lt;button class=&quot;tbtn&quot; id=&quot;btnAlignBottom&quot; title=&quot;Alinhar na base&quot; style=&quot;width:30px;padding:0;justify-content:center&quot;&gt;⟱&lt;/button&gt;
      &lt;button class=&quot;tbtn&quot; id=&quot;btnUndo&quot; title=&quot;Undo (Ctrl+Z)&quot;&gt;
        &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2.5&quot;&gt;&lt;polyline points=&quot;1 4 1 10 7 10&quot;/&gt;&lt;path d=&quot;M3.51 15a9 9 0 1 0 .49-4.5&quot;/&gt;&lt;/svg&gt;
      &lt;/button&gt;
      &lt;button class=&quot;tbtn&quot; id=&quot;btnRedo&quot; title=&quot;Redo (Ctrl+Y)&quot;&gt;
        &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2.5&quot;&gt;&lt;polyline points=&quot;23 4 23 10 17 10&quot;/&gt;&lt;path d=&quot;M20.49 15a9 9 0 1 1-.49-4.5&quot;/&gt;&lt;/svg&gt;
      &lt;/button&gt;
      &lt;span id=&quot;statusText&quot;&gt;Pronto&lt;/span&gt; &lt;span id=&quot;zoomTopLabel&quot; style=&quot;color:var(--ink2)&quot;&gt;ZOOM 100%&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class=&quot;topbar-actions&quot;&gt;
      &lt;button class=&quot;tbtn&quot; id=&quot;btnDelete&quot; title=&quot;Apagar seleção (Del)&quot;&gt;
        &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2.5&quot;&gt;&lt;polyline points=&quot;3 6 5 6 21 6&quot;/&gt;&lt;path d=&quot;M19 6l-1 14H6L5 6&quot;/&gt;&lt;path d=&quot;M10 11v6M14 11v6&quot;/&gt;&lt;/svg&gt;
      &lt;/button&gt;
      &lt;button class=&quot;tbtn&quot; id=&quot;btnDuplicate&quot; title=&quot;Duplicar&quot;&gt;
        &lt;svg width=&quot;12&quot; height=&quot;12&quot; viewBox=&quot;0 0 24 24&quot; fill=&quot;none&quot; stroke=&quot;currentColor&quot; stroke-width=&quot;2.5&quot;&gt;&lt;rect x=&quot;9&quot; y=&quot;9&quot; width=&quot;13&quot; height=&quot;13&quot; rx=&quot;2&quot;/&gt;&lt;path d=&quot;M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1&quot;/&gt;&lt;/svg&gt;
      &lt;/button&gt;
      &lt;button class=&quot;tbtn accent&quot; id=&quot;btnExportPng&quot;&gt;PNG&lt;/button&gt;
    &lt;/div&gt;
  &lt;/header&gt;


  &lt;!-- ═══ LEFT PANEL ════════════════════════════════════ --&gt;
  &lt;aside class=&quot;panel&quot;&gt;
    &lt;div class=&quot;panel-body&quot;&gt;

      &lt;div class=&quot;panel-section&quot;&gt;&lt;div class=&quot;layer-empty&quot;&gt;Configurações de documento no menu superior &lt;strong&gt;Documento&lt;/strong&gt;.&lt;/div&gt;&lt;/div&gt;

      &lt;div class=&quot;sep&quot;&gt;&lt;/div&gt;

      &lt;div class=&quot;panel-section&quot; style=&quot;max-height:360px;display:flex;flex-direction:column&quot;&gt;
        &lt;div class=&quot;panel-section-label&quot; style=&quot;display:flex;justify-content:space-between&quot;&gt;
          Camadas
          &lt;span id=&quot;layerCount&quot; style=&quot;color:var(--ink3)&quot;&gt;0&lt;/span&gt;
        &lt;/div&gt;
        &lt;div class=&quot;layer-tools&quot;&gt;
          &lt;button class=&quot;tbtn&quot; id=&quot;btnCreateLayer&quot; style=&quot;justify-content:center;height:30px&quot;&gt;+ Layer&lt;/button&gt;
          &lt;button class=&quot;tbtn&quot; id=&quot;btnNewFolder&quot; style=&quot;justify-content:center;height:30px&quot;&gt;+ Pasta&lt;/button&gt;
          &lt;button class=&quot;tbtn&quot; id=&quot;btnGroup&quot; style=&quot;justify-content:center;height:30px&quot;&gt;Agrupar&lt;/button&gt;
          &lt;button class=&quot;tbtn&quot; id=&quot;btnUngroup&quot; style=&quot;justify-content:center;height:30px&quot;&gt;Desagrupar&lt;/button&gt;
          &lt;button class=&quot;tbtn&quot; id=&quot;btnClipMask&quot; style=&quot;justify-content:center;height:30px&quot;&gt;ClipMask&lt;/button&gt;
          &lt;button class=&quot;tbtn&quot; id=&quot;btnReleaseClip&quot; style=&quot;justify-content:center;height:30px&quot;&gt;Soltar clip&lt;/button&gt;
        &lt;/div&gt;
        &lt;div id=&quot;folderList&quot; style=&quot;margin-bottom:8px&quot;&gt;&lt;/div&gt;
        &lt;div id=&quot;layersList&quot; style=&quot;flex:1;overflow-y:auto;overflow-x:hidden&quot;&gt;&lt;/div&gt;
      &lt;/div&gt;

      &lt;div class=&quot;sep&quot;&gt;&lt;/div&gt;

      &lt;!-- Library --&gt;
      &lt;div class=&quot;panel-section&quot;&gt;
        &lt;div class=&quot;panel-section-label&quot; style=&quot;display:flex;justify-content:space-between&quot;&gt;
          Biblioteca
          &lt;span id=&quot;libCount&quot; style=&quot;color:var(--ink3)&quot;&gt;0&lt;/span&gt;
        &lt;/div&gt;
        &lt;div id=&quot;libraryList&quot;&gt;
          &lt;div class=&quot;layer-empty&quot;&gt;Sem itens de identidade&lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

    &lt;/div&gt;

    &lt;input id=&quot;fileInput&quot; type=&quot;file&quot; accept=&quot;.svg,.png,.jpg,.jpeg,.webp,.ai,.eps,application/postscript,image/*&quot; style=&quot;display:none&quot;&gt;
  &lt;/aside&gt;

  &lt;!-- ═══ CANVAS AREA ════════════════════════════════════ --&gt;
  &lt;main class=&quot;canvas-area&quot; id=&quot;canvasStage&quot;&gt;
    &lt;div id=&quot;fabricCanvas&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;artboard-plus-ui&quot; id=&quot;artboardPlusUI&quot;&gt;
      &lt;button class=&quot;ab-plus top&quot; id=&quot;btnAddArtTop&quot; title=&quot;Adicionar acima&quot;&gt;+&lt;/button&gt;
      &lt;button class=&quot;ab-plus right&quot; id=&quot;btnAddArtRight&quot; title=&quot;Adicionar à direita&quot;&gt;+&lt;/button&gt;
      &lt;button class=&quot;ab-plus bottom&quot; id=&quot;btnAddArtBottom&quot; title=&quot;Adicionar abaixo&quot;&gt;+&lt;/button&gt;
      &lt;button class=&quot;ab-plus left&quot; id=&quot;btnAddArtLeft&quot; title=&quot;Adicionar à esquerda&quot;&gt;+&lt;/button&gt;
    &lt;/div&gt;

    &lt;div class=&quot;floating-toolbar-wrap&quot; id=&quot;floatingToolbar&quot;&gt;
      &lt;div class=&quot;floating-toolbar-row top-tools&quot; id=&quot;floatingTopTools&quot;&gt;
        &lt;button class=&quot;float-tool-btn active&quot; id=&quot;btnToolVector&quot;&gt;Vetor&lt;/button&gt;
        &lt;button class=&quot;float-tool-btn&quot; id=&quot;btnToolMove&quot; data-tool=&quot;move&quot;&gt;Mover&lt;/button&gt;
        &lt;button class=&quot;float-tool-btn&quot; id=&quot;btnToolLasso&quot;&gt;Laço&lt;/button&gt;
        &lt;button class=&quot;float-tool-btn&quot; id=&quot;btnToolPaint&quot;&gt;Pintar&lt;/button&gt;
        &lt;button class=&quot;float-tool-btn&quot; id=&quot;btnToolCurve&quot;&gt;Curvar&lt;/button&gt;
        &lt;button class=&quot;float-tool-btn&quot; id=&quot;btnToolCut&quot;&gt;Cortar&lt;/button&gt;
        &lt;button class=&quot;float-tool-btn&quot; id=&quot;btnToolMore&quot;&gt;Mais ▾&lt;/button&gt;
      &lt;/div&gt;
      &lt;div class=&quot;floating-toolbar-row fixed-tools&quot;&gt;
        &lt;button class=&quot;float-tool-btn icon active&quot; id=&quot;btnSelect&quot; data-tool=&quot;select&quot; title=&quot;Selecionar / mover&quot;&gt;↖&lt;/button&gt;
        &lt;div class=&quot;tool-submenu&quot; id=&quot;selectToolSubmenu&quot;&gt;
          &lt;button class=&quot;tool-submenu-btn active&quot; id=&quot;btnSelectNormal&quot; data-tool=&quot;select&quot;&gt;&lt;span&gt;Seleção&lt;/span&gt;&lt;span&gt;V&lt;/span&gt;&lt;/button&gt;
          &lt;button class=&quot;tool-submenu-btn&quot; id=&quot;btnSelectDirect&quot; data-tool=&quot;direct-select&quot;&gt;&lt;span&gt;Seleção direta&lt;/span&gt;&lt;span&gt;A&lt;/span&gt;&lt;/button&gt;
        &lt;/div&gt;
        &lt;button class=&quot;float-tool-btn icon&quot; id=&quot;btnRect&quot; title=&quot;Retângulo&quot;&gt;▭&lt;/button&gt;
        &lt;button class=&quot;float-tool-btn icon&quot; id=&quot;btnCircle&quot; title=&quot;Círculo&quot;&gt;◯&lt;/button&gt;
        &lt;button class=&quot;float-tool-btn icon&quot; id=&quot;btnLine&quot; title=&quot;Linha&quot;&gt;／&lt;/button&gt;
        &lt;button class=&quot;float-tool-btn icon&quot; id=&quot;btnBezier&quot; title=&quot;Bezier&quot;&gt;∿&lt;/button&gt;
        &lt;button class=&quot;float-tool-btn icon&quot; id=&quot;btnTextTool&quot; data-tool=&quot;text&quot; title=&quot;Texto: clique (artístico) / arraste (caixa)&quot;&gt;T&lt;/button&gt;
        &lt;div class=&quot;float-tool-sep&quot;&gt;&lt;/div&gt;
        &lt;button class=&quot;float-tool-btn icon&quot; id=&quot;btnUpload&quot; title=&quot;Inserir imagem&quot;&gt;▣&lt;/button&gt;
        &lt;button class=&quot;float-tool-btn icon&quot; id=&quot;btnHelp&quot; title=&quot;Atalhos&quot;&gt;?&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class=&quot;text-float-panel&quot; id=&quot;textFloatPanel&quot;&gt;
      &lt;div class=&quot;text-float-head&quot;&gt;
        &lt;div class=&quot;text-float-tabs&quot;&gt;
          &lt;button class=&quot;text-float-tab active&quot; data-tf-tab=&quot;basico&quot;&gt;Básico&lt;/button&gt;
          &lt;button class=&quot;text-float-tab&quot; data-tf-tab=&quot;detalhes&quot;&gt;Detalhes&lt;/button&gt;
          &lt;button class=&quot;text-float-tab&quot; data-tf-tab=&quot;variavel&quot;&gt;Variável&lt;/button&gt;
        &lt;/div&gt;
        &lt;button class=&quot;text-float-close&quot; id=&quot;btnCloseTextFloat&quot;&gt;✕&lt;/button&gt;
      &lt;/div&gt;
      &lt;div class=&quot;text-float-body&quot;&gt;
        &lt;div data-pane=&quot;basico&quot; class=&quot;active&quot;&gt;
          &lt;div class=&quot;text-float-grid2&quot;&gt;
            &lt;input class=&quot;field-input&quot; id=&quot;tfFontSize&quot; type=&quot;number&quot; min=&quot;6&quot; step=&quot;1&quot; placeholder=&quot;Tamanho&quot;&gt;
            &lt;input class=&quot;field-input&quot; id=&quot;tfColor&quot; type=&quot;color&quot;&gt;
          &lt;/div&gt;
          &lt;div class=&quot;seg&quot; id=&quot;tfAlignSeg&quot;&gt;
            &lt;button class=&quot;seg-opt on&quot; data-val=&quot;left&quot;&gt;≡&lt;/button&gt;
            &lt;button class=&quot;seg-opt&quot; data-val=&quot;center&quot;&gt;≣&lt;/button&gt;
            &lt;button class=&quot;seg-opt&quot; data-val=&quot;right&quot;&gt;≡&lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div data-pane=&quot;detalhes&quot;&gt;
          &lt;div class=&quot;text-float-grid2&quot;&gt;
            &lt;input class=&quot;field-input&quot; id=&quot;tfLineHeight&quot; type=&quot;number&quot; min=&quot;0.6&quot; max=&quot;4&quot; step=&quot;0.1&quot; placeholder=&quot;Entrelinha&quot;&gt;
            &lt;input class=&quot;field-input&quot; id=&quot;tfLetterSpacing&quot; type=&quot;number&quot; min=&quot;-50&quot; max=&quot;200&quot; step=&quot;1&quot; placeholder=&quot;Espaçamento&quot;&gt;
          &lt;/div&gt;
          &lt;div class=&quot;text-float-grid2&quot;&gt;
            &lt;select class=&quot;field-input&quot; id=&quot;tfWeight&quot;&gt;&lt;option value=&quot;300&quot;&gt;Light&lt;/option&gt;&lt;option value=&quot;400&quot;&gt;Regular&lt;/option&gt;&lt;option value=&quot;500&quot;&gt;Medium&lt;/option&gt;&lt;option value=&quot;600&quot;&gt;SemiBold&lt;/option&gt;&lt;option value=&quot;700&quot;&gt;Bold&lt;/option&gt;&lt;/select&gt;
            &lt;select class=&quot;field-input&quot; id=&quot;tfStyle&quot;&gt;&lt;option value=&quot;normal&quot;&gt;Normal&lt;/option&gt;&lt;option value=&quot;italic&quot;&gt;Itálico&lt;/option&gt;&lt;/select&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div data-pane=&quot;variavel&quot;&gt;
          &lt;div class=&quot;text-float-grid2&quot;&gt;
            &lt;button class=&quot;tbtn&quot; id=&quot;tfUnderline&quot; style=&quot;justify-content:center&quot;&gt;Sublinhado&lt;/button&gt;
            &lt;button class=&quot;tbtn&quot; id=&quot;tfStrike&quot; style=&quot;justify-content:center&quot;&gt;Riscado&lt;/button&gt;
          &lt;/div&gt;
          &lt;div class=&quot;text-float-grid2&quot;&gt;
            &lt;button class=&quot;tbtn&quot; id=&quot;tfUppercase&quot; style=&quot;justify-content:center&quot;&gt;MAIÚSCULAS&lt;/button&gt;
            &lt;button class=&quot;tbtn&quot; id=&quot;tfLowercase&quot; style=&quot;justify-content:center&quot;&gt;minúsculas&lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;

    &lt;div class=&quot;hint-bar&quot;&gt;
      &lt;span class=&quot;hint-key&quot;&gt;Espaço&lt;/span&gt;&lt;span class=&quot;hint-sep&quot;&gt;pan&lt;/span&gt;
      &lt;span class=&quot;hint-key&quot;&gt;Scroll&lt;/span&gt;&lt;span class=&quot;hint-sep&quot;&gt;zoom&lt;/span&gt;
      &lt;span class=&quot;hint-key&quot;&gt;Del&lt;/span&gt;&lt;span class=&quot;hint-sep&quot;&gt;apagar&lt;/span&gt;
      &lt;span class=&quot;hint-key&quot;&gt;Ctrl+Z&lt;/span&gt;&lt;span class=&quot;hint-sep&quot;&gt;undo&lt;/span&gt;
    &lt;/div&gt;
  &lt;/main&gt;

  &lt;!-- ═══ RIGHT PANEL ════════════════════════════════════ --&gt;
  &lt;aside class=&quot;panel right&quot;&gt;
    &lt;div class=&quot;panel-body&quot;&gt;
      &lt;div class=&quot;panel-tabs&quot; id=&quot;propTabs&quot;&gt;
        &lt;button class=&quot;panel-tab active&quot; data-tab=&quot;cor&quot;&gt;Cor&lt;/button&gt;
                &lt;button class=&quot;panel-tab&quot; data-tab=&quot;tracado&quot;&gt;Traçado&lt;/button&gt;
        &lt;button class=&quot;panel-tab&quot; data-tab=&quot;aparencia&quot;&gt;Aparência&lt;/button&gt;
      &lt;/div&gt;
      &lt;div data-tab-panel=&quot;cor&quot;&gt;

      &lt;!-- Selection info --&gt;
      &lt;div class=&quot;panel-section&quot;&gt;
        &lt;div class=&quot;panel-section-label&quot;&gt;Seleção&lt;/div&gt;
        &lt;div id=&quot;selInfo&quot; style=&quot;font-size:11px;font-family:'JetBrains Mono', ui-monospace, monospace;color:var(--ink3);padding:4px 0&quot;&gt;
          Nada selecionado
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class=&quot;sep&quot;&gt;&lt;/div&gt;

      &lt;!-- Transform --&gt;
      &lt;div class=&quot;panel-section&quot; id=&quot;propTransform&quot;&gt;
        &lt;div class=&quot;panel-section-label&quot;&gt;Transformação&lt;/div&gt;
        &lt;div class=&quot;prop-grid2 prop-row&quot;&gt;
          &lt;div class=&quot;field-item&quot;&gt;&lt;div class=&quot;field-label&quot;&gt;X&lt;/div&gt;&lt;input class=&quot;field-input&quot; id=&quot;pX&quot; type=&quot;number&quot; step=&quot;1&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;field-item&quot;&gt;&lt;div class=&quot;field-label&quot;&gt;Y&lt;/div&gt;&lt;input class=&quot;field-input&quot; id=&quot;pY&quot; type=&quot;number&quot; step=&quot;1&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;prop-grid2 prop-row&quot;&gt;
          &lt;div class=&quot;field-item&quot;&gt;&lt;div class=&quot;field-label&quot;&gt;W&lt;/div&gt;&lt;input class=&quot;field-input&quot; id=&quot;pW&quot; type=&quot;number&quot; step=&quot;1&quot; min=&quot;1&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;field-item&quot;&gt;&lt;div class=&quot;field-label&quot;&gt;H&lt;/div&gt;&lt;input class=&quot;field-input&quot; id=&quot;pH&quot; type=&quot;number&quot; step=&quot;1&quot; min=&quot;1&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;prop-grid2 prop-row&quot;&gt;
          &lt;div class=&quot;field-item&quot;&gt;&lt;div class=&quot;field-label&quot;&gt;Rot°&lt;/div&gt;&lt;input class=&quot;field-input&quot; id=&quot;pR&quot; type=&quot;number&quot; step=&quot;1&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;field-item&quot;&gt;&lt;div class=&quot;field-label&quot;&gt;Transp.&lt;/div&gt;&lt;input class=&quot;field-input&quot; id=&quot;pO&quot; type=&quot;range&quot; min=&quot;0&quot; max=&quot;1&quot; step=&quot;0.01&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;prop-row&quot;&gt;
          &lt;div class=&quot;field-item&quot;&gt;
            &lt;div class=&quot;field-label&quot;&gt;Blend mode&lt;/div&gt;
            &lt;select class=&quot;field-input&quot; id=&quot;pBlend&quot; style=&quot;height:32px&quot;&gt;
              &lt;option value=&quot;source-over&quot;&gt;Normal&lt;/option&gt;
              &lt;option value=&quot;multiply&quot;&gt;Multiply&lt;/option&gt;
              &lt;option value=&quot;screen&quot;&gt;Screen&lt;/option&gt;
              &lt;option value=&quot;overlay&quot;&gt;Overlay&lt;/option&gt;
              &lt;option value=&quot;darken&quot;&gt;Darken&lt;/option&gt;
              &lt;option value=&quot;lighten&quot;&gt;Lighten&lt;/option&gt;
              &lt;option value=&quot;color-dodge&quot;&gt;Color Dodge&lt;/option&gt;
              &lt;option value=&quot;color-burn&quot;&gt;Color Burn&lt;/option&gt;
              &lt;option value=&quot;difference&quot;&gt;Difference&lt;/option&gt;
              &lt;option value=&quot;exclusion&quot;&gt;Exclusion&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class=&quot;sep&quot;&gt;&lt;/div&gt;

      &lt;div class=&quot;sep&quot;&gt;&lt;/div&gt;

      &lt;!-- Style --&gt;
      &lt;div class=&quot;panel-section&quot; id=&quot;propStyle&quot;&gt;
        &lt;div class=&quot;panel-section-label&quot;&gt;Estilo&lt;/div&gt;
        &lt;div class=&quot;prop-grid2 prop-row&quot;&gt;
          &lt;div class=&quot;field-item&quot;&gt;&lt;div class=&quot;field-label&quot;&gt;Fill&lt;/div&gt;&lt;input class=&quot;field-input&quot; id=&quot;pFill&quot; type=&quot;color&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;field-item&quot;&gt;&lt;div class=&quot;field-label&quot;&gt;Stroke&lt;/div&gt;&lt;input class=&quot;field-input&quot; id=&quot;pStroke&quot; type=&quot;color&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;prop-grid2 prop-row&quot;&gt;
          &lt;div class=&quot;field-item&quot;&gt;&lt;div class=&quot;field-label&quot;&gt;Espessura&lt;/div&gt;&lt;input class=&quot;field-input&quot; id=&quot;pStrokeW&quot; type=&quot;number&quot; step=&quot;1&quot; min=&quot;0&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;field-item&quot;&gt;&lt;div class=&quot;field-label&quot;&gt;Raio&lt;/div&gt;&lt;input class=&quot;field-input&quot; id=&quot;pRx&quot; type=&quot;number&quot; step=&quot;1&quot; min=&quot;0&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div class=&quot;sep&quot;&gt;&lt;/div&gt;

      &lt;!-- Text --&gt;
      &lt;div class=&quot;panel-section&quot; id=&quot;propText&quot;&gt;
        &lt;div class=&quot;panel-section-label&quot; style=&quot;display:flex;align-items:center;justify-content:space-between&quot;&gt;Texto &lt;button class=&quot;tbtn&quot; id=&quot;btnTypographyGear&quot; title=&quot;Abrir painel de tipografia&quot; style=&quot;height:24px;padding:0 8px&quot;&gt;⚙&lt;/button&gt;&lt;/div&gt;
        &lt;div class=&quot;prop-row&quot;&gt;
          &lt;div class=&quot;field-item&quot;&gt;
            &lt;div class=&quot;field-label&quot;&gt;Fonte&lt;/div&gt;
            &lt;select class=&quot;field-input&quot; id=&quot;pFont&quot; style=&quot;height:32px&quot;&gt;
              &lt;option value=&quot;Outfit&quot;&gt;Outfit&lt;/option&gt;
              &lt;option value=&quot;Syne&quot;&gt;Syne&lt;/option&gt;
              &lt;option value=&quot;Sora&quot;&gt;Sora&lt;/option&gt;
              &lt;option value=&quot;DM Sans&quot;&gt;DM Sans&lt;/option&gt;
              &lt;option value=&quot;Nunito&quot;&gt;Nunito&lt;/option&gt;
              &lt;option value=&quot;Poppins&quot;&gt;Poppins&lt;/option&gt;
              &lt;option value=&quot;Montserrat&quot;&gt;Montserrat&lt;/option&gt;
              &lt;option value=&quot;IBM Plex Sans&quot;&gt;IBM Plex Sans&lt;/option&gt;
              &lt;option value=&quot;Raleway&quot;&gt;Raleway&lt;/option&gt;
              &lt;option value=&quot;Manrope&quot;&gt;Manrope&lt;/option&gt;
              &lt;option value=&quot;Inter&quot;&gt;Inter&lt;/option&gt;
              &lt;option value=&quot;Roboto&quot;&gt;Roboto&lt;/option&gt;
            &lt;/select&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;prop-grid2 prop-row&quot;&gt;
          &lt;div class=&quot;field-item&quot;&gt;
            &lt;div class=&quot;field-label&quot;&gt;Google Font&lt;/div&gt;
            &lt;input class=&quot;field-input&quot; id=&quot;pGoogleFont&quot; placeholder=&quot;Ex: Playfair Display&quot;&gt;
          &lt;/div&gt;
          &lt;button class=&quot;tbtn&quot; id=&quot;btnLoadFont&quot; style=&quot;justify-content:center;height:32px;align-self:end&quot;&gt;Carregar&lt;/button&gt;
        &lt;/div&gt;
        &lt;div class=&quot;prop-grid2 prop-row&quot;&gt;
          &lt;div class=&quot;field-item&quot;&gt;&lt;div class=&quot;field-label&quot;&gt;Tamanho&lt;/div&gt;&lt;input class=&quot;field-input&quot; id=&quot;pFontSize&quot; type=&quot;number&quot; step=&quot;1&quot; min=&quot;6&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;field-item&quot;&gt;&lt;div class=&quot;field-label&quot;&gt;Cor&lt;/div&gt;&lt;input class=&quot;field-input&quot; id=&quot;pTextColor&quot; type=&quot;color&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;prop-row&quot;&gt;
          &lt;div class=&quot;field-label&quot; style=&quot;margin-bottom:6px&quot;&gt;Alinhamento&lt;/div&gt;
          &lt;div class=&quot;seg&quot; id=&quot;alignSeg&quot;&gt;
            &lt;button class=&quot;seg-opt on&quot; data-val=&quot;left&quot;&gt;≡&lt;/button&gt;
            &lt;button class=&quot;seg-opt&quot; data-val=&quot;center&quot;&gt;≣&lt;/button&gt;
            &lt;button class=&quot;seg-opt&quot; data-val=&quot;right&quot;&gt;≡&lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div data-tab-panel=&quot;tracado&quot; style=&quot;display:none&quot;&gt;
        &lt;div class=&quot;panel-section&quot;&gt;
          &lt;div class=&quot;panel-section-label&quot;&gt;Traçado&lt;/div&gt;
          &lt;div class=&quot;rp-row&quot;&gt;
            &lt;span class=&quot;rp-chip&quot;&gt;Estilo&lt;/span&gt;
            &lt;button class=&quot;rp-icon-btn active&quot; data-stroke-style=&quot;solid&quot;&gt;Sólido&lt;/button&gt;
            &lt;button class=&quot;rp-icon-btn&quot; data-stroke-style=&quot;dash&quot;&gt;Tracejado&lt;/button&gt;
            &lt;button class=&quot;rp-icon-btn&quot; data-stroke-style=&quot;dot&quot;&gt;Pontilhado&lt;/button&gt;
          &lt;/div&gt;
          &lt;div class=&quot;prop-grid2 prop-row&quot;&gt;
            &lt;div class=&quot;field-item&quot;&gt;&lt;div class=&quot;field-label&quot;&gt;Cor de traço&lt;/div&gt;&lt;input class=&quot;field-input&quot; id=&quot;pStroke2&quot; type=&quot;color&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;field-item&quot;&gt;&lt;div class=&quot;field-label&quot;&gt;Espessura&lt;/div&gt;&lt;input class=&quot;field-input&quot; id=&quot;pStrokeW2&quot; type=&quot;number&quot; step=&quot;1&quot; min=&quot;0&quot;&gt;&lt;/div&gt;
          &lt;/div&gt;
          &lt;div class=&quot;rp-row&quot;&gt;
            &lt;input class=&quot;rp-stroke-range rp-grow&quot; id=&quot;pStrokeWRange2&quot; type=&quot;range&quot; min=&quot;0&quot; max=&quot;120&quot; step=&quot;1&quot;&gt;
          &lt;/div&gt;
          &lt;div class=&quot;rp-row&quot;&gt;
            &lt;span class=&quot;rp-chip&quot;&gt;Tampa&lt;/span&gt;
            &lt;button class=&quot;rp-icon-btn active&quot; data-stroke-cap=&quot;butt&quot;&gt;▮&lt;/button&gt;
            &lt;button class=&quot;rp-icon-btn&quot; data-stroke-cap=&quot;round&quot;&gt;◖&lt;/button&gt;
            &lt;button class=&quot;rp-icon-btn&quot; data-stroke-cap=&quot;square&quot;&gt;▭&lt;/button&gt;
            &lt;span class=&quot;rp-chip&quot; style=&quot;margin-left:auto&quot;&gt;Mitra&lt;/span&gt;
            &lt;input class=&quot;field-input&quot; id=&quot;pMiter2&quot; type=&quot;number&quot; min=&quot;1&quot; max=&quot;10&quot; step=&quot;0.5&quot; value=&quot;1.5&quot; style=&quot;width:64px&quot;&gt;
          &lt;/div&gt;
          &lt;div class=&quot;rp-row&quot;&gt;
            &lt;span class=&quot;rp-chip&quot;&gt;Unir&lt;/span&gt;
            &lt;button class=&quot;rp-icon-btn active&quot; data-stroke-join=&quot;miter&quot;&gt;┌&lt;/button&gt;
            &lt;button class=&quot;rp-icon-btn&quot; data-stroke-join=&quot;round&quot;&gt;◜&lt;/button&gt;
            &lt;button class=&quot;rp-icon-btn&quot; data-stroke-join=&quot;bevel&quot;&gt;⌟&lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;div data-tab-panel=&quot;aparencia&quot; style=&quot;display:none&quot;&gt;
        &lt;div class=&quot;panel-section&quot;&gt;
          &lt;div class=&quot;panel-section-label&quot;&gt;Aparência&lt;/div&gt;
          &lt;div class=&quot;prop-grid2 prop-row&quot;&gt;
            &lt;div class=&quot;field-item&quot;&gt;
              &lt;div class=&quot;field-label&quot;&gt;Modo de mesclagem&lt;/div&gt;
              &lt;select class=&quot;field-input&quot; id=&quot;pBlend2&quot; style=&quot;height:32px&quot;&gt;
                &lt;option value=&quot;source-over&quot;&gt;Normal&lt;/option&gt;
                &lt;option value=&quot;multiply&quot;&gt;Multiply&lt;/option&gt;
                &lt;option value=&quot;screen&quot;&gt;Screen&lt;/option&gt;
                &lt;option value=&quot;overlay&quot;&gt;Overlay&lt;/option&gt;
                &lt;option value=&quot;darken&quot;&gt;Darken&lt;/option&gt;
                &lt;option value=&quot;lighten&quot;&gt;Lighten&lt;/option&gt;
              &lt;/select&gt;
            &lt;/div&gt;
            &lt;div class=&quot;field-item&quot;&gt;
              &lt;div class=&quot;field-label&quot;&gt;Opacidade&lt;/div&gt;
              &lt;input class=&quot;field-input&quot; id=&quot;pOpacity2&quot; type=&quot;number&quot; min=&quot;0&quot; max=&quot;100&quot; step=&quot;1&quot; value=&quot;100&quot;&gt;
            &lt;/div&gt;
          &lt;/div&gt;
          &lt;div class=&quot;rp-row&quot;&gt;
            &lt;input class=&quot;rp-stroke-range rp-grow&quot; id=&quot;pOpacityRange2&quot; type=&quot;range&quot; min=&quot;0&quot; max=&quot;100&quot; step=&quot;1&quot; value=&quot;100&quot;&gt;
          &lt;/div&gt;
          &lt;div class=&quot;rp-row&quot;&gt;
            &lt;button class=&quot;rp-icon-btn&quot; title=&quot;Iniciar&quot;&gt;Início&lt;/button&gt;
            &lt;button class=&quot;rp-icon-btn&quot; title=&quot;Fim&quot;&gt;Fim&lt;/button&gt;
            &lt;button class=&quot;rp-icon-btn&quot; title=&quot;Inverter&quot;&gt;↕&lt;/button&gt;
            &lt;button class=&quot;rp-icon-btn&quot; title=&quot;Limpar estilo&quot;&gt;🗑&lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

    &lt;/div&gt;
  &lt;/aside&gt;

&lt;/div&gt;&lt;!-- .app --&gt;


&lt;div class=&quot;ctx-pop&quot; id=&quot;canvasCtx&quot;&gt;
  &lt;div class=&quot;ctx-pop-item&quot; data-act=&quot;paste&quot;&gt;&lt;span&gt;Colar&lt;/span&gt;&lt;span&gt;Ctrl+V&lt;/span&gt;&lt;/div&gt;
  &lt;div class=&quot;ctx-pop-item&quot; data-act=&quot;group&quot;&gt;&lt;span&gt;Agrupar&lt;/span&gt;&lt;span&gt;Ctrl+G&lt;/span&gt;&lt;/div&gt;
  &lt;div class=&quot;ctx-pop-item&quot; data-act=&quot;ungroup&quot;&gt;&lt;span&gt;Desagrupar&lt;/span&gt;&lt;span&gt;Ctrl+Shift+G&lt;/span&gt;&lt;/div&gt;
  &lt;div class=&quot;ctx-pop-sep&quot;&gt;&lt;/div&gt;
  &lt;div class=&quot;ctx-pop-item&quot; data-act=&quot;front&quot;&gt;&lt;span&gt;Trazer para frente&lt;/span&gt;&lt;span&gt;]&lt;/span&gt;&lt;/div&gt;
  &lt;div class=&quot;ctx-pop-item&quot; data-act=&quot;back&quot;&gt;&lt;span&gt;Enviar para trás&lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;/div&gt;
  &lt;div class=&quot;ctx-pop-sep&quot;&gt;&lt;/div&gt;
  &lt;div class=&quot;ctx-pop-item&quot; data-act=&quot;duplicate&quot;&gt;&lt;span&gt;Duplicar&lt;/span&gt;&lt;span&gt;Ctrl+D&lt;/span&gt;&lt;/div&gt;
  &lt;div class=&quot;ctx-pop-item&quot; data-act=&quot;delete&quot;&gt;&lt;span&gt;Excluir&lt;/span&gt;&lt;span&gt;Del&lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;!-- ═══ MODAL ════════════════════════════════════════════ --&gt;
&lt;div class=&quot;modal-bg&quot; id=&quot;modalBg&quot;&gt;
  &lt;div class=&quot;modal-box&quot;&gt;
    &lt;div class=&quot;modal-head&quot;&gt;
      &lt;div class=&quot;modal-title&quot; id=&quot;modalTitle&quot;&gt;Modal&lt;/div&gt;
      &lt;button class=&quot;tbtn&quot; id=&quot;btnCloseModal&quot;&gt;✕&lt;/button&gt;
    &lt;/div&gt;
    &lt;div class=&quot;modal-body&quot; id=&quot;modalBody&quot;&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt;
if(!window.fabric){
  document.body.innerHTML = "&lt;div style=\"min-height:100vh;display:grid;place-items:center;background:#0e0e11;color:#f0eff4;font-family:Outfit,system-ui;padding:24px;text-align:center\"&gt;&lt;div&gt;&lt;b&gt;Editor indisponível&lt;/b&gt;&lt;br/&gt;&lt;span style=\"opacity:.75\"&gt;Não foi possível carregar o Fabric.js. Verifique a conexão e tente novamente.&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;";
  throw new Error("Fabric.js failed to load");
}

const textBaselineDescriptor = Object.getOwnPropertyDescriptor(CanvasRenderingContext2D.prototype, 'textBaseline');
if (textBaselineDescriptor?.set &amp;&amp; textBaselineDescriptor.configurable) {
  Object.defineProperty(CanvasRenderingContext2D.prototype, 'textBaseline', {
    configurable: true,
    enumerable: textBaselineDescriptor.enumerable,
    get: textBaselineDescriptor.get,
    set(value) {
      const normalized = value === 'alphabetical' ? 'alphabetic' : value;
      textBaselineDescriptor.set.call(this, normalized);
    }
  });
}

const $ = id =&gt; document.getElementById(id);
const clamp = (n,a,b) =&gt; Math.max(a, Math.min(b, n));

// ─── Fabric canvas ───────────────────────────────────────
const fabricHost = $('fabricCanvas');
const canvasEl = document.createElement('canvas');
canvasEl.id = 'c';
fabricHost.appendChild(canvasEl);

const canvas = new fabric.Canvas('c', {
  preserveObjectStacking: true,
  selection: true,
  fireRightClick: true,
  stopContextMenu: true
});

const stageEl = $('canvasStage');

// Document state
let docW = 1200, docH = 750;
let deskBg = '#0f1626';
let zoom = 1;
let isPanning = false, isSpaceDown = false;
let lastX = 0, lastY = 0;
let artboardMode = false;
let activeTool = 'select';
let textDragStart = null;
let textDragMoved = false;

// Artboard objects
let artboard = null, artboardShadow = null, bleedRect = null, safeRect = null;
const artboards = [];
let activeArtboardId = null;
const ART_GAP = 120;
const GUIDES = { bleed: 0, safe: 24 };

// ─── Canvas sizing ──────────────────────────────────────
function resizeCanvasToViewport() {
  const r = stageEl.getBoundingClientRect();
  const w = Math.floor(r.width);
  const h = Math.floor(r.height);
  if (w &gt; 10 &amp;&amp; h &gt; 10) {
    fabricHost.style.width  = w + 'px';
    fabricHost.style.height = h + 'px';
    canvas.setWidth(w);
    canvas.setHeight(h);
    canvas.requestRenderAll();
  }
}

// ─── Mesa (workspace bg) ────────────────────────────────
function setDeskBg(color) {
  deskBg = color;
  stageEl.style.setProperty('--desk-color', color);
  canvas.backgroundColor = 'transparent';
}

function setDeskTheme(theme) {
  const map = {
    nebula: {
      bg: `radial-gradient(ellipse 60% 50% at 25% 20%, rgba(127,90,240,.16), transparent), radial-gradient(ellipse 50% 60% at 75% 80%, rgba(44,182,125,.10), transparent), ${deskBg}`,
      dot: 'rgba(255,255,255,.08)'
    },
    clean: { bg: `${deskBg}`, dot: 'rgba(255,255,255,.06)' },
    paper: {
      bg: `linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)), ${deskBg}`,
      dot: 'rgba(0,0,0,.10)'
    },
    mint: {
      bg: `radial-gradient(circle at 15% 15%, rgba(44,182,125,.24), transparent 35%), radial-gradient(circle at 85% 80%, rgba(127,90,240,.2), transparent 35%), ${deskBg}`,
      dot: 'rgba(255,255,255,.07)'
    }
  };
  const t = map[theme] || map.nebula;
  stageEl.style.setProperty('--desk-bg', t.bg);
  stageEl.style.setProperty('--desk-dot', t.dot);
}

// ─── Artboard ────────────────────────────────────────────
function isGuide(o) {
  return artboards.some(a =&gt; o===a.board || o===a.shadow || o===a.bleed || o===a.safe);
}

function getActiveArtboard() {
  return artboards.find(a =&gt; a.id === activeArtboardId) || null;
}

function syncActiveArtboardRefs() {
  const current = getActiveArtboard();
  if (!current) return;
  artboard = current.board;
  artboardShadow = current.shadow;
  bleedRect = current.bleed;
  safeRect = current.safe;
  docW = current.w;
  docH = current.h;
  $('docW').value = docW;
  $('docH').value = docH;
}

function createArtboard(left = -docW/2, top = -docH/2, w = docW, h = docH) {
  const id = 'ab_' + Math.random().toString(36).slice(2, 9);
  const shadow = new fabric.Rect({
    left:left+8, top:top+12, width:w, height:h,
    fill:'rgba(0,0,0,.28)', rx:2, ry:2,
    selectable:false, evented:false, excludeFromExport:true,
    shadow: new fabric.Shadow({color:'rgba(0,0,0,.6)', blur:30, offsetX:0, offsetY:18})
  });
  const board = new fabric.Rect({
    left, top, width:w, height:h,
    fill:'#ffffff', stroke:'rgba(0,0,0,.15)', strokeWidth:1,
    rx:2, ry:2, selectable:false, evented:false, excludeFromExport:false
  });
  const bleed = new fabric.Rect({
    left:left-GUIDES.bleed, top:top-GUIDES.bleed, width:w+2*GUIDES.bleed, height:h+2*GUIDES.bleed,
    fill:'transparent', stroke:'rgba(241,58,161,.5)', strokeDashArray:[6,6], strokeWidth:1,
    selectable:false, evented:false, excludeFromExport:true, opacity: GUIDES.bleed &gt; 0 ? 1 : 0
  });
  const safe = new fabric.Rect({
    left:left+GUIDES.safe, top:top+GUIDES.safe, width:w-2*GUIDES.safe, height:h-2*GUIDES.safe,
    fill:'transparent', stroke:'rgba(59,109,243,.5)', strokeDashArray:[6,6], strokeWidth:1,
    selectable:false, evented:false, excludeFromExport:true
  });
  const bundle = { id, w, h, board, shadow, bleed, safe };
  artboards.push(bundle);
  canvas.add(shadow, board, bleed, safe);
  activeArtboardId = id;
  syncActiveArtboardRefs();
  orderArtboard();
  return bundle;
}

function ensureArtboard() {
  if (artboards.length) return;
  createArtboard();
  positionArtboard();
}

function addAdjacentArtboard(dir) {
  const current = getActiveArtboard();
  if (!current) return;
  const left = current.board.left;
  const top = current.board.top;
  let nextLeft = left;
  let nextTop = top;
  if (dir === 'right') nextLeft = left + current.w + ART_GAP;
  if (dir === 'left') nextLeft = left - current.w - ART_GAP;
  if (dir === 'bottom') nextTop = top + current.h + ART_GAP;
  if (dir === 'top') nextTop = top - current.h - ART_GAP;
  createArtboard(nextLeft, nextTop, current.w, current.h);
  fitToArtboard();
  updateArtboardPlusUI();
}

function orderArtboard() {
  artboards.forEach(a =&gt; {
    [a.shadow, a.board, a.bleed, a.safe].forEach(o =&gt; {
      if(o) { canvas.sendToBack(o); canvas.bringToFront(o); }
    });
  });
}

function positionArtboard() {
  const current = getActiveArtboard();
  if (!current) return;
  current.board.set({ width:docW, height:docH });
  current.shadow.set({ left:current.board.left+8, top:current.board.top+12, width:docW, height:docH });
  current.bleed.set({ left:current.board.left-GUIDES.bleed, top:current.board.top-GUIDES.bleed, width:docW+2*GUIDES.bleed, height:docH+2*GUIDES.bleed });
  current.safe.set({ left:current.board.left+GUIDES.safe, top:current.board.top+GUIDES.safe, width:docW-2*GUIDES.safe, height:docH-2*GUIDES.safe });
  current.w = docW;
  current.h = docH;
  syncActiveArtboardRefs();
  canvas.requestRenderAll();
  updateArtboardPlusUI();
}

function fitToArtboard() {
  if (!artboard) return;
  const pad = 100;
  const cw = canvas.getWidth(), ch = canvas.getHeight();
  const newZoom = clamp(Math.min((cw-pad)/docW, (ch-pad)/docH), 0.05, 6);
  const artCx = artboard.left + docW/2;
  const artCy = artboard.top + docH/2;
  canvas.setViewportTransform([newZoom, 0, 0, newZoom, cw/2 - artCx*newZoom, ch/2 - artCy*newZoom]);
  zoom = newZoom;
  updateZoomLabel();
  updateArtboardPlusUI();
}

function setArtboardSize(w, h) {
  docW = clamp(w, 200, 5000);
  docH = clamp(h, 200, 5000);
  $('docW').value = docW;
  $('docH').value = docH;
  if (!artboard) ensureArtboard();
  positionArtboard();
  fitToArtboard();
}

function updateArtboardPlusUI() {
  const ui = $('artboardPlusUI');
  if (!ui) return;
  if (!artboardMode || !artboard) {
    ui.style.display = 'none';
    return;
  }
  const vpt = canvas.viewportTransform || [1,0,0,1,0,0];
  const x1 = artboard.left * vpt[0] + vpt[4];
  const y1 = artboard.top * vpt[3] + vpt[5];
  const x2 = (artboard.left + docW) * vpt[0] + vpt[4];
  const y2 = (artboard.top + docH) * vpt[3] + vpt[5];
  const m = 16;
  $('btnAddArtTop').style.left = ((x1+x2)/2 - 14) + 'px';
  $('btnAddArtTop').style.top = (y1 - m - 14) + 'px';
  $('btnAddArtBottom').style.left = ((x1+x2)/2 - 14) + 'px';
  $('btnAddArtBottom').style.top = (y2 + m - 14) + 'px';
  $('btnAddArtLeft').style.left = (x1 - m - 14) + 'px';
  $('btnAddArtLeft').style.top = ((y1+y2)/2 - 14) + 'px';
  $('btnAddArtRight').style.left = (x2 + m - 14) + 'px';
  $('btnAddArtRight').style.top = ((y1+y2)/2 - 14) + 'px';
  ui.style.display = 'block';
}

function updateZoomLabel() {
  const pct = Math.round(zoom*100) + '%';
  const el = $('zoomLabel');
  if (el) el.textContent = pct;
  const top = $('zoomTopLabel');
  if (top) top.textContent = 'ZOOM ' + pct;
}

// ─── Pan / Zoom ──────────────────────────────────────────
canvas.on('mouse:wheel', opt =&gt; {
  const e = opt.e; e.preventDefault(); e.stopPropagation();
  const newZoom = clamp(zoom * Math.pow(0.999, e.deltaY), 0.05, 10);
  canvas.zoomToPoint(new fabric.Point(e.offsetX, e.offsetY), newZoom);
  zoom = newZoom; updateZoomLabel();
  updateArtboardPlusUI();
});

canvas.on('mouse:down', opt =&gt; {
  const e = opt.e;
  if (e.button === 1 || isSpaceDown) {
    isPanning = true; canvas.setCursor('grab');
    lastX = e.clientX; lastY = e.clientY;
    opt.e.preventDefault();
    return;
  }

  if (activeTool === 'bezier') {
    const pointer = canvas.getPointer(e);
    if (vectorToolState.mode !== 'creating') startBezierCreation();
    addBezierPoint(pointer, e);
    opt.e.preventDefault();
    return;
  }

  if (activeTool === 'text' &amp;&amp; !opt.target) {
    const p = canvas.getPointer(e);
    textDragStart = { x:p.x, y:p.y };
    textDragMoved = false;
    opt.e.preventDefault();
  }
});

canvas.on('mouse:move', opt =&gt; {
  if (isPanning) {
    const e = opt.e;
    const vpt = canvas.viewportTransform;
    vpt[4] += e.clientX - lastX;
    vpt[5] += e.clientY - lastY;
    canvas.setViewportTransform(vpt);
    lastX = e.clientX; lastY = e.clientY;
    updateArtboardPlusUI();
    return;
  }

  if (activeTool === 'bezier' &amp;&amp; vectorToolState.mode === 'creating') {
    const pointer = canvas.getPointer(opt.e);
    if (vectorToolState.dragPointIndex &gt;= 0 &amp;&amp; (opt.e.buttons &amp; 1)) {
      updateDraggedCreatePoint(pointer, opt.e);
    } else {
      updateBezierCreationPreview(pointer);
    }
    return;
  }

  if (vectorToolState.segmentDrag &amp;&amp; bezierEditor.enabled &amp;&amp; bezierEditor.path) {
    const pointer = canvas.getPointer(opt.e);
    const drag = vectorToolState.segmentDrag;
    const dx = pointer.x - drag.last.x;
    const dy = pointer.y - drag.last.y;
    drag.last = pointer;
    const m = ensurePathVectorModel(bezierEditor.path);
    if (!m) return;
    const i0 = drag.seg;
    const i1 = (i0 + 1) % m.points.length;
    const p0 = m.points[i0], p1 = m.points[i1];
    p0.outX += dx; p0.outY += dy;
    p1.inX += dx; p1.inY += dy;
    applyVectorModelToPath(bezierEditor.path);
    refreshBezierEditorControls();
    return;
  }

  if (activeTool === 'text' &amp;&amp; textDragStart) {
    const p = canvas.getPointer(opt.e);
    textDragMoved = Math.hypot(p.x - textDragStart.x, p.y - textDragStart.y) &gt; 8;
  }
});

canvas.on('mouse:up', opt =&gt; {
  if (isPanning) { isPanning = false; canvas.setCursor(activeTool==='text' ? 'text' : 'default'); }

  if (activeTool === 'bezier' &amp;&amp; vectorToolState.mode === 'creating') {
    vectorToolState.dragPointIndex = -1;
  }

  if (vectorToolState.segmentDrag) {
    vectorToolState.segmentDrag = null;
    snapshot();
  }

  if (activeTool === 'text' &amp;&amp; textDragStart) {
    const pointer = canvas.getPointer(opt.e);
    const dx = pointer.x - textDragStart.x;
    const dy = pointer.y - textDragStart.y;
    if (!textDragMoved || Math.hypot(dx, dy) &lt; 8) {
      addArtTextAt(pointer.x, pointer.y);
    } else {
      addTextBoxAt(Math.min(textDragStart.x, pointer.x), Math.min(textDragStart.y, pointer.y), Math.abs(dx), Math.abs(dy));
    }
    textDragStart = null;
    textDragMoved = false;
    setActiveTool('select');
  }
});
canvas.on('mouse:down', opt =&gt; {
  const target = opt.target;
  if (!target) return;
  const ab = artboards.find(a =&gt; a.board === target || a.shadow === target || a.bleed === target || a.safe === target);
  if (!ab) return;
  activeArtboardId = ab.id;
  syncActiveArtboardRefs();
  updateArtboardPlusUI();
  setStatus('Prancheta ativa selecionada');
});


canvas.on('mouse:down', opt =&gt; {
  if (activeTool !== 'direct-select') return;
  const target = opt.target;
  const pointer = canvas.getPointer(opt.e);
  if (!target) { if (bezierEditor.enabled) finalizeBezierEditor(); return; }
  if (pathIsBezierEditable(target)) {
    canvas.setActiveObject(target);
    attachBezierEditor(target);
    const seg = getNearestBezierSegment(target, pointer);
    if (seg &gt;= 0 &amp;&amp; !opt.e.altKey) {
      vectorToolState.segmentDrag = { seg, last:pointer };
      vectorToolState.mode = 'transforming';
    }
    return;
  }
  if (target.isBezierEditorControl) return;
});


canvas.on('mouse:dblclick', opt =&gt; {
  const target = opt.target;
  const pointer = canvas.getPointer(opt.e);
  if (!target) return;
  if (activeTool === 'bezier' &amp;&amp; vectorToolState.mode === 'creating') {
    finishBezierCreation({toEditing:true});
    setActiveTool('direct-select');
    return;
  }
  if (pathIsBezierEditable(target)) {
    if (activeTool !== 'direct-select') setActiveTool('direct-select');
    if (bezierEditor.enabled &amp;&amp; bezierEditor.path === target) {
      const seg = getNearestBezierSegment(target, pointer);
      if (seg &gt;= 0) insertPointOnSegment(target, seg);
    } else {
      attachBezierEditor(target);
    }
  }
});

window.addEventListener('keydown', e =&gt; {
  if (activeTool === 'bezier' &amp;&amp; vectorToolState.mode === 'creating') {
    if (e.key === 'Enter') {
      e.preventDefault();
      const path = finishBezierCreation({toEditing:true});
      if (path) setActiveTool('direct-select');
      return;
    }
    if (e.key === 'Escape') {
      e.preventDefault();
      cancelBezierCreationStep();
      return;
    }
  }
  if (activeTool === 'direct-select' &amp;&amp; e.key === 'Escape' &amp;&amp; bezierEditor.enabled) {
    e.preventDefault();
    finalizeBezierEditor();
    setActiveTool('select');
    return;
  }
  if (e.code === 'Space' &amp;&amp; !e.target.matches('input,textarea,select') &amp;&amp; !isSpaceDown) {
    isSpaceDown = true; canvas.setCursor('grab'); e.preventDefault();
  }
  if ((e.metaKey||e.ctrlKey) &amp;&amp; e.key === 'z') { e.preventDefault(); undo(); }
  if ((e.metaKey||e.ctrlKey) &amp;&amp; e.key === 'y') { e.preventDefault(); redo(); }
  if ((e.metaKey||e.ctrlKey) &amp;&amp; e.key === 'd') { e.preventDefault(); duplicate(); }
  if ((e.metaKey||e.ctrlKey) &amp;&amp; !e.shiftKey &amp;&amp; e.key.toLowerCase()==='g') { e.preventDefault(); groupSelection(); }
  if ((e.metaKey||e.ctrlKey) &amp;&amp; e.shiftKey &amp;&amp; e.key.toLowerCase()==='g') { e.preventDefault(); ungroupSelection(); }
  if ((e.metaKey||e.ctrlKey) &amp;&amp; e.shiftKey &amp;&amp; e.key === ']') { e.preventDefault(); bringForwardSelection(); }
  if ((e.metaKey||e.ctrlKey) &amp;&amp; e.shiftKey &amp;&amp; e.key === '[') { e.preventDefault(); sendBackwardSelection(); }
  if ((e.key === 'Delete' || e.key === 'Backspace') &amp;&amp; !e.target.matches('input,textarea')) { del(); }
}, {passive:false});

window.addEventListener('keyup', e =&gt; {
  if (e.code === 'Space') { isSpaceDown = false; canvas.setCursor('default'); }
});

// ─── Status text ─────────────────────────────────────────
function setStatus(txt) {
  const el = $('statusText'); if (el) el.textContent = txt;
}

// ─── Add objects ─────────────────────────────────────────
function addArtTextAt(left, top) {
  const t = new fabric.IText('Texto artístico', {
    left, top,
    fontFamily: 'Outfit', fontSize: 42,
    fill: '#111', editable: true
  });
  canvas.add(t); canvas.setActiveObject(t); canvas.requestRenderAll();
  setStatus('Texto artístico adicionado');
}

function addTextBoxAt(left, top, width=360, height=120) {
  const t = new fabric.Textbox('Caixa de texto', {
    left, top,
    width: Math.max(120, width),
    height: Math.max(48, height),
    fontFamily: 'Outfit', fontSize: 32,
    fill: '#111', editable: true,
    textAlign: 'left'
  });
  canvas.add(t); canvas.setActiveObject(t); canvas.requestRenderAll();
  setStatus('Caixa de texto adicionada');
}

function addArtText() {
  ensureArtboard();
  addArtTextAt(artboard.left + 60, artboard.top + 60);
}

function addTextBox() {
  ensureArtboard();
  addTextBoxAt(artboard.left + 60, artboard.top + 140, 360, 120);
}

function addRect() {
  ensureArtboard();
  const r = new fabric.Rect({
    left: artboard.left + 80, top: artboard.top + 140,
    width: 260, height: 160, rx:16, ry:16,
    fill: 'rgba(59,109,243,.15)', stroke: 'rgba(0,0,0,.1)', strokeWidth: 1
  });
  canvas.add(r); canvas.setActiveObject(r); canvas.requestRenderAll();
}

function addCircle() {
  ensureArtboard();
  const c = new fabric.Circle({
    left: artboard.left + 420, top: artboard.top + 160,
    radius: 80, fill:'rgba(127,90,240,.22)', stroke:'rgba(0,0,0,.1)', strokeWidth:1
  });
  canvas.add(c); canvas.setActiveObject(c); canvas.requestRenderAll();
}

function addLine() {
  ensureArtboard();
  const l = new fabric.Line([artboard.left+80, artboard.top+docH-120, artboard.left+520, artboard.top+docH-120], {
    stroke:'rgba(0,0,0,.55)', strokeWidth:2
  });
  canvas.add(l); canvas.setActiveObject(l); canvas.requestRenderAll();
}

function addBezier() {
  setActiveTool('bezier');
  startBezierCreation();
}

// ─── Bezier tool (Figma-like states) ─────────────────────
const vectorToolState = {
  mode: 'idle', // idle | creating | editing | transforming
  points: [],
  closed: false,
  previewPath: null,
  dragPointIndex: -1,
  segmentDrag: null
};

const bezierEditor = {
  path: null,
  controls: [],
  links: [],
  enabled: false
};

const BEZIER_CREATE_HIT = 12;

function makeBezierPoint(x, y) {
  return { x, y, inX:x, inY:y, outX:x, outY:y, kind:'corner' };
}

function cloneBezierPoints(points=[]) {
  return points.map(p =&gt; ({...p}));
}

function normalizeVectorByShift(dx, dy, stepDeg=15){
  const ang = Math.atan2(dy, dx);
  const len = Math.hypot(dx, dy);
  const step = (Math.PI/180) * stepDeg;
  const a = Math.round(ang / step) * step;
  return { dx: Math.cos(a) * len, dy: Math.sin(a) * len };
}

function bezierPointsToPathData(points, closed=false){
  if (!points || points.length &lt; 2) return '';
  const segs = [`M ${points[0].x} ${points[0].y}`];
  for (let i=1;i&lt;points.length;i++) {
    const prev = points[i-1];
    const curr = points[i];
    segs.push(`C ${prev.outX} ${prev.outY}, ${curr.inX} ${curr.inY}, ${curr.x} ${curr.y}`);
  }
  if (closed &amp;&amp; points.length &gt; 2) {
    const last = points[points.length-1];
    const first = points[0];
    segs.push(`C ${last.outX} ${last.outY}, ${first.inX} ${first.inY}, ${first.x} ${first.y} Z`);
  }
  return segs.join(' ');
}

function ensureBezierPreview(){
  if (vectorToolState.previewPath) return vectorToolState.previewPath;
  const p = new fabric.Path('M 0 0', {
    fill:'',
    stroke:'rgba(127,90,240,.95)',
    strokeWidth:2.5,
    strokeLineCap:'round',
    strokeLineJoin:'round',
    selectable:false,
    evented:false,
    excludeFromExport:true
  });
  p.strokeDashArray = [8, 4];
  vectorToolState.previewPath = p;
  canvas.add(p);
  canvas.bringToFront(p);
  return p;
}

function clearBezierPreview(){
  const p = vectorToolState.previewPath;
  if (p &amp;&amp; canvas.getObjects().includes(p)) canvas.remove(p);
  vectorToolState.previewPath = null;
}

function updateBezierCreationPreview(pointer=null){
  if (vectorToolState.mode !== 'creating') return;
  const pts = cloneBezierPoints(vectorToolState.points);
  if (pointer &amp;&amp; pts.length) pts.push(makeBezierPoint(pointer.x, pointer.y));
  if (pts.length &lt; 2) { clearBezierPreview(); canvas.requestRenderAll(); return; }
  const pathData = bezierPointsToPathData(pts, false);
  const pre = ensureBezierPreview();
  pre.set({ path: fabric.Path.parsePath(pathData) });
  pre.setCoords();
  canvas.bringToFront(pre);
  canvas.requestRenderAll();
}

function pathIsBezierEditable(pathObj){
  return !!pathObj &amp;&amp; pathObj.type === 'path' &amp;&amp; (Array.isArray(pathObj.vectorModel?.points) || Array.isArray(pathObj.path));
}

function parseSimpleBezierModel(pathObj){
  const cmds = pathObj?.path || [];
  const m = cmds.find(c =&gt; c[0] === 'M');
  const c = cmds.find(c =&gt; c[0] === 'C');
  if (!m || !c) return null;
  return {
    closed: false,
    points: [
      { x:+m[1], y:+m[2], inX:+m[1], inY:+m[2], outX:+c[1], outY:+c[2], kind:'smooth' },
      { x:+c[5], y:+c[6], inX:+c[3], inY:+c[4], outX:+c[5], outY:+c[6], kind:'smooth' }
    ]
  };
}

function ensurePathVectorModel(pathObj){
  if (pathObj?.vectorModel?.points?.length) return pathObj.vectorModel;
  const parsed = parseSimpleBezierModel(pathObj);
  if (parsed) {
    pathObj.vectorModel = parsed;
    return parsed;
  }
  return null;
}

function applyVectorModelToPath(pathObj){
  const model = ensurePathVectorModel(pathObj);
  if (!model || model.points.length &lt; 2) return;
  const d = bezierPointsToPathData(model.points, !!model.closed);
  pathObj.set({ path: fabric.Path.parsePath(d) });
  pathObj.setCoords();
}

function startBezierCreation(){
  if (bezierEditor.enabled) finalizeBezierEditor();
  vectorToolState.mode = 'creating';
  vectorToolState.points = [];
  vectorToolState.closed = false;
  vectorToolState.dragPointIndex = -1;
  vectorToolState.segmentDrag = null;
  clearBezierPreview();
  setStatus('Vetor: clique para ponto reto, arraste para alças. Enter finaliza, Esc desfaz.');
}

function finishBezierCreation({toEditing=true}={}){
  const pts = vectorToolState.points;
  if (pts.length &lt; 2) {
    vectorToolState.mode = 'idle';
    clearBezierPreview();
    return null;
  }
  const d = bezierPointsToPathData(pts, vectorToolState.closed);
  const path = new fabric.Path(d, {
    fill:'',
    stroke:'rgba(127,90,240,.95)',
    strokeWidth:3,
    strokeLineCap:'round',
    strokeLineJoin:'round'
  });
  path.dataName = 'Bezier';
  path.vectorModel = { points: cloneBezierPoints(pts), closed: !!vectorToolState.closed };
  canvas.add(path);
  canvas.setActiveObject(path);
  clearBezierPreview();
  vectorToolState.points = [];
  vectorToolState.closed = false;
  vectorToolState.mode = toEditing ? 'editing' : 'idle';
  if (toEditing) attachBezierEditor(path);
  canvas.requestRenderAll();
  snapshot();
  return path;
}

function cancelBezierCreationStep(){
  if (vectorToolState.mode !== 'creating') return;
  if (vectorToolState.points.length) {
    vectorToolState.points.pop();
    setStatus(vectorToolState.points.length ? 'Último ponto removido.' : 'Criação Bézier cancelada.');
    updateBezierCreationPreview();
    return;
  }
  clearBezierPreview();
  vectorToolState.mode = 'idle';
  setActiveTool('select');
}

function distance(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }

function maybeCloseBezierPath(pointer){
  if (vectorToolState.points.length &lt; 3) return false;
  const first = vectorToolState.points[0];
  if (distance(pointer, first) &gt; BEZIER_CREATE_HIT / Math.max(zoom, .1)) return false;
  vectorToolState.closed = true;
  finishBezierCreation({toEditing:true});
  return true;
}

function addBezierPoint(pointer, e){
  if (maybeCloseBezierPath(pointer)) return;
  const p = makeBezierPoint(pointer.x, pointer.y);
  const pts = vectorToolState.points;
  const prev = pts[pts.length-1];
  if (prev &amp;&amp; prev.kind !== 'corner' &amp;&amp; !e.altKey) {
    const vx = prev.x - prev.outX;
    const vy = prev.y - prev.outY;
    p.inX = p.x + vx;
    p.inY = p.y + vy;
    p.kind = 'smooth';
  }
  pts.push(p);
  vectorToolState.dragPointIndex = pts.length - 1;
  updateBezierCreationPreview();
}

function updateDraggedCreatePoint(pointer, e){
  const i = vectorToolState.dragPointIndex;
  if (i &lt; 0) return;
  const pt = vectorToolState.points[i];
  let dx = pointer.x - pt.x;
  let dy = pointer.y - pt.y;
  if (e.shiftKey) ({dx, dy} = normalizeVectorByShift(dx, dy));
  pt.outX = pt.x + dx;
  pt.outY = pt.y + dy;
  if (e.altKey) {
    pt.inX = pt.x; pt.inY = pt.y; pt.kind = 'corner';
  } else {
    pt.inX = pt.x - dx;
    pt.inY = pt.y - dy;
    pt.kind = 'smooth';
  }
  updateBezierCreationPreview();
}

function getHandleVisualScale(){
  return 1 / Math.max(zoom, 0.05);
}

function createBezierControl(x, y, role){
  const isAnchor = role.includes('anchor');
  const r = isAnchor ? 5.5 : 4.5;
  const c = new fabric.Circle({
    left:x-r, top:y-r, radius:r,
    fill:isAnchor ? '#ffffff' : '#111',
    stroke:'#2f9bff', strokeWidth:2,
    selectable:false, evented:true, hasControls:false, hasBorders:false,
    excludeFromExport:true, hoverCursor:'move'
  });
  const sc = getHandleVisualScale();
  c.set({ scaleX:sc, scaleY:sc });
  c.bziRole = role;
  c.isBezierEditorControl = true;
  return c;
}

function clearBezierEditor(){
  [...bezierEditor.links, ...bezierEditor.controls].forEach(o =&gt; {
    if (canvas.getObjects().includes(o)) canvas.remove(o);
  });
  bezierEditor.path = null;
  bezierEditor.controls = [];
  bezierEditor.links = [];
  bezierEditor.enabled = false;
  vectorToolState.segmentDrag = null;
  canvas.requestRenderAll();
}

function getPathModel(pathObj){
  return ensurePathVectorModel(pathObj);
}

function refreshBezierEditorControls(){
  const pathObj = bezierEditor.path;
  if (!pathObj) return;
  const model = getPathModel(pathObj);
  if (!model) return;
  const sc = getHandleVisualScale();

  // rebuild links fresh for simplicity
  bezierEditor.links.forEach(l =&gt; canvas.remove(l));
  bezierEditor.links = [];

  const byRole = Object.fromEntries(bezierEditor.controls.map(c =&gt; [c.bziRole, c]));
  model.points.forEach((pt, i) =&gt; {
    const a = byRole[`anchor-${i}`];
    const hin = byRole[`in-${i}`];
    const hout = byRole[`out-${i}`];
    if (a) a.set({ left:pt.x-a.radius, top:pt.y-a.radius, scaleX:sc, scaleY:sc });
    if (hin) hin.set({ left:pt.inX-hin.radius, top:pt.inY-hin.radius, scaleX:sc, scaleY:sc });
    if (hout) hout.set({ left:pt.outX-hout.radius, top:pt.outY-hout.radius, scaleX:sc, scaleY:sc });

    const style = { stroke:'rgba(47,155,255,.45)', strokeWidth:1.2*sc, selectable:false, evented:false, excludeFromExport:true };
    if (distance({x:pt.x,y:pt.y},{x:pt.inX,y:pt.inY}) &gt; 0.5) bezierEditor.links.push(new fabric.Line([pt.x,pt.y,pt.inX,pt.inY], style));
    if (distance({x:pt.x,y:pt.y},{x:pt.outX,y:pt.outY}) &gt; 0.5) bezierEditor.links.push(new fabric.Line([pt.x,pt.y,pt.outX,pt.outY], style));
  });

  bezierEditor.links.forEach(l =&gt; canvas.add(l));
  bezierEditor.controls.forEach(c =&gt; canvas.bringToFront(c));
  canvas.requestRenderAll();
}

function attachBezierEditor(pathObj){
  if (!pathIsBezierEditable(pathObj)) return setStatus('Selecione uma curva vetorial para editar nós.');
  const model = ensurePathVectorModel(pathObj);
  if (!model || model.points.length &lt; 2) return setStatus('Curva incompatível para edição.');
  clearBezierEditor();

  pathObj.set({ selectable:false, evented:true, hasControls:false, lockMovementX:true, lockMovementY:true });
  bezierEditor.path = pathObj;
  bezierEditor.enabled = true;
  vectorToolState.mode = 'editing';

  const controls = [];
  model.points.forEach((pt, i) =&gt; {
    controls.push(createBezierControl(pt.x, pt.y, `anchor-${i}`));
    controls.push(createBezierControl(pt.inX, pt.inY, `in-${i}`));
    controls.push(createBezierControl(pt.outX, pt.outY, `out-${i}`));
  });

  controls.forEach(ctrl =&gt; {
    ctrl.on('moving', evt =&gt; {
      const m = getPathModel(bezierEditor.path);
      if (!m) return;
      const [role, idxStr] = String(ctrl.bziRole).split('-');
      const i = Number(idxStr);
      const pt = m.points[i];
      if (!pt) return;
      const cx = ctrl.left + ctrl.radius;
      const cy = ctrl.top + ctrl.radius;

      if (role === 'anchor') {
        const dx = cx - pt.x;
        const dy = cy - pt.y;
        pt.x = cx; pt.y = cy;
        pt.inX += dx; pt.inY += dy;
        pt.outX += dx; pt.outY += dy;
      } else if (role === 'in') {
        let dx = cx - pt.x, dy = cy - pt.y;
        const e = evt?.e || {};
        if (e.shiftKey) ({dx,dy} = normalizeVectorByShift(dx,dy));
        pt.inX = pt.x + dx; pt.inY = pt.y + dy;
        if (!e.altKey &amp;&amp; pt.kind !== 'corner') { pt.outX = pt.x - dx; pt.outY = pt.y - dy; }
      } else if (role === 'out') {
        let dx = cx - pt.x, dy = cy - pt.y;
        const e = evt?.e || {};
        if (e.shiftKey) ({dx,dy} = normalizeVectorByShift(dx,dy));
        pt.outX = pt.x + dx; pt.outY = pt.y + dy;
        if (!e.altKey &amp;&amp; pt.kind !== 'corner') { pt.inX = pt.x - dx; pt.inY = pt.y - dy; }
      }

      applyVectorModelToPath(bezierEditor.path);
      refreshBezierEditorControls();
    });
    ctrl.on('mousedblclick', () =&gt; {
      const m = getPathModel(bezierEditor.path);
      const [role, idxStr] = String(ctrl.bziRole).split('-');
      if (role !== 'anchor') return;
      const pt = m.points[Number(idxStr)];
      if (!pt) return;
      const isCorner = pt.kind === 'corner';
      pt.kind = isCorner ? 'smooth' : 'corner';
      if (isCorner) {
        pt.inX = pt.x - 36; pt.inY = pt.y;
        pt.outX = pt.x + 36; pt.outY = pt.y;
      } else {
        pt.inX = pt.x; pt.inY = pt.y;
        pt.outX = pt.x; pt.outY = pt.y;
      }
      applyVectorModelToPath(bezierEditor.path);
      refreshBezierEditorControls();
      snapshot();
    });
    ctrl.on('modified', () =&gt; snapshot());
  });

  bezierEditor.controls = controls;
  controls.forEach(c =&gt; canvas.add(c));
  refreshBezierEditorControls();
  setStatus('Edição de nós ativa: arraste pontos/alças, duplo clique no nó alterna corner/smooth.');
}

function finalizeBezierEditor(){
  if (!bezierEditor.path) return clearBezierEditor();
  const p = bezierEditor.path;
  p.set({ selectable:true, evented:true, lockMovementX:false, lockMovementY:false, hasControls:true });
  clearBezierEditor();
  vectorToolState.mode = 'idle';
  canvas.setActiveObject(p);
  canvas.requestRenderAll();
}

function convertBezierToLine(){
  const p = bezierEditor.path || activeObj();
  if (!p) return setStatus('Selecione uma curva BZI primeiro.');
  const m = ensurePathVectorModel(p);
  if (!m) return setStatus('Curva incompatível para converter em linha.');
  m.points.forEach(pt =&gt; { pt.inX = pt.x; pt.inY = pt.y; pt.outX = pt.x; pt.outY = pt.y; pt.kind='corner'; });
  applyVectorModelToPath(p);
  refreshBezierEditorControls();
  snapshot();
  setStatus('BZI convertida para segmentos retos.');
}

function reverseBezierDirection(){
  const p = bezierEditor.path || activeObj();
  if (!p) return setStatus('Selecione uma curva BZI primeiro.');
  const m = ensurePathVectorModel(p);
  if (!m) return setStatus('Curva incompatível para inverter direção.');
  m.points.reverse();
  m.points = m.points.map(pt =&gt; ({ ...pt, inX:pt.outX, inY:pt.outY, outX:pt.inX, outY:pt.inY }));
  applyVectorModelToPath(p);
  refreshBezierEditorControls();
  snapshot();
  setStatus('Direção da BZI invertida.');
}

function getNearestBezierSegment(pathObj, pointer){
  const m = ensurePathVectorModel(pathObj);
  if (!m || m.points.length &lt; 2) return -1;
  let best = { i:-1, d:Infinity };
  const segCount = m.closed ? m.points.length : m.points.length - 1;
  const distToLine = (p,a,b) =&gt; {
    const A = p.x-a.x, B = p.y-a.y, C = b.x-a.x, D = b.y-a.y;
    const dot = A*C + B*D;
    const lenSq = C*C + D*D || 1;
    const t = Math.max(0, Math.min(1, dot/lenSq));
    const x = a.x + C*t, y = a.y + D*t;
    return Math.hypot(p.x-x,p.y-y);
  };
  for (let i=0;i&lt;segCount;i++) {
    const p0 = m.points[i], p1 = m.points[(i+1)%m.points.length];
    const d = distToLine(pointer, {x:p0.x,y:p0.y}, {x:p1.x,y:p1.y});
    if (d &lt; best.d) best = {i, d};
  }
  return best.i;
}

function insertPointOnSegment(pathObj, segIndex){
  const m = ensurePathVectorModel(pathObj);
  if (!m) return;
  const n = m.points.length;
  const i0 = segIndex;
  const i1 = (segIndex + 1) % n;
  const p0 = m.points[i0];
  const p1 = m.points[i1];
  const lerp = (a,b,t=.5) =&gt; ({x:a.x + (b.x-a.x)*t, y:a.y + (b.y-a.y)*t});
  const P0 = {x:p0.x,y:p0.y}, P1={x:p0.outX,y:p0.outY}, P2={x:p1.inX,y:p1.inY}, P3={x:p1.x,y:p1.y};
  const Q0 = lerp(P0,P1), Q1 = lerp(P1,P2), Q2 = lerp(P2,P3);
  const R0 = lerp(Q0,Q1), R1 = lerp(Q1,Q2);
  const S = lerp(R0,R1);

  p0.outX = Q0.x; p0.outY = Q0.y;
  p1.inX = Q2.x; p1.inY = Q2.y;
  const mid = { x:S.x, y:S.y, inX:R0.x, inY:R0.y, outX:R1.x, outY:R1.y, kind:'smooth' };
  m.points.splice(i1, 0, mid);
  applyVectorModelToPath(pathObj);
  attachBezierEditor(pathObj);
  snapshot();
}


function addLayer() {
  ensureArtboard();
  const idx = canvas.getObjects().filter(o=>!isGuide(o)).length + 1;
  const l = new fabric.Rect({
    left: artboard.left + 100, top: artboard.top + 100,
    width: 260, height: 160, rx: 12, ry: 12,
    fill:'rgba(255,255,255,.08)', stroke:'rgba(255,255,255,.22)', strokeWidth:1,
    opacity:1, globalCompositeOperation:'source-over'
  });
  l.dataName = `Layer ${idx}`;
  canvas.add(l); canvas.setActiveObject(l); canvas.requestRenderAll();
  refreshLayers(); refreshProps();
  setStatus('Nova layer criada');
}

function bringForwardSelection(){
  const obj = activeObj(); if(!obj) return;
  canvas.bringForward(obj); canvas.requestRenderAll(); refreshLayers();
}
function sendBackwardSelection(){
  const obj = activeObj(); if(!obj) return;
  canvas.sendBackwards(obj); canvas.requestRenderAll(); refreshLayers();
}

function importExternalFile(file){
  if(!file) return;
  const name = String(file.name||'').toLowerCase();
  const isSvg = file.type==='image/svg+xml' || name.endsWith('.svg');
  const isRaster = file.type.startsWith('image/') || ['.png','.jpg','.jpeg','.webp','.gif'].some(ext=>name.endsWith(ext));
  const isVectorUnsupported = ['.ai','.eps'].some(ext=>name.endsWith(ext));

  if (isSvg) {
    const fr = new FileReader();
    fr.onload = ev => loadSVGFromParent(String(ev.target?.result||''));
    fr.readAsText(file);
    return;
  }
  if (isRaster) {
    const fr = new FileReader();
    fr.onload = ev => {
      fabric.Image.fromURL(ev.target.result, img => {
        ensureArtboard();
        const maxW = Math.min(docW * 0.8, 600);
        if (img.width > maxW) img.scaleToWidth(maxW);
        img.set({ left: artboard.left + 40, top: artboard.top + 40, dataName:file.name || 'Imagem colada' });
        canvas.add(img); canvas.setActiveObject(img); canvas.requestRenderAll();
        refreshLayers();
      });
    };
    fr.readAsDataURL(file);
    return;
  }
  if (isVectorUnsupported) {
    ensureArtboard();
    const ph = new fabric.Rect({ left:artboard.left+80, top:artboard.top+80, width:260, height:120, fill:'rgba(127,90,240,.12)', stroke:'rgba(127,90,240,.6)', strokeDashArray:[6,4] });
    const label = new fabric.Text(file.name + ' (importado)', { left:artboard.left+94, top:artboard.top+128, fontSize:14, fill:'#fff', fontFamily:'Outfit' });
    const g = new fabric.Group([ph,label], { dataName:file.name || 'Arquivo vetorial' });
    canvas.add(g); canvas.setActiveObject(g); canvas.requestRenderAll(); refreshLayers();
    setStatus('Arquivo importado como referência visual.');
    return;
  }
  setStatus('Formato não suportado para importação.');
}


// ─── History ─────────────────────────────────────────────
const history = { stack:[], idx:-1, lock:false };
function snapshot() {
  if (history.lock) return;
  try {
    const json = canvas.toJSON(['excludeFromExport','dataName']);
    history.stack = history.stack.slice(0, history.idx+1);
    history.stack.push(json);
    if (history.stack.length &gt; 60) history.stack.shift();
    history.idx = history.stack.length - 1;
  } catch(e) {}
}
function restore(idx) {
  if (idx &lt; 0 || idx &gt;= history.stack.length) return;
  history.lock = true;
  canvas.loadFromJSON(history.stack[idx], () =&gt; {
    canvas.requestRenderAll();
    history.idx = idx;
    history.lock = false;
    refreshLayers(); refreshProps();
  });
}
function undo() { if (history.idx &gt; 0) restore(history.idx-1); }
function redo() { if (history.idx &lt; history.stack.length-1) restore(history.idx+1); }

canvas.on('object:added', e =&gt; { if(!history.lock &amp;&amp; e.target &amp;&amp; !isGuide(e.target)) snapshot(); });
canvas.on('object:modified', e =&gt; { if(!history.lock &amp;&amp; e.target &amp;&amp; !isGuide(e.target)) snapshot(); });
canvas.on('object:removed', e =&gt; { if(!history.lock) snapshot(); });

// ─── Delete / Duplicate ──────────────────────────────────
function del() {
  const o = activeObj(); if(!o) return;
  canvas.remove(o); canvas.discardActiveObject(); canvas.requestRenderAll();
  refreshProps(); refreshLayers();
}
function duplicate() {
  const o = activeObj(); if(!o) return;
  o.clone(cl =&gt; {
    cl.set({ left:(o.left||0)+18, top:(o.top||0)+18 });
    canvas.add(cl); canvas.setActiveObject(cl);
    canvas.requestRenderAll(); refreshProps(); refreshLayers();
  });
}


function selectedObjects() {
  const active = canvas.getActiveObject();
  if(!active || isGuide(active)) return [];
  if(active.type === 'activeSelection') {
    return active.getObjects().filter(o =&gt; !isGuide(o));
  }
  return [active];
}

function nudgeBy(obj, dx=0, dy=0) {
  obj.set({ left: (obj.left||0) + dx, top: (obj.top||0) + dy });
  obj.setCoords();
}

function getAlignReferenceRect(objs) {
  ensureArtboard();
  if(!artboard) return null;

  const target = $('alignTarget')?.value || 'layout';
  if(target !== 'object') {
    return { left: artboard.left, top: artboard.top, width: docW, height: docH };
  }

  const active = canvas.getActiveObject();
  if(!active || active.type !== 'activeSelection') {
    setStatus('No modo objeto, selecione 2+ elementos');
    return null;
  }
  const list = active.getObjects().filter(o =&gt; !isGuide(o));
  if(list.length &lt; 2) {
    setStatus('Selecione ao menos 2 elementos para alinhar por objeto');
    return null;
  }

  const anchor = list[list.length - 1];
  const b = anchor.getBoundingRect(true, true);
  return { left: b.left, top: b.top, width: b.width, height: b.height, anchor };
}

function alignSelection(mode) {
  ensureArtboard();
  const objs = selectedObjects();
  const ref = getAlignReferenceRect(objs);
  if(!objs.length || !ref) return;
  const L = ref.left, T = ref.top;
  const R = L + ref.width, B = T + ref.height;

  objs.forEach(obj =&gt; {
    if(ref.anchor &amp;&amp; obj === ref.anchor) return;
    const b = obj.getBoundingRect(true, true);
    let dx = 0, dy = 0;
    if(mode === 'left') dx = L - b.left;
    if(mode === 'center') dx = (L + ref.width / 2) - (b.left + b.width / 2);
    if(mode === 'right') dx = R - (b.left + b.width);
    if(mode === 'top') dy = T - b.top;
    if(mode === 'middle') dy = (T + ref.height / 2) - (b.top + b.height / 2);
    if(mode === 'bottom') dy = B - (b.top + b.height);
    if(dx || dy) nudgeBy(obj, dx, dy);
  });

  canvas.requestRenderAll();
  refreshProps();
  refreshLayers();
  setStatus('Alinhamento aplicado');
}

async function syncTextStyleRender(obj) {
  if(!obj || !(obj.type==='textbox'||obj.type==='text'||obj.type==='i-text')) return;
  try {
    if(document.fonts &amp;&amp; obj.fontFamily) {
      const size = obj.fontSize || 16;
      await document.fonts.load(`${size}px "${obj.fontFamily}"`);
    }
  } catch(_) {}
  canvas.requestRenderAll();
}

function ensureGoogleFont(fontName) {
  const font = (fontName || '').trim();
  if(!font) return false;
  const q = font.split(/\s+/).join('+');
  const id = `gf-${q.toLowerCase()}`;
  if(!document.getElementById(id)) {
    const link = document.createElement('link');
    link.id = id;
    link.rel = 'stylesheet';
    link.href = `https://fonts.googleapis.com/css2?family=${q}:wght@300;400;500;600;700;800;900&amp;display=swap`;
    document.head.appendChild(link);
  }
  return true;
}

async function loadGoogleFontForSelection() {
  const input = $('pGoogleFont');
  const font = (input?.value || '').trim();
  if(!font) { setStatus('Informe o nome da fonte Google'); return; }
  ensureGoogleFont(font);
  const obj = activeObj();
  if(obj &amp;&amp; (obj.type==='textbox'||obj.type==='text'||obj.type==='i-text')) {
    obj.set({ fontFamily: font });
    if(UI.font) {
      const hasOpt = [...UI.font.options].some(o =&gt; o.value === font);
      if(!hasOpt) {
        const opt = document.createElement('option');
        opt.value = font; opt.textContent = font;
        UI.font.appendChild(opt);
      }
      UI.font.value = font;
    }
    await syncTextStyleRender(obj);
    setStatus(`Fonte carregada: ${font}`);
    return;
  }
  setStatus(`Fonte carregada: ${font}. Selecione um texto para aplicar.`);
}

function distributeSelection(axis='x') {
  const objs = selectedObjects();
  if(objs.length &lt; 3) {
    setStatus('Selecione 3+ elementos para distribuir');
    return;
  }

  const sorted = objs.slice().sort((a,b) =&gt; {
    const ba = a.getBoundingRect(true, true);
    const bb = b.getBoundingRect(true, true);
    return axis === 'x' ? ba.left - bb.left : ba.top - bb.top;
  });

  const centers = sorted.map(obj =&gt; {
    const b = obj.getBoundingRect(true, true);
    return axis === 'x' ? (b.left + b.width / 2) : (b.top + b.height / 2);
  });

  const first = centers[0];
  const last = centers[centers.length - 1];
  if(Math.abs(last - first) &lt; 1) return;
  const step = (last - first) / (sorted.length - 1);

  sorted.forEach((obj, i) =&gt; {
    if(i === 0 || i === sorted.length - 1) return;
    const b = obj.getBoundingRect(true, true);
    const current = axis === 'x' ? (b.left + b.width / 2) : (b.top + b.height / 2);
    const target = first + step * i;
    const delta = target - current;
    if(axis === 'x') nudgeBy(obj, delta, 0);
    else nudgeBy(obj, 0, delta);
  });

  canvas.requestRenderAll();
  refreshProps();
  refreshLayers();
  setStatus(axis === 'x' ? 'Distribuição horizontal aplicada' : 'Distribuição vertical aplicada');
}

function groupSelection() {
  const active = canvas.getActiveObject();
  if(active &amp;&amp; active.type === 'activeSelection') {
    active.toGroup();
    canvas.requestRenderAll();
    refreshLayers();
    setStatus('Grupo criado');
    return;
  }
  setStatus('Selecione 2+ elementos para agrupar');
}

function ungroupSelection() {
  const active = canvas.getActiveObject();
  if(active &amp;&amp; active.type === 'group') {
    active.toActiveSelection();
    canvas.requestRenderAll();
    refreshLayers();
    setStatus('Grupo desfeito');
  }
}

// ─── Properties panel ────────────────────────────────────
const UI = {
  x:$('pX'), y:$('pY'), w:$('pW'), h:$('pH'),
  r:$('pR'), o:$('pO'), blend:$('pBlend'),
  fill:$('pFill'), stroke:$('pStroke'), strokeW:$('pStrokeW'), rx:$('pRx'),
  font:$('pFont'), fontSize:$('pFontSize'),
  textColor:$('pTextColor'), align:null
};

function activeObj() {
  const o = canvas.getActiveObject();
  return (o &amp;&amp; !isGuide(o)) ? o : null;
}
function num(v, fb=0) { const n=Number(v); return Number.isFinite(n)?n:fb; }
function normalizeHex(c) {
  if(!c) return null;
  const s = String(c).trim();
  if(/^#[0-9a-f]{3}$/i.test(s)) return '#'+s.slice(1).split('').map(x=&gt;x+x).join('');
  if(/^#[0-9a-f]{6}$/i.test(s)) return s;
  return null;
}

function isTextObject(obj){
  return !!obj &amp;&amp; (obj.type==='textbox' || obj.type==='text' || obj.type==='i-text');
}

function focusTextPanel(show){
  const tabsRoot = $('propTabs');
  if (show &amp;&amp; tabsRoot) {
    const corTab = tabsRoot.querySelector('[data-tab="cor"]');
    corTab?.click();
    $('propText')?.scrollIntoView({behavior:'smooth', block:'nearest'});
  }
}

function syncFloatingTextPanel(){
  const obj = activeObj();
  const panel = $('textFloatPanel');
  if(!panel) return;
  const disabled = !isTextObject(obj);
  ['tfFontSize','tfColor','tfLineHeight','tfLetterSpacing','tfWeight','tfStyle'].forEach(id=&gt;{ const el=$(id); if(el) el.disabled = disabled; });
  if(disabled) return;
  if($('tfFontSize')) $('tfFontSize').value = Math.round(obj.fontSize||16);
  if($('tfColor')) $('tfColor').value = normalizeHex(obj.fill)||'#111111';
  if($('tfLineHeight')) $('tfLineHeight').value = Number(obj.lineHeight||1.2).toFixed(1);
  if($('tfLetterSpacing')) $('tfLetterSpacing').value = Math.round((obj.charSpacing||0)/50);
  if($('tfWeight')) $('tfWeight').value = String(obj.fontWeight||400);
  if($('tfStyle')) $('tfStyle').value = obj.fontStyle||'normal';
  const align = obj.textAlign||'left';
  document.querySelectorAll('#tfAlignSeg .seg-opt').forEach(btn=&gt;btn.classList.toggle('on', btn.dataset.val===align));
}

function refreshProps() {
  const obj = activeObj();
  const info = $('selInfo');

  // alignment seg
  const segs = document.querySelectorAll('#alignSeg .seg-opt');

  if (!obj) {
    if (info) info.textContent = 'Nada selecionado';
    const c1=$('ctxSelectionState'); if(c1) c1.innerHTML='&lt;strong&gt;Nenhuma seleção&lt;/strong&gt;';
    const c2=$('canvasSelectionState'); if(c2) c2.innerHTML='&lt;strong&gt;Nenhuma seleção&lt;/strong&gt;';
    syncFloatingTextPanel();
    return;
  }

  if (info) {
    const typeNames = {textbox:'Texto',text:'Texto','i-text':'Texto',rect:'Retângulo',circle:'Círculo',ellipse:'Elipse',line:'Linha',image:'Imagem',group:'Grupo'};
    const selType = typeNames[obj.type] || obj.type;
    info.textContent = selType;
    const c1=$('ctxSelectionState'); if(c1) c1.innerHTML='&lt;strong&gt;'+selType+'&lt;/strong&gt;';
    const c2=$('canvasSelectionState'); if(c2) c2.innerHTML='&lt;strong&gt;'+selType+'&lt;/strong&gt;';
  }

  const sw = obj.getScaledWidth ? obj.getScaledWidth() : (obj.width||0);
  const sh = obj.getScaledHeight ? obj.getScaledHeight() : (obj.height||0);
  if(UI.x) UI.x.value = Math.round(obj.left??0);
  if(UI.y) UI.y.value = Math.round(obj.top??0);
  if(UI.w) UI.w.value = Math.round(sw);
  if(UI.h) UI.h.value = Math.round(sh);
  if(UI.r) UI.r.value = Math.round(obj.angle??0);
  if(UI.o) UI.o.value = obj.opacity??1;
  if(UI.blend) UI.blend.value = obj.globalCompositeOperation || 'source-over';

  const f = (typeof obj.fill==='string') ? obj.fill : '#111111';
  if(UI.fill) UI.fill.value = normalizeHex(f) || '#111111';
  if(UI.textColor) UI.textColor.value = normalizeHex(f) || '#111111';
  const s = (typeof obj.stroke==='string') ? obj.stroke : '#000000';
  if(UI.stroke) UI.stroke.value = normalizeHex(s) || '#000000';
  if(UI.strokeW) UI.strokeW.value = obj.strokeWidth??0;
  if(UI.rx) UI.rx.value = Math.round(obj.rx??obj.ry??0);

  if (obj.type==='textbox'||obj.type==='text'||obj.type==='i-text') {
    focusTextPanel(true);
    if(UI.font &amp;&amp; obj.fontFamily) UI.font.value = obj.fontFamily;
    if(UI.fontSize) UI.fontSize.value = obj.fontSize??'';
    const align = obj.textAlign || 'left';
    segs.forEach(s =&gt; {
      s.classList.toggle('on', s.dataset.val === align);
    });
  }
  syncFloatingTextPanel();
}

function applyProps(key) {
  const obj = activeObj(); if(!obj) return;
  obj.set({
    left: num(UI.x?.value, obj.left||0),
    top:  num(UI.y?.value, obj.top||0),
    angle: num(UI.r?.value, obj.angle||0),
    opacity: num(UI.o?.value, obj.opacity??1),
    globalCompositeOperation: UI.blend?.value || obj.globalCompositeOperation || 'source-over'
  });

  const tw = num(UI.w?.value, obj.getScaledWidth());
  const th = num(UI.h?.value, obj.getScaledHeight());
  if (tw&gt;1 &amp;&amp; th&gt;1) {
    if (obj.type==='line') {
      obj.set({ x2:(obj.x1??0)+tw, y2:(obj.y1??0)+th });
    } else {
      obj.set({ scaleX: tw/(obj.width||1), scaleY: th/(obj.height||1) });
    }
  }

  if(key==='fill'||!key) obj.set({ fill: UI.fill?.value || obj.fill });
  if(key==='stroke'||!key) obj.set({ stroke: UI.stroke?.value || obj.stroke });
  if(key==='strokeW'||!key) obj.set({ strokeWidth: num(UI.strokeW?.value, obj.strokeWidth||0) });
  if(UI.rx &amp;&amp; (obj.type==='rect'||obj.rx!=null)) {
    const rv = clamp(num(UI.rx.value, obj.rx||0), 0, 2000);
    obj.set({ rx:rv, ry:rv });
  }

  if (obj.type==='textbox'||obj.type==='text'||obj.type==='i-text') {
    if(UI.font?.value) obj.set({ fontFamily: UI.font.value });
    if(UI.fontSize?.value) obj.set({ fontSize: clamp(num(UI.fontSize.value, obj.fontSize||16), 6, 512) });
    if(key==='textColor'||key==='fill') obj.set({ fill: UI.textColor?.value || obj.fill });
    syncTextStyleRender(obj);
  }

  obj.setCoords(); canvas.requestRenderAll();
}

function bindInput(el, k) {
  if(!el) return;
  el.addEventListener('input', () =&gt; applyProps(k));
  el.addEventListener('change', () =&gt; applyProps(k));
}
bindInput(UI.x,'pos'); bindInput(UI.y,'pos'); bindInput(UI.w,'size'); bindInput(UI.h,'size');
bindInput(UI.r,'rot'); bindInput(UI.o,'op'); bindInput(UI.blend,'blend');
bindInput(UI.fill,'fill'); bindInput(UI.stroke,'stroke'); bindInput(UI.strokeW,'strokeW'); bindInput(UI.rx,'rx');
bindInput(UI.font,'font'); bindInput(UI.fontSize,'fontSize');
bindInput(UI.textColor,'textColor');

document.querySelectorAll('#alignSeg .seg-opt').forEach(btn =&gt; {
  btn.addEventListener('click', () =&gt; {
    document.querySelectorAll('#alignSeg .seg-opt').forEach(b =&gt; b.classList.remove('on'));
    btn.classList.add('on');
    const obj = activeObj();
    if(obj) { obj.set({ textAlign: btn.dataset.val }); canvas.requestRenderAll(); }
  });
});

['selection:created','selection:updated','selection:cleared'].forEach(ev =&gt; canvas.on(ev, () =&gt; {
  refreshProps(); refreshLayers();
  if (ev === 'selection:cleared' &amp;&amp; bezierEditor.enabled) finalizeBezierEditor();
  if ((ev === 'selection:created' || ev === 'selection:updated') &amp;&amp; (activeTool === 'bezier' || activeTool === 'direct-select')) {
    const obj = activeObj();
    if (pathIsBezierEditable(obj)) attachBezierEditor(obj);
  }
}));

// ─── Layers ──────────────────────────────────────────────
const typeIcons = {
  textbox:'type', text:'type', 'i-text':'type',
  rect:'square', circle:'circle', ellipse:'circle-ellipsis', line:'slash', image:'image', group:'layers'
};
const blendModes = ['source-over','multiply','screen','overlay','darken','lighten','color-dodge','color-burn','difference','exclusion'];
let layerFolders = ['Geral'];
let draggingLayerId = null;

function ensureFoldersForObjects(objs){
  objs.forEach(obj =&gt; {
    if(!obj.dataFolder) obj.dataFolder = 'Geral';
    if(!layerFolders.includes(obj.dataFolder)) layerFolders.push(obj.dataFolder);
  });
}

function renderFolderChips(){
  const root = $('folderList');
  if(!root) return;
  root.innerHTML = layerFolders.map(name =&gt; `&lt;span class=&quot;folder-chip&quot;&gt;📁 ${name}&lt;/span&gt;`).join('');
}

function moveLayerByDisplayIndex(obj, displayIndex){
  const objects = canvas.getObjects().filter(o=&gt;!isGuide(o));
  const targetIndex = Math.max(0, Math.min(objects.length - 1, objects.length - 1 - displayIndex));
  canvas.moveTo(obj, targetIndex);
  canvas.requestRenderAll();
}

function applyClipMask(){
  const sel = canvas.getActiveObject();
  if(!sel || sel.type !== 'activeSelection' || sel._objects.length &lt; 2){
    setStatus('Selecione 2 objetos para criar clip mask.');
    return;
  }
  const objs = sel._objects.slice();
  const mask = objs[0];
  const target = objs[1];
  mask.clone(clone =&gt; {
    clone.absolutePositioned = true;
    clone.set({ left: mask.left, top: mask.top, angle: mask.angle, scaleX: mask.scaleX, scaleY: mask.scaleY, originX: mask.originX, originY: mask.originY });
    target.clipPath = clone;
    canvas.remove(mask);
    canvas.discardActiveObject();
    canvas.setActiveObject(target);
    canvas.requestRenderAll();
    refreshLayers();
    setStatus('Clip mask aplicado');
  });
}

function releaseClipMask(){
  const obj = activeObj();
  if(!obj || !obj.clipPath){
    setStatus('Selecione um objeto com clip mask.');
    return;
  }
  obj.clipPath = null;
  canvas.requestRenderAll();
  refreshLayers();
  setStatus('Clip mask removido');
}

function createLayerFolder(){
  const name = prompt('Nome da pasta de camadas:');
  if(!name) return;
  const clean = name.trim();
  if(!clean) return;
  if(layerFolders.includes(clean)) { setStatus('Essa pasta já existe.'); return; }
  layerFolders.push(clean);
  renderFolderChips();
  refreshLayers();
  setStatus('Pasta criada');
}

function refreshLayers() {
  const list = $('layersList');
  const cnt = $('layerCount');
  if (!list) return;
  const objs = canvas.getObjects().filter(o=&gt;!isGuide(o)).slice().reverse();
  ensureFoldersForObjects(objs);
  renderFolderChips();
  if (cnt) cnt.textContent = objs.length;
  const active = canvas.getActiveObject();
  list.innerHTML = '';
  if (!objs.length) {
    list.innerHTML = '&lt;div class=&quot;layer-empty&quot;&gt;Sem objetos ainda&lt;/div&gt;';
    return;
  }
  objs.forEach((obj, i) =&gt; {
    const isAct = obj === active;
    const icon = typeIcons[obj.type] || 'square';
    const name = obj.dataName || (obj.text ? obj.text.slice(0,18) : obj.type);
    const div = document.createElement('div');
    div.className = 'layer-item' + (isAct ? ' active' : '');
    div.draggable = true;
    div.dataset.layerId = obj.__uid || (obj.__uid = 'ly_' + Math.random().toString(36).slice(2,9));
    const thumbStyle = (() =&gt; {
      if (obj.type === 'image' &amp;&amp; obj._element?.src) return `background-image:url('${obj._element.src}')`;
      const fill = typeof obj.fill==='string' ? obj.fill : 'rgba(255,255,255,.08)';
      const stroke = typeof obj.stroke==='string' ? obj.stroke : 'rgba(255,255,255,.2)';
      return `background:linear-gradient(135deg, ${fill}, ${stroke})`;
    })();
    div.innerHTML = `
      &lt;div class=&quot;layer-icon&quot;&gt;&lt;i data-lucide=&quot;${icon}&quot; data-size=&quot;13&quot;&gt;&lt;/i&gt;&lt;/div&gt;
      &lt;div style=&quot;min-width:0&quot;&gt;
        &lt;div class=&quot;layer-main&quot;&gt;
          &lt;div class=&quot;layer-thumb&quot; style=&quot;${thumbStyle}&quot;&gt;&lt;/div&gt;
          &lt;div class=&quot;layer-name&quot;&gt;${name}&lt;/div&gt;
          &lt;div class=&quot;layer-meta&quot;&gt;${Math.round((obj.opacity??1)*100)}%&lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class=&quot;layer-meta&quot;&gt;${obj.dataFolder||'Geral'}&lt;/div&gt;`;

    div.addEventListener('click', () =&gt; { canvas.setActiveObject(obj); canvas.requestRenderAll(); refreshProps(); refreshLayers(); });
    div.addEventListener('dragstart', () =&gt; { draggingLayerId = div.dataset.layerId; });
    div.addEventListener('dragover', e =&gt; { e.preventDefault(); div.classList.add('drag-over'); });
    div.addEventListener('dragleave', () =&gt; div.classList.remove('drag-over'));
    div.addEventListener('drop', e =&gt; {
      e.preventDefault();
      div.classList.remove('drag-over');
      if(!draggingLayerId || draggingLayerId===div.dataset.layerId) return;
      const draggedObj = objs.find(o =&gt; o.__uid===draggingLayerId);
      if(!draggedObj) return;
      moveLayerByDisplayIndex(draggedObj, i);
      refreshLayers();
    });

    list.appendChild(div);
  });
  if(window.lucide?.createIcons) window.lucide.createIcons({attrs:{'stroke-width':1.9}});
}

let brandLibrary=[];
let draggedLibraryIndex = null;

function refreshLibrary(){
  const list=$('libraryList');
  const cnt=$('libCount');
  if(!list) return;
  if(cnt) cnt.textContent=brandLibrary.length;
  list.innerHTML='';
  if(!brandLibrary.length){
    list.innerHTML='&lt;div class=&quot;layer-empty&quot;&gt;Sem itens de identidade&lt;/div&gt;';
    return;
  }
  brandLibrary.forEach((item,idx)=>{
    const div=document.createElement('div');
    div.className='lib-item';
    const icon = item.kind==='logo' ? 'image' : item.kind==='color' ? 'droplets' : 'type';
    const meta = item.kind==='logo' ? 'Logo' : item.kind==='color' ? (item.color||'Cor') : ((item.font||'Fonte')+' • '+(item.size||16)+'px');
    div.draggable = true;
    const preview = item.kind==='logo' &amp;&amp; item.src ? `background-image:url('${item.src}')` : item.kind==='color' ? `background:${item.color||'#999'}` : 'background:linear-gradient(135deg, rgba(127,90,240,.35), rgba(44,182,125,.35))';
    div.innerHTML=`&lt;div class=&quot;lib-preview&quot; style=&quot;${preview}&quot;&gt;&lt;/div&gt;&lt;div class=&quot;lib-icon&quot;&gt;&lt;i data-lucide=&quot;${icon}&quot; data-size=&quot;13&quot;&gt;&lt;/i&gt;&lt;/div&gt;&lt;div class=&quot;layer-name&quot;&gt;${item.name||item.kind}&lt;/div&gt;&lt;div class=&quot;lib-meta&quot;&gt;${meta}&lt;/div&gt;`;
    div.addEventListener('click',()=>applyLibraryItem(idx));
    div.addEventListener('dragstart',()=>{ draggedLibraryIndex = idx; });
    list.appendChild(div);
  });
  if(window.lucide?.createIcons) window.lucide.createIcons({attrs:{'stroke-width':1.9}});
}

function applyLibraryItem(idx){
  const item=brandLibrary[idx];
  if(!item) return;
  if(item.kind==='color'){
    const obj=activeObj();
    if(!obj){ setStatus('Selecione um objeto para aplicar a cor.'); return; }
    obj.set({fill:item.color||'#000000'});
    if(obj.type==='textbox'||obj.type==='text'||obj.type==='i-text'){
      if(UI.textColor) UI.textColor.value=item.color||'#000000';
    }else if(UI.fill){ UI.fill.value=item.color||'#000000'; }
    canvas.requestRenderAll();
    setStatus('Cor aplicada da biblioteca');
    return;
  }
  if(item.kind==='text-style'){
    const label = item.uppercase ? String(item.name||'Novo texto').toUpperCase() : (item.name||'Novo texto');
    const text = new fabric.Textbox(label, {
      left: artboard.left + Math.max(24, docW*0.1),
      top: artboard.top + Math.max(24, docH*0.1),
      width: Math.max(180, docW*0.4),
      fontFamily: item.font || 'Outfit',
      fontWeight: item.weight || 400,
      fontSize: item.size || 24,
      lineHeight: item.lineHeight || 1.2,
      charSpacing: (item.letterSpacing||0) * 50,
      fontStyle: item.italic ? 'italic' : 'normal',
      fill: '#ffffff',
      dataName: `Style: ${item.name||'Texto'}`
    });
    canvas.add(text); canvas.setActiveObject(text); canvas.requestRenderAll();
    refreshLayers(); refreshProps();
    setStatus('Estilo de texto adicionado da biblioteca');
    return;
  }
  if(item.kind==='logo' && item.src){
    fabric.Image.fromURL(item.src, img=>{
      if(!img) return;
      const maxW=docW*0.5, maxH=docH*0.35;
      const sc=Math.min(maxW/img.width, maxH/img.height, 1);
      img.set({
        left: artboard.left + docW/2 - (img.width*sc)/2,
        top: artboard.top + docH/2 - (img.height*sc)/2,
        scaleX: sc, scaleY: sc,
        dataName: item.name || 'Logo da biblioteca'
      });
      canvas.add(img); canvas.setActiveObject(img); canvas.requestRenderAll();
      refreshLayers(); refreshProps();
      setStatus('Logo inserido da biblioteca');
    }, {crossOrigin:'anonymous'});
  }
}

stageEl?.addEventListener('dragover', e =&gt; { if (draggedLibraryIndex==null) return; e.preventDefault(); });
stageEl?.addEventListener('drop', e =&gt; {
  if (draggedLibraryIndex==null) return;
  e.preventDefault();
  applyLibraryItem(draggedLibraryIndex);
  draggedLibraryIndex = null;
});

// ─── Context menu (canvas) ─────────────────────────────
(function initCanvasContextMenu(){
  const menu = $('canvasCtx');
  if(!menu || !canvas.upperCanvasEl) return;
  const close = () =&gt; menu.classList.remove('open');
  canvas.upperCanvasEl.addEventListener('contextmenu', e =&gt; {
    e.preventDefault();
    menu.style.left = e.clientX + 'px';
    menu.style.top = e.clientY + 'px';
    menu.classList.add('open');
  });
  document.addEventListener('click', e =&gt; {
    if(!menu.contains(e.target)) close();
  });
  menu.addEventListener('click', e =&gt; {
    const act = e.target.closest('[data-act]')?.dataset.act;
    if(!act) return;
    if(act==='paste') pasteFromClipboard();
    if(act==='group') groupSelection();
    if(act==='ungroup') ungroupSelection();
    if(act==='front') bringForwardSelection();
    if(act==='back') sendBackwardSelection();
    if(act==='duplicate') duplicate();
    if(act==='delete') del();
    close();
  });
})();

// ─── Modal ───────────────────────────────────────────────
const modalBg = $('modalBg');
function openModal(title, html) {
  $('modalTitle').textContent = title;
  $('modalBody').innerHTML = html;
  modalBg.classList.add('open');
}
function closeModal() { modalBg.classList.remove('open'); $('modalBody').innerHTML=''; }
$('btnCloseModal')?.addEventListener('click', closeModal);
modalBg?.addEventListener('click', e =&gt; { if(e.target===modalBg) closeModal(); });

// ─── Export PNG ──────────────────────────────────────────
function exportPNG() {
  if (!artboard) { setStatus('Nada para exportar'); return; }
  const vt = canvas.viewportTransform;
  canvas.setViewportTransform([1,0,0,1,0,0]);
  const origZoom = zoom;
  const al = artboard.left, at = artboard.top;
  const dataURL = canvas.toDataURL({
    format:'png', quality:1, multiplier:2,
    left: al, top: at, width: docW, height: docH
  });
  canvas.setViewportTransform(vt);
  zoom = origZoom;
  const a = document.createElement('a');
  a.href = dataURL;
  a.download = 'export.png';
  a.click();
  setStatus('PNG exportado!');
}

function exportSVGToParent() {
  if (!canvas || !artboard) {
    window.parent.postMessage({ type: 'geExportSVG', error: 'Sem conteúdo para exportar.' }, '*');
    return;
  }
  const svg = canvas.toSVG({
    suppressPreamble: false,
    width: docW,
    height: docH,
    viewBox: {
      x: artboard.left,
      y: artboard.top,
      width: docW,
      height: docH
    }
  });
  window.parent.postMessage({ type: 'geExportSVG', svg }, '*');
}


function loadSVGFromParent(svgText) {
  const raw = String(svgText||'').trim();
  const keep = canvas.getObjects().filter(o => isGuide(o));
  canvas.getObjects().forEach(o => canvas.remove(o));
  keep.forEach(o => canvas.add(o));

  if (!raw) {
    canvas.requestRenderAll();
    setStatus('Arquivo novo pronto para edição');
    return;
  }

  // Detecta dimensões do SVG salvo para evitar abrir em uma prancheta padrão incorreta
  try {
    const doc = new DOMParser().parseFromString(raw, 'image/svg+xml');
    const svg = doc.querySelector('svg');
    if (svg) {
      let w = Number((svg.getAttribute('width')||'').replace(/[^\d.]/g,''));
      let h = Number((svg.getAttribute('height')||'').replace(/[^\d.]/g,''));
      const vb = (svg.getAttribute('viewBox')||'').trim().split(/\s+/).map(Number);
      if ((!w || !h) && vb.length===4 && vb.every(Number.isFinite)) {
        w = vb[2]; h = vb[3];
      }
      if (w>0 && h>0) setArtboardSize(w, h);
    }
  } catch(_err) {}

  fabric.loadSVGFromString(raw, (objects) => {
    if (!objects || !objects.length) {
      canvas.requestRenderAll();
      setStatus('Não foi possível carregar SVG anterior');
      return;
    }

    // Reposiciona o conteúdo para a prancheta ativa
    const sel = new fabric.ActiveSelection(objects, { canvas });
    const box = sel.getBoundingRect(true, true);
    const dx = (artboard?.left||0) - box.left;
    const dy = (artboard?.top||0) - box.top;

    objects.forEach(o => {
      o.set({
        left: (o.left||0) + dx,
        top: (o.top||0) + dy,
        selectable:true,
        evented:true,
        excludeFromExport:false
      });
      o.setCoords();
      canvas.add(o);
    });

    canvas.requestRenderAll();
    fitToArtboard();
    refreshLayers();
    refreshProps();
    setStatus('Aplicação carregada para edição');
  });
}

// ─── JSON save / load ─────────────────────────────────────
function saveJSON() {
  const json = JSON.stringify(canvas.toJSON(['excludeFromExport','dataName']), null, 2);
  openModal('Salvar JSON', `
    &lt;textarea class=&quot;modal-textarea&quot;&gt;${json}&lt;/textarea&gt;
    &lt;div style=&quot;display:flex;gap:8px;margin-top:12px&quot;&gt;
      &lt;button class=&quot;tbtn accent&quot; onclick=&quot;navigator.clipboard.writeText(document.querySelector('.modal-textarea').value).then(()=&gt;{this.textContent='Copiado!';setTimeout(()=&gt;{this.textContent='Copiar'},2000)})&quot; style=&quot;flex:1;justify-content:center;height:36px&quot;&gt;Copiar&lt;/button&gt;
      &lt;button class=&quot;tbtn&quot; onclick=&quot;closeModal()&quot; style=&quot;flex:1;justify-content:center;height:36px&quot;&gt;Fechar&lt;/button&gt;
    &lt;/div&gt;
  `);
}

function loadJSON() {
  openModal('Carregar JSON', `
    &lt;p style=&quot;font-size:12px;color:var(--ink2);margin-bottom:10px;font-family:var(--mono)&quot;&gt;Cole o JSON abaixo:&lt;/p&gt;
    &lt;textarea class=&quot;modal-textarea&quot; id=&quot;jsonInput&quot; placeholder='{&quot;version&quot;:&quot;5.3.0&quot;,&quot;objects&quot;:[...]}'&gt;&lt;/textarea&gt;
    &lt;div style=&quot;display:flex;gap:8px;margin-top:12px&quot;&gt;
      &lt;button class=&quot;tbtn accent&quot; onclick=&quot;
        try{
          const json=JSON.parse(document.getElementById('jsonInput').value);
          canvas.loadFromJSON(json,()=&gt;{canvas.requestRenderAll();refreshLayers();refreshProps();setStatus('JSON carregado')});
          closeModal();
        }catch(e){alert('JSON inválido')}
      &quot; style=&quot;flex:1;justify-content:center;height:36px&quot;&gt;Carregar&lt;/button&gt;
      &lt;button class=&quot;tbtn&quot; onclick=&quot;closeModal()&quot; style=&quot;flex:1;justify-content:center;height:36px&quot;&gt;Cancelar&lt;/button&gt;
    &lt;/div&gt;
  `);
}

// ─── Upload image ─────────────────────────────────────────
$('fileInput')?.addEventListener('change', e =&gt; {
  const files = Array.from(e.target.files||[]);
  files.forEach(importExternalFile);
  e.target.value = '';
});

window.addEventListener('paste', e =&gt; {
  const items = Array.from(e.clipboardData?.items || []);
  let used = false;
  items.forEach(it =&gt; {
    if (it.kind === 'file') {
      const f = it.getAsFile();
      if (f) { importExternalFile(f); used = true; }
    }
    if (it.kind === 'string' &amp;&amp; it.type === 'text/plain') {
      it.getAsString(txt =&gt; {
        const s = String(txt||'').trim();
        if (s.startsWith('&lt;svg') || s.includes('&lt;svg')) { loadSVGFromParent(s); }
      });
    }
  });
  if (used) e.preventDefault();
});


async function pasteFromClipboard() {
  if (!navigator.clipboard?.read) {
    setStatus('Menu de colar indisponível. Use Ctrl+V no workspace.');
    return;
  }
  try {
    const clipItems = await navigator.clipboard.read();
    let imported = false;
    for (const clipItem of clipItems) {
      const pngType = clipItem.types.find(t =&gt; t.startsWith('image/'));
      if (pngType) {
        const blob = await clipItem.getType(pngType);
        const file = new File([blob], `clipboard.${pngType.split('/')[1] || 'png'}`, { type: pngType });
        importExternalFile(file);
        imported = true;
        continue;
      }
      if (clipItem.types.includes('text/plain')) {
        const txtBlob = await clipItem.getType('text/plain');
        const txt = (await txtBlob.text()).trim();
        if (txt.startsWith('&lt;svg') || txt.includes('&lt;svg')) {
          loadSVGFromParent(txt);
          imported = true;
        }
      }
    }
    if (!imported) setStatus('Nada compatível para colar.');
  } catch (err) {
    setStatus('Permita acesso à área de transferência ou use Ctrl+V.');
  }
}

// ─── Constrain to artboard ───────────────────────────────
canvas.on('object:moving', opt =&gt; {
  const obj = opt.target;
  if (!artboard || !obj || isGuide(obj)) return;
  const b = obj.getBoundingRect(true, true);
  const L = artboard.left, T = artboard.top, R = L+docW, B = T+docH;
  let dx=0, dy=0;
  if(b.left&lt;L) dx=L-b.left;
  if(b.top&lt;T) dy=T-b.top;
  if(b.left+b.width&gt;R) dx=R-(b.left+b.width);
  if(b.top+b.height&gt;B) dy=B-(b.top+b.height);
  if(dx||dy){ obj.left+=dx; obj.top+=dy; obj.setCoords(); }
});

// ─── Command menus (Arquivo / Editar / etc) ───────────────
const menuCatalog = {
  file: [
    {id:'file.new', label:'Novo documento', key:'Ctrl+N'},
    {id:'file.open', label:'Abrir', key:'Ctrl+O'},
    {id:'file.close', label:'Fechar'},
    {sep:true},
    {id:'file.save', label:'Salvar', key:'Ctrl+S'},
    {id:'file.saveAs', label:'Salvar como', key:'Ctrl+Shift+S'},
    {sep:true},
    {id:'file.exportPng', label:'Exportar PNG'},
    {id:'file.exportJpg', label:'Exportar JPG'},
    {id:'file.exportSvg', label:'Exportar SVG'},
    {id:'file.exportPdf', label:'Exportar PDF'},
    {sep:true},
    {id:'file.import', label:'Importar', key:'Ctrl+I'},
    {id:'file.document', label:'Configurar documento'},
    {id:'file.preferences', label:'Preferências'}
  ],
  edit: [
    {id:'edit.undo', label:'Desfazer', key:'Ctrl+Z'},
    {id:'edit.redo', label:'Refazer', key:'Ctrl+Y'},
    {sep:true},
    {id:'edit.copy', label:'Copiar', key:'Ctrl+C'},
    {id:'edit.paste', label:'Colar', key:'Ctrl+V'},
    {id:'edit.pasteInPlace', label:'Colar no lugar'},
    {id:'edit.cut', label:'Recortar', key:'Ctrl+X'},
    {id:'edit.duplicate', label:'Duplicar', key:'Ctrl+D'},
    {id:'edit.delete', label:'Apagar', key:'Del'},
    {sep:true},
    {id:'edit.group', label:'Agrupar', key:'Ctrl+G'},
    {id:'edit.ungroup', label:'Desagrupar', key:'Ctrl+Shift+G'},
    {id:'edit.lock', label:'Bloquear'},
    {id:'edit.unlock', label:'Desbloquear'},
    {id:'edit.hide', label:'Ocultar'},
    {id:'edit.show', label:'Mostrar'}
  ],
  selection: [
    {id:'selection.normal', label:'Seleção normal'},
    {id:'selection.direct', label:'Seleção direta'},
    {id:'selection.selectAll', label:'Selecionar tudo', key:'Ctrl+A'},
    {id:'selection.deselectAll', label:'Desselecionar', key:'Esc'},
    {id:'selection.byColor', label:'Selecionar por cor'},
    {id:'selection.byLayer', label:'Selecionar por camada'},
    {id:'selection.similar', label:'Selecionar semelhantes'},
    {id:'selection.isolate', label:'Isolar grupo'},
    {id:'selection.lasso', label:'Seleção por laço'}
  ],
  create: [
    {id:'create.rect', label:'Retângulo'},
    {id:'create.ellipse', label:'Elipse'},
    {id:'create.polygon', label:'Polígono'},
    {id:'create.star', label:'Estrela'},
    {id:'create.line', label:'Linha'},
    {id:'create.pen', label:'Caneta'},
    {id:'create.pencil', label:'Lápis'},
    {id:'create.brush', label:'Pincel vetorial'},
    {id:'create.artText', label:'Texto artístico'},
    {id:'create.textBox', label:'Texto em área'},
    {id:'create.textOnPath', label:'Texto em caminho'},
    {id:'create.eyedropper', label:'Conta-gotas'}
  ],
  transform: [
    {id:'transform.move', label:'Mover'},
    {id:'transform.rotate', label:'Rotacionar'},
    {id:'transform.scale', label:'Escalar'},
    {id:'transform.distort', label:'Distorcer'},
    {id:'transform.skew', label:'Inclinar (Skew)'},
    {id:'transform.flipH', label:'Espelhar horizontal'},
    {id:'transform.flipV', label:'Espelhar vertical'},
    {id:'transform.free', label:'Transformação livre'},
    {id:'transform.align', label:'Alinhar'},
    {id:'transform.distribute', label:'Distribuir'},
    {id:'transform.snapGrid', label:'Ajustar à grade'},
    {id:'transform.snapObjects', label:'Snap em objetos'}
  ],
  appearance: [
    {id:'appearance.fill', label:'Cor de preenchimento'},
    {id:'appearance.stroke', label:'Cor de contorno'},
    {id:'appearance.strokeWidth', label:'Espessura do traço'},
    {id:'appearance.strokeType', label:'Tipo de traço'},
    {id:'appearance.opacity', label:'Opacidade'},
    {id:'appearance.blend', label:'Modos de mesclagem'},
    {id:'appearance.gradient', label:'Gradiente'},
    {id:'appearance.mask', label:'Máscara'},
    {id:'appearance.clipMask', label:'Máscara de recorte'},
    {id:'appearance.effects', label:'Efeitos'}
  ],
  organize: [
    {id:'organize.front', label:'Trazer para frente'},
    {id:'organize.back', label:'Enviar para trás'},
    {id:'organize.byLayer', label:'Organizar por camada'},
    {id:'organize.newLayer', label:'Criar nova camada'},
    {id:'organize.groupLayer', label:'Agrupar por camada'},
    {id:'organize.rename', label:'Nomear objeto'}
  ],
  boolean: [
    {id:'boolean.union', label:'Unir'},
    {id:'boolean.subtract', label:'Subtrair'},
    {id:'boolean.intersect', label:'Interseção'},
    {id:'boolean.exclude', label:'Excluir'},
    {id:'boolean.divide', label:'Dividir'},
    {id:'boolean.trim', label:'Aparar'}
  ],
  text: [
    {id:'text.font', label:'Alterar fonte'},
    {id:'text.size', label:'Tamanho da fonte'},
    {id:'text.lineHeight', label:'Entrelinha'},
    {id:'text.kerning', label:'Kerning'},
    {id:'text.tracking', label:'Tracking'},
    {id:'text.toCurves', label:'Converter texto em curvas'},
    {id:'text.align', label:'Alinhar texto'},
    {id:'text.case', label:'Caixa alta/baixa'}
  ],
  view: [
    {id:'view.zoomIn', label:'Zoom in', key:'Ctrl++'},
    {id:'view.zoomOut', label:'Zoom out', key:'Ctrl+-'},
    {id:'view.fit', label:'Ajustar à tela'},
    {id:'view.fitSelection', label:'Ajustar à seleção'},
    {id:'view.grid', label:'Mostrar/ocultar grade'},
    {id:'view.guides', label:'Mostrar/ocultar guias'},
    {id:'view.nodes', label:'Mostrar nós'},
    {id:'view.outline', label:'Modo outline'},
    {id:'view.preview', label:'Modo preview'}
  ],
  advanced: [
    {id:'advanced.components', label:'Componentes / Símbolos'},
    {id:'advanced.autoLayout', label:'Auto Layout'},
    {id:'advanced.constraints', label:'Constraints'},
    {id:'advanced.vectorize', label:'Vetorização de imagem'},
    {id:'advanced.expandStroke', label:'Expandir traço'},
    {id:'advanced.pathfinder', label:'Pathfinder'},
    {id:'advanced.mesh', label:'Mesh tool'},
    {id:'advanced.warp', label:'Warp'}
  ]
};

const shortcutToCommand = new Map();
Object.values(menuCatalog).flat().forEach(item =&gt; {
  if (!item || item.sep || !item.key) return;
  shortcutToCommand.set(item.key.toLowerCase(), item.id);
});

function registerMenu(rootId, panelId, items){
  const root = $(rootId), panel = $(panelId);
  if(!root || !panel) return;
  panel.innerHTML = items.map(item =&gt; {
    if (item.sep) return '&lt;div class="menu-cmd-sep"&gt;&lt;/div&gt;';
    const key = item.key ? `&lt;span class="k"&gt;${item.key}&lt;/span&gt;` : '&lt;span class="k"&gt;&lt;/span&gt;';
    return `&lt;div class="menu-cmd" data-cmd="${item.id}"&gt;&lt;span&gt;${item.label}&lt;/span&gt;${key}&lt;/div&gt;`;
  }).join('');

  const btn = root.querySelector('.menu-item-btn');
  const closeAll = () =&gt; document.querySelectorAll('.menu-dd.open').forEach(n =&gt; n.classList.remove('open'));
  btn?.addEventListener('click', e =&gt; {
    e.stopPropagation();
    const willOpen = !root.classList.contains('open');
    closeAll();
    if (willOpen) root.classList.add('open');
  });
  panel.addEventListener('click', e =&gt; {
    const cmd = e.target.closest('[data-cmd]')?.dataset.cmd;
    if (!cmd) return;
    executeMenuCommand(cmd);
    closeAll();
  });
}

function notifyTodo(label){
  setStatus(`${label}: em breve.`);
}

function selectAllObjects(){
  const items = canvas.getObjects().filter(o =&gt; !isGuide(o));
  if (!items.length) return;
  canvas.setActiveObject(new fabric.ActiveSelection(items, { canvas }));
  canvas.requestRenderAll();
}

function flipSelection(axis='x'){
  const obj = activeObj();
  if(!obj) return;
  if (axis === 'x') obj.set({ flipX: !obj.flipX });
  else obj.set({ flipY: !obj.flipY });
  obj.setCoords();
  canvas.requestRenderAll();
}

function executeMenuCommand(cmdId){
  const map = {
    'file.new': () =&gt; loadSVGFromParent(''),
    'file.open': () =&gt; $('fileInput')?.click(),
    'file.close': () =&gt; loadSVGFromParent(''),
    'file.save': saveJSON,
    'file.saveAs': saveJSON,
    'file.exportPng': exportPNG,
    'file.exportJpg': () =&gt; notifyTodo('Exportar JPG'),
    'file.exportSvg': exportSVGToParent,
    'file.exportPdf': () =&gt; notifyTodo('Exportar PDF'),
    'file.import': () =&gt; $('fileInput')?.click(),
    'file.document': () =&gt; $('btnMenuDocumento')?.click(),
    'file.preferences': () =&gt; notifyTodo('Preferências'),

    'edit.undo': undo,
    'edit.redo': redo,
    'edit.copy': () =&gt; document.execCommand?.('copy') || setStatus('Use Ctrl+C para copiar.'),
    'edit.paste': pasteFromClipboard,
    'edit.pasteInPlace': pasteFromClipboard,
    'edit.cut': () =&gt; { document.execCommand?.('copy'); del(); },
    'edit.duplicate': duplicate,
    'edit.delete': del,
    'edit.group': groupSelection,
    'edit.ungroup': ungroupSelection,
    'edit.lock': () =&gt; notifyTodo('Bloquear'),
    'edit.unlock': () =&gt; notifyTodo('Desbloquear'),
    'edit.hide': () =&gt; notifyTodo('Ocultar'),
    'edit.show': () =&gt; notifyTodo('Mostrar'),

    'selection.normal': () =&gt; setActiveTool('select'),
    'selection.direct': () =&gt; setActiveTool('direct-select'),
    'selection.selectAll': selectAllObjects,
    'selection.deselectAll': () =&gt; { canvas.discardActiveObject(); canvas.requestRenderAll(); },
    'selection.byColor': () =&gt; notifyTodo('Selecionar por cor'),
    'selection.byLayer': () =&gt; notifyTodo('Selecionar por camada'),
    'selection.similar': () =&gt; notifyTodo('Selecionar semelhantes'),
    'selection.isolate': () =&gt; notifyTodo('Isolar grupo'),
    'selection.lasso': () =&gt; notifyTodo('Seleção por laço'),

    'create.rect': addRect,
    'create.ellipse': addCircle,
    'create.polygon': () =&gt; notifyTodo('Polígono'),
    'create.star': () =&gt; notifyTodo('Estrela'),
    'create.line': addLine,
    'create.pen': addBezier,
    'create.pencil': () =&gt; notifyTodo('Lápis'),
    'create.brush': () =&gt; notifyTodo('Pincel vetorial'),
    'create.artText': () =&gt; setActiveTool('text'),
    'create.textBox': () =&gt; setActiveTool('text'),
    'create.textOnPath': () =&gt; notifyTodo('Texto em caminho'),
    'create.eyedropper': () =&gt; notifyTodo('Conta-gotas'),

    'transform.move': () =&gt; setActiveTool('move'),
    'transform.rotate': () =&gt; notifyTodo('Rotacionar'),
    'transform.scale': () =&gt; notifyTodo('Escalar'),
    'transform.distort': () =&gt; notifyTodo('Distorcer'),
    'transform.skew': () =&gt; notifyTodo('Skew'),
    'transform.flipH': () =&gt; flipSelection('x'),
    'transform.flipV': () =&gt; flipSelection('y'),
    'transform.free': () =&gt; notifyTodo('Transformação livre'),
    'transform.align': () =&gt; notifyTodo('Alinhar'),
    'transform.distribute': () =&gt; notifyTodo('Distribuir'),
    'transform.snapGrid': () =&gt; notifyTodo('Ajustar à grade'),
    'transform.snapObjects': () =&gt; notifyTodo('Snap em objetos'),

    'appearance.fill': () =&gt; notifyTodo('Cor de preenchimento'),
    'appearance.stroke': () =&gt; notifyTodo('Cor de contorno'),
    'appearance.strokeWidth': () =&gt; notifyTodo('Espessura do traço'),
    'appearance.strokeType': () =&gt; notifyTodo('Tipo de traço'),
    'appearance.opacity': () =&gt; notifyTodo('Opacidade'),
    'appearance.blend': () =&gt; notifyTodo('Modos de mesclagem'),
    'appearance.gradient': () =&gt; notifyTodo('Gradiente'),
    'appearance.mask': () =&gt; notifyTodo('Máscara'),
    'appearance.clipMask': applyClipMask,
    'appearance.effects': () =&gt; notifyTodo('Efeitos'),

    'organize.front': bringForwardSelection,
    'organize.back': sendBackwardSelection,
    'organize.byLayer': () =&gt; notifyTodo('Organizar por camada'),
    'organize.newLayer': addLayer,
    'organize.groupLayer': createLayerFolder,
    'organize.rename': () =&gt; notifyTodo('Nomear objeto'),

    'boolean.union': () =&gt; notifyTodo('Boolean: Unir'),
    'boolean.subtract': () =&gt; notifyTodo('Boolean: Subtrair'),
    'boolean.intersect': () =&gt; notifyTodo('Boolean: Interseção'),
    'boolean.exclude': () =&gt; notifyTodo('Boolean: Excluir'),
    'boolean.divide': () =&gt; notifyTodo('Boolean: Dividir'),
    'boolean.trim': () =&gt; notifyTodo('Boolean: Aparar'),

    'text.font': () =&gt; notifyTodo('Alterar fonte'),
    'text.size': () =&gt; notifyTodo('Tamanho da fonte'),
    'text.lineHeight': () =&gt; notifyTodo('Entrelinha'),
    'text.kerning': () =&gt; notifyTodo('Kerning'),
    'text.tracking': () =&gt; notifyTodo('Tracking'),
    'text.toCurves': () =&gt; notifyTodo('Converter texto em curvas'),
    'text.align': () =&gt; notifyTodo('Alinhar texto'),
    'text.case': () =&gt; notifyTodo('Caixa alta/baixa'),

    'view.zoomIn': () =&gt; $('btnZoomIn')?.click(),
    'view.zoomOut': () =&gt; $('btnZoomOut')?.click(),
    'view.fit': fitToArtboard,
    'view.fitSelection': () =&gt; notifyTodo('Ajustar à seleção'),
    'view.grid': () =&gt; notifyTodo('Grade'),
    'view.guides': () =&gt; notifyTodo('Guias'),
    'view.nodes': () =&gt; notifyTodo('Mostrar nós'),
    'view.outline': () =&gt; notifyTodo('Modo outline'),
    'view.preview': () =&gt; notifyTodo('Modo preview'),

    'advanced.components': () =&gt; notifyTodo('Componentes / Símbolos'),
    'advanced.autoLayout': () =&gt; notifyTodo('Auto Layout'),
    'advanced.constraints': () =&gt; notifyTodo('Constraints'),
    'advanced.vectorize': () =&gt; notifyTodo('Vetorização de imagem'),
    'advanced.expandStroke': () =&gt; notifyTodo('Expandir traço'),
    'advanced.pathfinder': () =&gt; notifyTodo('Pathfinder'),
    'advanced.mesh': () =&gt; notifyTodo('Mesh tool'),
    'advanced.warp': () =&gt; notifyTodo('Warp')
  };
  const fn = map[cmdId];
  if (typeof fn === 'function') fn();
  else notifyTodo(cmdId);
}

function normalizeShortcutKey(e){
  const parts = [];
  if (e.ctrlKey || e.metaKey) parts.push('ctrl');
  if (e.shiftKey) parts.push('shift');
  if (e.altKey) parts.push('alt');
  const k = (e.key || '').toLowerCase();
  if (!k) return '';
  const key = k === 'escape' ? 'esc' : k;
  parts.push(key);
  return parts.join('+');
}

(function initCommandMenus(){
  registerMenu('menuFileRoot','menuFilePanel',menuCatalog.file);
  registerMenu('menuEditRoot','menuEditPanel',menuCatalog.edit);
  registerMenu('menuSelectRoot','menuSelectPanel',menuCatalog.selection);
  registerMenu('menuCreateRoot','menuCreatePanel',menuCatalog.create);
  registerMenu('menuTransformRoot','menuTransformPanel',menuCatalog.transform);
  registerMenu('menuAppearanceRoot','menuAppearancePanel',menuCatalog.appearance);
  registerMenu('menuOrganizeRoot','menuOrganizePanel',menuCatalog.organize);
  registerMenu('menuBooleanRoot','menuBooleanPanel',menuCatalog.boolean);
  registerMenu('menuTextRoot','menuTextPanel',menuCatalog.text);
  registerMenu('menuViewRoot','menuViewPanel',menuCatalog.view);
  registerMenu('menuAdvancedRoot','menuAdvancedPanel',menuCatalog.advanced);

  document.addEventListener('click', () =&gt; {
    document.querySelectorAll('.menu-dd.open').forEach(n =&gt; n.classList.remove('open'));
  });

  window.addEventListener('keydown', e =&gt; {
    if (e.target?.matches?.('input,textarea,select,[contenteditable="true"]')) return;
    const cmd = shortcutToCommand.get(normalizeShortcutKey(e));
    if (!cmd) return;
    e.preventDefault();
    executeMenuCommand(cmd);
  }, {passive:false});
})();

// ─── Menu Documento (dropdown) ──────────────────────────
(function initMenuDocumento(){
  const root = $('menuDocRoot');
  const trigger = $('btnMenuDocumento');
  if(!root || !trigger) return;
  trigger.addEventListener('click', e =&gt; {
    e.stopPropagation();
    root.classList.toggle('open');
  });
  document.addEventListener('click', e =&gt; {
    if(!root.contains(e.target)) root.classList.remove('open');
  });
})();

function setBezierSubmenuMode(enabled){
  const labels = enabled
    ? { btnToolVector:'Vetor', btnToolMove:'Finalizar', btnToolLasso:'Inverter', btnToolPaint:'Reta', btnToolCurve:'Editar nós', btnToolCut:'Cortar', btnToolMore:'Mais ▾' }
    : { btnToolVector:'Vetor', btnToolMove:'Mover', btnToolLasso:'Laço', btnToolPaint:'Pintar', btnToolCurve:'Curvar', btnToolCut:'Cortar', btnToolMore:'Mais ▾' };
  Object.entries(labels).forEach(([id, txt]) => {
    const el = $(id);
    if (el) el.textContent = txt;
  });
}

function setActiveTool(tool){
  if (bezierEditor.enabled &amp;&amp; tool !== 'direct-select' &amp;&amp; tool !== 'bezier') finalizeBezierEditor();
  activeTool = tool;
  const isText = tool === 'text';
  const isDirect = tool === 'direct-select';
  canvas.defaultCursor = isText ? 'text' : 'default';
  canvas.selection = !isText;
  canvas.forEachObject(o =&gt; {
    if (isGuide(o) || o.isBezierEditorControl) return;
    o.selectable = !isText;
  });
  document.querySelectorAll('[data-tool]').forEach(btn =&gt; btn.classList.toggle('active', btn.dataset.tool===tool));
  $('btnSelect')?.classList.toggle('active', tool === 'select' || isDirect);
  $('btnSelectNormal')?.classList.toggle('active', tool === 'select');
  $('btnSelectDirect')?.classList.toggle('active', isDirect);
  $('selectToolSubmenu')?.classList.remove('open');
  const tb = $('floatingToolbar');
  if (tb) tb.classList.toggle('show-bezier-submenu', tool === 'bezier');
  setBezierSubmenuMode(tool === 'bezier');
  if (tool === 'move' || tool === 'select') setStatus('Ferramenta mover ativa');
  if (isDirect) setStatus('Seleção direta ativa: selecione uma curva para editar alças.');
  if (tool === 'text') { setStatus('Texto: clique para artístico, arraste para caixa.'); focusTextPanel(true); }
  if (tool === 'bezier') setStatus('Vetor ativo: clique para criar pontos, arraste para alças.');
  canvas.requestRenderAll();
}

// ─── Floating typography panel ──────────────────────────
(function initTextFloatPanel(){
  const panel = $('textFloatPanel');
  if(!panel) return;
  $('btnTypographyGear')?.addEventListener('click', (e)=&gt;{
    e.stopPropagation();
    panel.classList.toggle('open');
    focusTextPanel(true);
    syncFloatingTextPanel();
  });
  $('btnCloseTextFloat')?.addEventListener('click', ()=&gt; panel.classList.remove('open'));
  document.addEventListener('click', e =&gt; {
    if(!panel.classList.contains('open')) return;
    if(panel.contains(e.target) || e.target.id==='btnTypographyGear') return;
    panel.classList.remove('open');
  });
  document.querySelectorAll('[data-tf-tab]').forEach(btn =&gt; {
    btn.addEventListener('click', () =&gt; {
      document.querySelectorAll('[data-tf-tab]').forEach(b=&gt;b.classList.remove('active'));
      btn.classList.add('active');
      const key=btn.dataset.tfTab;
      panel.querySelectorAll('[data-pane]').forEach(p=&gt;p.classList.toggle('active', p.dataset.pane===key));
    });
  });

  const applyText = (fn)=&gt;{
    const obj = activeObj();
    if(!isTextObject(obj)) { setStatus('Selecione um texto para editar.'); return; }
    fn(obj);
    syncTextStyleRender(obj);
    canvas.requestRenderAll();
    refreshProps();
  };
  $('tfFontSize')?.addEventListener('input', ()=&gt; applyText(obj=&gt;obj.set({fontSize: clamp(Number($('tfFontSize').value)||16,6,512)})));
  $('tfColor')?.addEventListener('input', ()=&gt; applyText(obj=&gt;obj.set({fill:$('tfColor').value||obj.fill})));
  $('tfLineHeight')?.addEventListener('input', ()=&gt; applyText(obj=&gt;obj.set({lineHeight: clamp(Number($('tfLineHeight').value)||1.2,0.6,4)})));
  $('tfLetterSpacing')?.addEventListener('input', ()=&gt; applyText(obj=&gt;obj.set({charSpacing: (Number($('tfLetterSpacing').value)||0)*50})));
  $('tfWeight')?.addEventListener('change', ()=&gt; applyText(obj=&gt;obj.set({fontWeight: Number($('tfWeight').value)||400})));
  $('tfStyle')?.addEventListener('change', ()=&gt; applyText(obj=&gt;obj.set({fontStyle: $('tfStyle').value||'normal'})));
  document.querySelectorAll('#tfAlignSeg .seg-opt').forEach(btn =&gt; {
    btn.addEventListener('click', ()=&gt; applyText(obj=&gt;obj.set({textAlign: btn.dataset.val||'left'})));
  });
  $('tfUnderline')?.addEventListener('click', ()=&gt; applyText(obj=&gt;obj.set({underline: !obj.underline})));
  $('tfStrike')?.addEventListener('click', ()=&gt; applyText(obj=&gt;obj.set({linethrough: !obj.linethrough})));
  $('tfUppercase')?.addEventListener('click', ()=&gt; applyText(obj=&gt;obj.text &amp;&amp; obj.set({text: String(obj.text).toUpperCase()})));
  $('tfLowercase')?.addEventListener('click', ()=&gt; applyText(obj=&gt;obj.text &amp;&amp; obj.set({text: String(obj.text).toLowerCase()})));
})();

// ─── Bind toolbar buttons ─────────────────────────────────
$('btnSelect')?.addEventListener('click', (e) =&gt; {
  e.stopPropagation();
  if (activeTool === 'select' || activeTool === 'direct-select') {
    $('selectToolSubmenu')?.classList.toggle('open');
    return;
  }
  setActiveTool('select');
});
$('btnSelectNormal')?.addEventListener('click', () =&gt; setActiveTool('select'));
$('btnSelectDirect')?.addEventListener('click', () =&gt; setActiveTool('direct-select'));
document.addEventListener('click', e =&gt; {
  const sub = $('selectToolSubmenu');
  if (!sub) return;
  if (sub.contains(e.target) || $('btnSelect')?.contains(e.target)) return;
  sub.classList.remove('open');
});
$('btnToolVector')?.addEventListener('click', () =&gt; {
  if (activeTool === 'bezier' || vectorToolState.mode === 'creating') return startBezierCreation();
  setActiveTool('select');
});
$('btnToolMove')?.addEventListener('click', () =&gt; {
  if (activeTool==='bezier' &amp;&amp; vectorToolState.mode === 'creating') {
    const path = finishBezierCreation({toEditing:true});
    if (path) setActiveTool('direct-select');
    return;
  }
  if (activeTool==='direct-select' &amp;&amp; bezierEditor.enabled) return finalizeBezierEditor();
  setActiveTool('move');
});
$('btnTextTool')?.addEventListener('click', () =&gt; setActiveTool('text'));
$('btnRect')?.addEventListener('click', () =&gt; { setActiveTool('select'); addRect(); });
$('btnCircle')?.addEventListener('click', () =&gt; { setActiveTool('select'); addCircle(); });
$('btnCreateLayer')?.addEventListener('click', addLayer);
$('btnLine')?.addEventListener('click', () =&gt; { setActiveTool('select'); addLine(); });
$('btnBezier')?.addEventListener('click', () =&gt; { setActiveTool('bezier'); startBezierCreation(); });
$('btnUpload')?.addEventListener('click', () =&gt; $('fileInput')?.click());
$('btnImportFile')?.addEventListener('click', () =&gt; $('fileInput')?.click());
$('btnNewArtboard')?.addEventListener('click', () =&gt; addAdjacentArtboard('right'));
$('btnToolLasso')?.addEventListener('click', () =&gt; { if (activeTool==='bezier' || activeTool==='direct-select') return reverseBezierDirection(); setStatus('Laço: em breve.'); });
$('btnToolPaint')?.addEventListener('click', () =&gt; { if (activeTool==='bezier' || activeTool==='direct-select') return convertBezierToLine(); setStatus('Pintar: em breve.'); });
$('btnToolCurve')?.addEventListener('click', () =&gt; { const obj=activeObj(); if (pathIsBezierEditable(obj)) { setActiveTool('direct-select'); attachBezierEditor(obj); return; } setStatus('Selecione uma curva para editar nós.'); });
$('btnToolCut')?.addEventListener('click', () =&gt; { if (activeTool==='bezier' || activeTool==='direct-select') { const obj=activeObj(); if (pathIsBezierEditable(obj)) return attachBezierEditor(obj); } applyClipMask(); });
$('btnToolMore')?.addEventListener('click', () =&gt; setStatus('Mais ferramentas em breve.'));
$('btnFit')?.addEventListener('click', fitToArtboard);
$('btnZoomReset')?.addEventListener('click', fitToArtboard);
$('btnZoomIn')?.addEventListener('click', () =&gt; {
  const newZoom = clamp(zoom*1.15, 0.05, 10);
  canvas.zoomToPoint(new fabric.Point(canvas.getWidth()/2, canvas.getHeight()/2), newZoom);
  zoom = newZoom; updateZoomLabel();
  updateArtboardPlusUI();
});
$('btnZoomOut')?.addEventListener('click', () =&gt; {
  const newZoom = clamp(zoom/1.15, 0.05, 10);
  canvas.zoomToPoint(new fabric.Point(canvas.getWidth()/2, canvas.getHeight()/2), newZoom);
  zoom = newZoom; updateZoomLabel();
  updateArtboardPlusUI();
});
$('btnDelete')?.addEventListener('click', del);
$('btnDuplicate')?.addEventListener('click', duplicate);
$('btnUndo')?.addEventListener('click', undo);
$('btnRedo')?.addEventListener('click', redo);
$('btnExportPng')?.addEventListener('click', exportPNG);
$('btnQuickExportPng')?.addEventListener('click', exportPNG);
$('btnSaveJson')?.addEventListener('click', saveJSON);
$('btnLoadJson')?.addEventListener('click', loadJSON);
$('btnApplyDoc')?.addEventListener('click', () =&gt; {
  const w = Number($('docW').value)||docW;
  const h = Number($('docH').value)||docH;
  setArtboardSize(w, h);
  setDeskBg($('docBg').value || deskBg);
  setDeskTheme($('deskTheme')?.value || 'nebula');
});
$('btnArtboardMode')?.addEventListener('click', () =&gt; {
  artboardMode = !artboardMode;
  $('btnArtboardMode').classList.toggle('accent', artboardMode);
  setStatus(artboardMode ? 'Modo pranchetas ativo: use os botões + ao redor da prancheta.' : 'Modo pranchetas desativado');
  updateArtboardPlusUI();
});
$('btnAddArtTop')?.addEventListener('click', () =&gt; addAdjacentArtboard('top'));
$('btnAddArtRight')?.addEventListener('click', () =&gt; addAdjacentArtboard('right'));
$('btnAddArtBottom')?.addEventListener('click', () =&gt; addAdjacentArtboard('bottom'));
$('btnAddArtLeft')?.addEventListener('click', () =&gt; addAdjacentArtboard('left'));
$('btnCenterAll')?.addEventListener('click', () =&gt; {
  const obj = activeObj(); if(!obj||!artboard) return;
  obj.set({ left:artboard.left+docW/2-obj.getScaledWidth()/2, top:artboard.top+docH/2-obj.getScaledHeight()/2 });
  obj.setCoords(); canvas.requestRenderAll();
});
$('btnAlignLeft')?.addEventListener('click', () =&gt; alignSelection('left'));
$('btnAlignCenter')?.addEventListener('click', () =&gt; alignSelection('center'));
$('btnAlignRight')?.addEventListener('click', () =&gt; alignSelection('right'));
$('btnAlignTop')?.addEventListener('click', () =&gt; alignSelection('top'));
$('btnAlignBottom')?.addEventListener('click', () =&gt; alignSelection('bottom'));
$('btnAlignMiddle')?.addEventListener('click', () =&gt; alignSelection('middle'));
$('btnDistributeX')?.addEventListener('click', () =&gt; distributeSelection('x'));
$('btnDistributeY')?.addEventListener('click', () =&gt; distributeSelection('y'));
$('btnGroup')?.addEventListener('click', groupSelection);
$('btnUngroup')?.addEventListener('click', ungroupSelection);
$('btnClipMask')?.addEventListener('click', applyClipMask);
$('btnReleaseClip')?.addEventListener('click', releaseClipMask);
$('btnNewFolder')?.addEventListener('click', createLayerFolder);
$('btnLoadFont')?.addEventListener('click', loadGoogleFontForSelection);



// abas do painel direito
$('propTabs')?.addEventListener('click', e =&gt; {
  const tab = e.target.closest('.panel-tab');
  if(!tab) return;
  const key = tab.dataset.tab;
  document.querySelectorAll('.panel-tab').forEach(t =&gt; t.classList.toggle('active', t===tab));
  document.querySelectorAll('[data-tab-panel]').forEach(p =&gt; {
    p.style.display = p.dataset.tabPanel===key ? '' : 'none';
  });
});

function bindMirror(a,b,transformA=(v=&gt;v),transformB=(v=&gt;v)){
  const A=$(a), B=$(b);
  if(!A||!B) return;
  let lock=false;
  const sync = (from,to,fn) =&gt; {
    from.addEventListener('input',()=&gt;{
      if(lock) return;
      lock=true; to.value = fn(from.value); to.dispatchEvent(new Event('input',{bubbles:true})); lock=false;
    });
  };
  sync(A,B,transformA); sync(B,A,transformB);
}
bindMirror('pStroke','pStroke2');
bindMirror('pStrokeW','pStrokeW2',v=&gt;v,v=&gt;v);
bindMirror('pStrokeW2','pStrokeWRange2',v=&gt;v,v=&gt;v);
bindMirror('pBlend','pBlend2');

(function bindOpacityMirror(){
  const src=$('pO'), num=$('pOpacity2'), range=$('pOpacityRange2');
  if(!src||!num||!range) return;
  let lock=false;
  src.addEventListener('input',()=&gt;{
    if(lock) return; lock=true;
    const pct=Math.round((Number(src.value)||0)*100);
    num.value=String(pct); range.value=String(pct);
    lock=false;
  });
  const push=()=&gt;{
    if(lock) return; lock=true;
    const pct=Math.max(0,Math.min(100,Number(num.value||range.value)||0));
    num.value=String(Math.round(pct)); range.value=String(Math.round(pct));
    src.value=String((pct/100).toFixed(2));
    src.dispatchEvent(new Event('input',{bubbles:true}));
    lock=false;
  };
  num.addEventListener('input',push);
  range.addEventListener('input',()=&gt;{num.value=range.value;push();});
})();

function bindStrokeOptionGroup(selector, cb){
  document.querySelectorAll(selector).forEach(btn =&gt; {
    btn.addEventListener('click',()=&gt;{
      const group=btn.parentElement?.querySelectorAll(selector) || [];
      group.forEach(x=&gt;x.classList.remove('active'));
      btn.classList.add('active');
      cb?.(btn.dataset);
    });
  });
}
bindStrokeOptionGroup('[data-stroke-cap]', data =&gt; {
  const obj=activeObj(); if(!obj) return;
  obj.set({strokeLineCap:data.strokeCap}); canvas.requestRenderAll();
});
bindStrokeOptionGroup('[data-stroke-join]', data =&gt; {
  const obj=activeObj(); if(!obj) return;
  obj.set({strokeLineJoin:data.strokeJoin}); canvas.requestRenderAll();
});

$('btnHelp')?.addEventListener('click', () =&gt; {
  openModal('Atalhos de teclado', `
    &lt;div class=&quot;shortcuts-grid&quot; style=&quot;gap:8px 16px&quot;&gt;
      &lt;span class=&quot;sc-key&quot;&gt;Ctrl+Z&lt;/span&gt;&lt;span class=&quot;sc-desc&quot;&gt;Desfazer&lt;/span&gt;
      &lt;span class=&quot;sc-key&quot;&gt;Ctrl+Y&lt;/span&gt;&lt;span class=&quot;sc-desc&quot;&gt;Refazer&lt;/span&gt;
      &lt;span class=&quot;sc-key&quot;&gt;Ctrl+D&lt;/span&gt;&lt;span class=&quot;sc-desc&quot;&gt;Duplicar&lt;/span&gt;
      &lt;span class=&quot;sc-key&quot;&gt;Ctrl+G&lt;/span&gt;&lt;span class=&quot;sc-desc&quot;&gt;Agrupar seleção&lt;/span&gt;
      &lt;span class=&quot;sc-key&quot;&gt;Ctrl+Shift+G&lt;/span&gt;&lt;span class=&quot;sc-desc&quot;&gt;Desagrupar seleção&lt;/span&gt;
      &lt;span class=&quot;sc-key&quot;&gt;Del&lt;/span&gt;&lt;span class=&quot;sc-desc&quot;&gt;Apagar seleção&lt;/span&gt;
      &lt;span class=&quot;sc-key&quot;&gt;Espaço&lt;/span&gt;&lt;span class=&quot;sc-desc&quot;&gt;Arrastar viewport&lt;/span&gt;
      &lt;span class=&quot;sc-key&quot;&gt;Scroll&lt;/span&gt;&lt;span class=&quot;sc-desc&quot;&gt;Zoom suave&lt;/span&gt;
      &lt;span class=&quot;sc-key&quot;&gt;Botão do meio&lt;/span&gt;&lt;span class=&quot;sc-desc&quot;&gt;Pan&lt;/span&gt;
    &lt;/div&gt;
  `);
});

// ─── postMessage (brand data from parent) ────────────────
window.addEventListener('message', ev =&gt; {
  const msg = ev.data || {};
  if (msg.type === 'setDoc') {
    setArtboardSize(Number(msg.w)||docW, Number(msg.h)||docH);
    if (msg.fit) fitToArtboard();
  }
  if (msg.type === 'fit') fitToArtboard();
  if (msg.type === 'exportPNG') exportPNG();
  if (msg.type === 'exportSVG') exportSVGToParent();
  if (msg.type === 'setSVG') loadSVGFromParent(msg.svg);
  if (msg.type === 'setBrand') {
    if (Array.isArray(msg.library)) {
      brandLibrary = msg.library.slice(0,80);
      refreshLibrary();
    }
    if (Array.isArray(msg.fonts) &amp;&amp; UI.font) {
      const existing = new Set(Array.from(UI.font.options).map(o=&gt;o.value));
      msg.fonts.forEach(f =&gt; {
        const ff = String(f||'').trim();
        if(!ff||existing.has(ff)) return;
        const opt = document.createElement('option');
        opt.value = ff; opt.textContent = ff;
        UI.font.appendChild(opt); existing.add(ff);
      });
    }
  }
});

// ─── Boot ────────────────────────────────────────────────
function boot() {
  requestAnimationFrame(() =&gt; requestAnimationFrame(() =&gt; {
    resizeCanvasToViewport();
    setDeskBg(deskBg);
    setDeskTheme('nebula');
    ensureArtboard();
    fitToArtboard();
    updateZoomLabel();
    updateArtboardPlusUI();
    refreshLibrary();

    const ro = new ResizeObserver(() =&gt; {
      resizeCanvasToViewport();
      fitToArtboard();
      updateArtboardPlusUI();
    });
    ro.observe(stageEl);
    window.addEventListener('resize', () =&gt; { resizeCanvasToViewport(); fitToArtboard(); updateArtboardPlusUI(); });
    snapshot();
  }));
}
boot();
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;

</template>

<style>
  .ge-onecol{ grid-template-columns: 1fr !important; }
  .ge-iframeWrap{ min-height:0; padding:0; display:flex; flex-direction:column; overflow:hidden; }
  .ge-iframeWrap iframe{ flex:1; min-height:0; width:100%; border:0; display:block; }
</style>

<script src="script.js"></script>
</body>
</html>
