(()=>{const $=id=>document.getElementById(id),NS='http://www.w3.org/2000/svg';window.setCanvasBg=function(mode,el){const area=$("prevFinal");area.className="canvas-area";if(mode==='white')area.style.background='#fff';else if(mode==='black')area.style.background='#000';else area.style.background='';document.querySelectorAll('.bg-toggle').forEach(b=>b.classList.remove('active'));el.classList.add('active')};
function clearNode(n){while(n.firstChild)n.removeChild(n.firstChild)}
function setBadge(el,text,kind){el.textContent=text;el.classList.remove('ok','bad','warn');if(kind)el.classList.add(kind)}
function sanitizeName(s){return(s||"").trim().replace(/[\\/:*?"<>|]/g,"_").replace(/\s+/g,"-").replace(/-+/g,"-").toLowerCase().slice(0,80)||"arquivo"}
function readFileAsText(f){return new Promise((res,rej)=>{const r=new FileReader();r.onerror=()=>rej(new Error('Falha ao ler arquivo.'));r.onload=()=>res(String(r.result||''));r.readAsText(f)})}
function safeParseSVG(t){const d=new DOMParser().parseFromString(t,'image/svg+xml');const s=d.querySelector('svg');const e=d.querySelector('parsererror');if(e||!s) throw new Error(e?e.textContent:'SVG invÃ¡lido');return s}
function cloneIntoSVGElement(svgEl){const i=document.importNode(svgEl,true);if(!i.getAttribute('xmlns')) i.setAttribute('xmlns',NS);return i}
function measureBBox(svgEl){const m=$('measure');clearNode(m);const h=document.createElementNS(NS,'g');const i=cloneIntoSVGElement(svgEl);Array.from(i.childNodes).forEach(k=>h.appendChild(k));m.appendChild(h);return h.getBBox()}
function normalizeViewBox(svgEl,b){const s=document.createElementNS(NS,'svg');s.setAttribute('xmlns',NS);s.setAttribute('viewBox',`${b.x} ${b.y} ${b.width} ${b.height}`);s.setAttribute('width',b.width);s.setAttribute('height',b.height);const i=cloneIntoSVGElement(svgEl);Array.from(i.childNodes).forEach(n=>s.appendChild(n));return s}
function serializeSVG(s){return new XMLSerializer().serializeToString(s)}
function downloadBlob(blob,filename){const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),3000)}
function applySolidColor(svgText,hex){const svg=safeParseSVG(svgText),cl=cloneIntoSVGElement(svg);const walker=document.createTreeWalker(cl,NodeFilter.SHOW_ELEMENT);while(walker.nextNode()){const el=walker.currentNode,tag=(el.tagName||'').toLowerCase();if(['defs','lineargradient','radialgradient','stop','pattern','mask','clippath'].includes(tag)) continue;const fill=el.getAttribute('fill'),stroke=el.getAttribute('stroke');if(fill!=='none')el.setAttribute('fill',hex);if(stroke!=='none')el.setAttribute('stroke',hex)}if(!cl.getAttribute('xmlns'))cl.setAttribute('xmlns',NS);return serializeSVG(cl)}
const brand={symbol:null,logo1:null,logo2:null,finalSVG:null,assets:[]},uid=()=>crypto.randomUUID?.()||Math.random().toString(36).slice(2);
const defaultPalette=[{id:uid(),enabled:true,name:'branco',hex:'#ffffff'},{id:uid(),enabled:true,name:'preto',hex:'#111111'},{id:uid(),enabled:true,name:'roxo',hex:'#7f5af0'}]; let palette=JSON.parse(JSON.stringify(defaultPalette));
function computeX(){const mode=$('xMode').value,manual=Math.max(1,Number($('xManual').value||1)),div=Math.max(1,Number($('xDiv').value||1));if(mode==='manual')return manual;if(mode==='fromSymbol')return brand.symbol?.bbox?.height?Math.max(1,brand.symbol.bbox.height/div):manual;if(mode==='fromLogo1')return brand.logo1?.bbox?.height?Math.max(1,brand.logo1.bbox.height/div):manual;return manual}
function placeAssetChildren(assetSvg,scale,tx,ty){const gg=document.createElementNS(NS,'g');gg.setAttribute('transform',`translate(${tx} ${ty}) scale(${scale})`);const i=cloneIntoSVGElement(assetSvg);Array.from(i.childNodes).forEach(n=>gg.appendChild(n));return gg}
function makeFinalMark({colorHex,markLayout,typeLayout}){if(!brand.symbol||!brand.logo1)return null;const x=computeX(),symScaleX=Number($('symScale').value),gapX=Number($('gap').value),logoGapX=Number($('logoGap').value),padX=Number($('pad').value);
const sym=safeParseSVG(applySolidColor(brand.symbol.raw,colorHex)),l1=safeParseSVG(applySolidColor(brand.logo1.raw,colorHex));const l2=brand.logo2?safeParseSVG(applySolidColor(brand.logo2.raw,colorHex)):null;
const symBBox=measureBBox(sym),l1BBox=measureBBox(l1),l2BBox=l2?measureBBox(l2):null;const symN=normalizeViewBox(sym,symBBox),l1N=normalizeViewBox(l1,l1BBox),l2N=l2?normalizeViewBox(l2,l2BBox):null;
const desiredSymH=symScaleX*x,symH0=Number(symN.getAttribute('height'))||1,symW0=Number(symN.getAttribute('width'))||1,symScale=desiredSymH/symH0,symW=symW0*symScale,symH=symH0*symScale;
const l1H0=Number(l1N.getAttribute('height'))||1,l1W0=Number(l1N.getAttribute('width'))||1,hasL2=!!l2N,l2H0=hasL2?Number(l2N.getAttribute('height'))||1:0,l2W0=hasL2?Number(l2N.getAttribute('width'))||1:0,targetTypeH=Math.max(x*2,desiredSymH*.82);
let typeW0,typeH0;if(!hasL2){typeW0=l1W0;typeH0=l1H0}else if(typeLayout==='stack'){typeW0=Math.max(l1W0,l2W0);typeH0=l1H0+(logoGapX*x)+l2H0}else{typeW0=l1W0+(logoGapX*x)+l2W0;typeH0=Math.max(l1H0,l2H0)}
const typeScale=targetTypeH/(typeH0||1),typeW=typeW0*typeScale,typeH=typeH0*typeScale,gap=gapX*x,pad=padX*x;let contentW,contentH;if(markLayout==='horizontal'){contentW=symW+gap+typeW;contentH=Math.max(symH,typeH)}else{contentW=Math.max(symW,typeW);contentH=symH+gap+typeH}
const finalW=contentW+pad*2,finalH=contentH+pad*2,svg=document.createElementNS(NS,'svg');svg.setAttribute('xmlns',NS);svg.setAttribute('width',finalW);svg.setAttribute('height',finalH);svg.setAttribute('viewBox',`0 0 ${finalW} ${finalH}`);const g=document.createElementNS(NS,'g');svg.appendChild(g);
if(markLayout==='horizontal'){const symX=pad,symY=pad+(contentH-symH)/2,typeX=pad+symW+gap,typeY=pad+(contentH-typeH)/2;g.appendChild(placeAssetChildren(symN,symScale,symX,symY));if(!hasL2)g.appendChild(placeAssetChildren(l1N,typeScale,typeX,typeY));else if(typeLayout==='stack'){g.appendChild(placeAssetChildren(l1N,typeScale,typeX,typeY));g.appendChild(placeAssetChildren(l2N,typeScale,typeX,typeY+(l1H0*typeScale)+(logoGapX*x)))}else{g.appendChild(placeAssetChildren(l1N,typeScale,typeX,typeY+(typeH-l1H0*typeScale)/2));g.appendChild(placeAssetChildren(l2N,typeScale,typeX+(l1W0*typeScale)+(logoGapX*x),typeY+(typeH-l2H0*typeScale)/2))}}
else{const symX=pad+(contentW-symW)/2,symY=pad,typeX=pad+(contentW-typeW)/2,typeY=pad+symH+gap;g.appendChild(placeAssetChildren(symN,symScale,symX,symY));if(!hasL2)g.appendChild(placeAssetChildren(l1N,typeScale,typeX,typeY));else if(typeLayout==='stack'){g.appendChild(placeAssetChildren(l1N,typeScale,typeX,typeY));g.appendChild(placeAssetChildren(l2N,typeScale,typeX,typeY+(l1H0*typeScale)+(logoGapX*x)));}else{g.appendChild(placeAssetChildren(l1N,typeScale,typeX,typeY+(typeH-l1H0*typeScale)/2));g.appendChild(placeAssetChildren(l2N,typeScale,typeX+(l1W0*typeScale)+(logoGapX*x),typeY+(typeH-l2H0*typeScale)/2))}}
return{svgEl:svg,raw:serializeSVG(svg),w:finalW,h:finalH,x,markLayout,typeLayout,colorHex}}
function renderPalette(){const box=$('paletteList');clearNode(box);palette.forEach(c=>{const row=document.createElement('div');row.className='palette-item';const chk=document.createElement('input');chk.type='checkbox';chk.checked=!!c.enabled;chk.addEventListener('change',()=>{c.enabled=chk.checked;rebuildVariantSelect()});const sw=document.createElement('div');sw.className='color-swatch';sw.style.background=c.hex;const cp=document.createElement('input');cp.type='color';cp.value=c.hex;cp.addEventListener('input',()=>{c.hex=cp.value;hexIn.value=cp.value;sw.style.background=c.hex;rebuildVariantSelect();renderPreviews()});sw.appendChild(cp);const nm=document.createElement('input');nm.type='text';nm.value=c.name;nm.addEventListener('input',()=>{c.name=sanitizeName(nm.value).replace(/_/g,'-')||'cor';rebuildVariantSelect()});const hexIn=document.createElement('input');hexIn.type='text';hexIn.value=c.hex;hexIn.className='hex-input';hexIn.addEventListener('input',()=>{c.hex=hexIn.value.trim();sw.style.background=c.hex;rebuildVariantSelect();renderPreviews()});const del=document.createElement('button');del.className='icon-btn';del.textContent='Ã—';del.addEventListener('click',()=>{palette=palette.filter(x=>x.id!==c.id);rebuildVariantSelect();renderPalette();renderPreviews()});row.append(chk,sw,nm,hexIn,del);box.appendChild(row)})}
function rebuildVariantSelect(){const sel=$('previewVariant'),prev=sel.value;clearNode(sel);palette.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=`${c.enabled?'â— ':'â—‹ '}${c.name} (${c.hex})`;sel.appendChild(o)});if(palette.some(c=>c.id===prev))sel.value=prev;else sel.value=palette[0]?.id||''}
function updateLabels(){const x=computeX();$('xValueLabel').textContent=`(X = ${Math.round(x)}px)`;$('symScaleLabel').textContent=`${$('symScale').value}X`;$('gapLabel').textContent=`${$('gap').value}X`;$('logoGapLabel').textContent=`${$('logoGap').value}X`;$('padLabel').textContent=`${$('pad').value}X`}
function renderPreviews(){updateLabels();['prevSymbol','prevLogo1','prevLogo2','prevFinal'].forEach(i=>clearNode($(i)));if(brand.symbol){$('prevSymbol').appendChild(normalizeViewBox(brand.symbol.svgEl,brand.symbol.bbox));setBadge($('bSymbol'),'OK','ok')}else setBadge($('bSymbol'),'â€”','');if(brand.logo1){$('prevLogo1').appendChild(normalizeViewBox(brand.logo1.svgEl,brand.logo1.bbox));setBadge($('bLogo1'),'OK','ok')}else setBadge($('bLogo1'),'â€”','');if(brand.logo2){$('prevLogo2').appendChild(normalizeViewBox(brand.logo2.svgEl,brand.logo2.bbox));setBadge($('bLogo2'),'OK','ok')}else setBadge($('bLogo2'),'Opcional','');
const color=palette.find(c=>c.id===$('previewVariant').value)||palette[0];const mk=$('markLayout').value,tl=$('typeLayout').value,final=makeFinalMark({colorHex:color?.hex||'#fff',markLayout:mk,typeLayout:tl});brand.finalSVG=final;['btnExportSVG','btnExportPNG','btnGenerateAssets','btnGoFolders'].forEach(i=>$(i).disabled=!final);if(final){$('prevFinal').appendChild(final.svgEl);setBadge($('readyBadge'),'Render OK','ok');setBadge($('renderStatus'),'OK','ok');$('statusDot').className='status-dot ok';$('globalStatus').textContent='Pronto para exportar';$('variantBadge').textContent=`${color.name} Â· ${color.hex}`;$('metaBar').innerHTML=`<span><b>X</b> ${Math.round(final.x)}px</span><span><b>W</b> ${Math.round(final.w)}px</span><span><b>H</b> ${Math.round(final.h)}px</span><span><b>Layout</b> ${mk} / ${tl}</span>`}else{$('prevFinal').innerHTML=`<div class='empty-state'><div class='icon'>â—</div><p>Carregue o SÃ­mbolo e Logo 1<br>para visualizar a composiÃ§Ã£o.</p></div>`;setBadge($('readyBadge'),'Aguardando','');setBadge($('renderStatus'),'Aguardando','');$('variantBadge').textContent='â€”';$('statusDot').className='status-dot';$('globalStatus').textContent='Aguardando arquivos'}}
async function handleUpload(fileInput,slot){const file=fileInput.files?.[0];const statusEl=slot==='symbol'?$('statusSymbol'):slot==='logo1'?$('statusLogo1'):$('statusLogo2');try{if(!file){brand[slot]=null;statusEl.textContent='Nenhum arquivo.';statusEl.className='upload-status';renderPreviews();return}const text=await readFileAsText(file),parsed=safeParseSVG(text),bbox=measureBBox(parsed);brand[slot]={raw:text,svgEl:parsed,bbox,name:file.name};statusEl.textContent=`âœ“ ${file.name} Â· ${Math.round(bbox.width)}Ã—${Math.round(bbox.height)}px`;statusEl.className='upload-status ok';renderPreviews()}catch(err){brand[slot]=null;statusEl.textContent=`âœ— Erro: ${String(err?.message||err)}`;statusEl.className='upload-status bad';renderPreviews()}}
$('fileSymbol').addEventListener('change',e=>handleUpload(e.target,'symbol'));$('fileLogo1').addEventListener('change',e=>handleUpload(e.target,'logo1'));$('fileLogo2').addEventListener('change',e=>handleUpload(e.target,'logo2'));
['brandBaseName','markLayout','typeLayout','xMode','xManual','xDiv','symScale','gap','logoGap','pad','pngBg','previewVariant'].forEach(id=>$(id).addEventListener('input',renderPreviews));
$('btnAddColor').addEventListener('click',()=>{palette.push({id:uid(),enabled:true,name:'nova-cor',hex:'#888888'});renderPalette();rebuildVariantSelect();renderPreviews()});$('btnResetPalette').addEventListener('click',()=>{palette=JSON.parse(JSON.stringify(defaultPalette));renderPalette();rebuildVariantSelect();renderPreviews()});
$('btnExportSVG').addEventListener('click',()=>{if(!brand.finalSVG)return;const base=sanitizeName($('brandBaseName').value),c=palette.find(x=>x.id===$('previewVariant').value)||palette[0];downloadBlob(new Blob([brand.finalSVG.raw],{type:'image/svg+xml;charset=utf-8'}),`${base}_${brand.finalSVG.markLayout}_${brand.finalSVG.typeLayout}_${sanitizeName(c.name)}.svg`)});
$('btnExportPNG').addEventListener('click',async()=>{if(!brand.finalSVG)return;const base=sanitizeName($('brandBaseName').value),c=palette.find(x=>x.id===$('previewVariant').value)||palette[0];const encoded=encodeURIComponent(brand.finalSVG.raw).replace(/'/g,'%27').replace(/"/g,'%22');const img=new Image();await new Promise((res,rej)=>{img.onload=res;img.onerror=()=>rej(new Error('RasterizaÃ§Ã£o falhou.'));img.src=`data:image/svg+xml;charset=utf-8,${encoded}`});const w=Math.ceil(brand.finalSVG.w*2),h=Math.ceil(brand.finalSVG.h*2),canvas=document.createElement('canvas');canvas.width=w;canvas.height=h;const ctx=canvas.getContext('2d');if($('pngBg').value==='white'){ctx.fillStyle='#fff';ctx.fillRect(0,0,w,h)}else ctx.clearRect(0,0,w,h);ctx.drawImage(img,0,0,w,h);canvas.toBlob(blob=>downloadBlob(blob,`${base}_${brand.finalSVG.markLayout}_${brand.finalSVG.typeLayout}_${sanitizeName(c.name)}_${$('pngBg').value}.png`),'image/png')});
function enabledColors(){return palette.filter(c=>c.enabled)}
function buildName({ext,mark,type,color,bg}){const tpl=($('nameTemplate')?.value||'{brand}_{mark}_{type}_{color}_{bg}.{ext}').trim(),brandName=sanitizeName($('brandBaseName').value);return tpl.replaceAll('{brand}',brandName).replaceAll('{mark}',mark).replaceAll('{type}',type).replaceAll('{color}',sanitizeName(color)).replaceAll('{bg}',sanitizeName(bg||'')).replaceAll('{ext}',ext)}
$('btnGenerateAssets').addEventListener('click',()=>{if(!brand.finalSVG)return;const colors=enabledColors(),layouts=[{mark:'horizontal',type:'stack'},{mark:'horizontal',type:'inline'},{mark:'vertical',type:'stack'},{mark:'vertical',type:'inline'}],pngBg=$('pngBg').value;brand.assets=[];for(const {mark,type} of layouts){for(const c of colors){const result=makeFinalMark({colorHex:c.hex,markLayout:mark,typeLayout:type});if(!result)continue;const svgFile={id:uid(),kind:'svg',data:result.raw,svgSource:result.raw,meta:{mark,type,color:c.name,bg:''},ext:'svg',filename:buildName({ext:'svg',mark,type,color:c.name,bg:''})};brand.assets.push(svgFile);const pngFile={id:uid(),kind:'png',svgSource:result.raw,pngBg,meta:{mark,type,color:c.name,bg:pngBg},ext:'png',filename:buildName({ext:'png',mark,type,color:c.name,bg:pngBg})};brand.assets.push(pngFile)}}renderFilesList();$('btnGoFolders').disabled=false});
$('btnGoFolders').addEventListener('click',()=>{renderFilesList();renderTree();setTab('folders')});
function setTab(tab){$('viewBrand').style.display=tab==='brand'?'':'none';$('viewFolders').style.display=tab==='folders'?'':'none';$('tabBrand').classList.toggle('active',tab==='brand');$('tabFolders').classList.toggle('active',tab==='folders')} $('tabBrand').addEventListener('click',()=>setTab('brand'));$('tabFolders').addEventListener('click',()=>{renderFilesList();renderTree();setTab('folders')});
const fb={tree:[],selectedId:null};function toJSON(nodes=fb.tree){return nodes.map(n=>({name:n.name,files:n.files||[],children:toJSON(n.children||[])}))}
function renderTree(){const root=$('treeRoot');clearNode(root);$('emptyHint').style.display=fb.tree.length?'none':'flex';$('countBadge').textContent=`${fb.tree.length} pasta${fb.tree.length!==1?'s':''}`;for(const n of fb.tree) root.appendChild(buildNodeEl(n));$('jsonPreview').textContent=JSON.stringify({root:sanitizeName($('rootFolderName').value)||'BrandPackage',template:$('nameTemplate').value,tree:toJSON()},null,2)}
function findNodeAndParent(nodes,id,parent=null){for(const n of nodes){if(n.id===id)return{node:n,parent};const f=findNodeAndParent(n.children||[],id,n);if(f)return f}return null}
function removeNode(id){function rem(nodes){return nodes.filter(n=>{n.children=rem(n.children||[]);return n.id!==id})}fb.tree=rem(fb.tree);if(fb.selectedId===id)fb.selectedId=null;renderTree()}
function buildNodeEl(node){const li=document.createElement('li');li.className='node'+(fb.selectedId===node.id?' selected':'');li.setAttribute('draggable','true');li.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',`folder:${node.id}`)});li.addEventListener('dragover',e=>{e.preventDefault()});li.addEventListener('drop',e=>{e.preventDefault();const data=e.dataTransfer.getData('text/plain');if(data.startsWith('file:')){const fid=data.slice(5);(function clean(nodes){for(const n of nodes){n.files=(n.files||[]).filter(id=>id!==fid);clean(n.children||[])}})(fb.tree);node.files=[...(node.files||[]),fid];renderTree();renderFilesList()}else if(data.startsWith('folder:')){const id=data.slice(7);if(id===node.id)return;const info=findNodeAndParent(fb.tree,id);if(!info)return;const {node:dragged,parent}=info;if(parent)parent.children=(parent.children||[]).filter(c=>c.id!==id);else fb.tree=fb.tree.filter(c=>c.id!==id);node.children=[...(node.children||[]),dragged];renderTree()}});
const row=document.createElement('div');row.className='node-row';row.addEventListener('click',()=>{fb.selectedId=fb.selectedId===node.id?null:node.id;renderTree()});row.innerHTML=`<div class='node-left'><div>ğŸ“</div><div><div>${node.name}</div><div class='node-meta'>${(node.files||[]).length} arquivo(s)</div></div></div>`;const del=document.createElement('button');del.className='icon-btn';del.textContent='Ã—';del.onclick=e=>{e.stopPropagation();removeNode(node.id)};row.appendChild(del);li.appendChild(row);if((node.children||[]).length){const ch=document.createElement('div');ch.className='children';const ul=document.createElement('ul');for(const c of node.children)ul.appendChild(buildNodeEl(c));ch.appendChild(ul);li.appendChild(ch)}return li}
function addFolder({asChild=false}){const name=($('folderName').value||'').trim();if(!name)return;const node={id:uid(),name:sanitizeName(name).replace(/-/g,'_'),children:[],files:[]};if(asChild&&fb.selectedId){const info=findNodeAndParent(fb.tree,fb.selectedId);if(info)info.node.children.push(node);else fb.tree.push(node)}else fb.tree.push(node);fb.selectedId=node.id;$('folderName').value='';renderTree()}
$('btnAddRoot').addEventListener('click',()=>addFolder({asChild:false}));$('btnAddChild').addEventListener('click',()=>addFolder({asChild:true}));$('btnClear').addEventListener('click',()=>{fb.tree=[];fb.selectedId=null;renderTree()});$('btnAutoFolders').addEventListener('click',()=>{fb.tree=[{id:uid(),name:'01_SVG',children:[],files:[]},{id:uid(),name:'02_PNG',children:[],files:[]},{id:uid(),name:'03_GUIAS',children:[],files:[]}];fb.selectedId=null;renderTree()});$('folderName').addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();addFolder({asChild:!!fb.selectedId})}});$('rootFolderName').addEventListener('input',renderTree);$('nameTemplate').addEventListener('input',()=>{renderFilesList();renderTree()});$('btnTemplateSimple').addEventListener('click',()=>{$('nameTemplate').value='{brand}_{color}.{ext}';renderFilesList();renderTree()});$('btnTemplateDetailed').addEventListener('click',()=>{$('nameTemplate').value='{brand}_{mark}_{type}_{color}_{bg}.{ext}';renderFilesList();renderTree()});
function renderFilesList(){const box=$('filesList');clearNode(box);$('filesBadge').textContent=String(brand.assets.length);$('filesEmptyHint').style.display=brand.assets.length?'none':'flex';for(const f of brand.assets){f.filename=buildName({ext:f.ext,mark:f.meta.mark,type:f.meta.type,color:f.meta.color,bg:f.meta.bg||''});const item=document.createElement('div');item.className='file-item';item.setAttribute('draggable','true');item.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',`file:${f.id}`));item.innerHTML=`<div class='left'><b>${f.filename}</b><div class='meta-text'>${f.meta.mark} Â· ${f.meta.type} Â· ${f.meta.color}${f.kind==='png'?' Â· '+(f.meta.bg||''):''}</div></div><div class='type-pill ${f.kind}'>${f.kind.toUpperCase()}</div>`;box.appendChild(item)}renderTree()}
$('btnExportJson').addEventListener('click',()=>{const json=JSON.stringify({rootFolder:sanitizeName($('rootFolderName').value)||'BrandPackage',template:$('nameTemplate').value,assets:brand.assets.map(a=>({filename:a.filename,kind:a.kind,meta:a.meta})),folders:toJSON()},null,2);downloadBlob(new Blob([json],{type:'application/json;charset=utf-8'}),'brand-package.json')});
async function rasterizePNG(svgText,bg){const encoded=encodeURIComponent(svgText).replace(/'/g,'%27').replace(/"/g,'%22');const img=new Image();await new Promise((res,rej)=>{img.onload=res;img.onerror=()=>rej(new Error('Falha ao rasterizar.'));img.src=`data:image/svg+xml;charset=utf-8,${encoded}`});const parsed=safeParseSVG(svgText),w=Math.ceil((Number(parsed.getAttribute('width'))||1200)*2),h=Math.ceil((Number(parsed.getAttribute('height'))||800)*2),canvas=document.createElement('canvas');canvas.width=w;canvas.height=h;const ctx=canvas.getContext('2d');if(bg==='white'){ctx.fillStyle='#fff';ctx.fillRect(0,0,w,h)}else ctx.clearRect(0,0,w,h);ctx.drawImage(img,0,0,w,h);return new Promise((res,rej)=>canvas.toBlob(b=>b?res(b):rej(new Error('Falha blob.')),'image/png'))}
$('btnExportZip').addEventListener('click',async()=>{const rootName=sanitizeName($('rootFolderName').value)||'BrandPackage';if(typeof JSZip==='undefined'){alert('JSZip nÃ£o carregou');return}if(!brand.assets.length){alert('Nenhum arquivo gerado');return}if(!fb.tree.length){fb.tree=[{id:uid(),name:'01_SVG',children:[],files:[]},{id:uid(),name:'02_PNG',children:[],files:[]},{id:uid(),name:'03_GUIAS',children:[],files:[]}];renderTree()}const zip=new JSZip(),root=zip.folder(rootName);async function writeNode(folderRef,node){const cur=folderRef.folder(node.name);for(const fid of (node.files||[])){const asset=brand.assets.find(x=>x.id===fid);if(!asset)continue;if(asset.kind==='svg')cur.file(asset.filename,asset.data||asset.svgSource);else cur.file(asset.filename,await rasterizePNG(asset.svgSource,asset.pngBg))}for(const ch of (node.children||[]))await writeNode(cur,ch)}for(const n of fb.tree)await writeNode(root,n);const blobZip=await zip.generateAsync({type:'blob'});downloadBlob(blobZip,`${rootName}.zip`)});
renderPalette();rebuildVariantSelect();renderPreviews();renderTree();renderFilesList();
window.addEventListener('message',(ev)=>{const d=ev.data||{};if(d.type==='brand-module-open-tab'){setTab(d.tab==='folders'?'folders':'brand')}});
})();
